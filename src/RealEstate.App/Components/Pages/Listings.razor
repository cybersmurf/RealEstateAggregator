@page "/listings"
@implements IDisposable
@rendermode @(new InteractiveServerRenderMode(prerender: false))

@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage

@inject HttpClient Http
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject ProtectedSessionStorage SessionStorage

<MudStack Spacing="3" Class="pa-4">

    <!-- Rychl√© filtry -->
    <MudStack Row="true" Spacing="1" Wrap="Wrap.Wrap" AlignItems="AlignItems.Center">
        <MudText Typo="Typo.body2" Class="mr-1">Rychl√© filtry:</MudText>
        @foreach (var qf in _quickFilters)
        {
            <MudChip T="string"
                     Color="@(_activeQuickFilter == qf.Key ? Color.Primary : Color.Default)"
                     Variant="@(_activeQuickFilter == qf.Key ? Variant.Filled : Variant.Outlined)"
                     Size="Size.Small"
                     OnClick="@(() => ApplyQuickFilterAsync(qf.Key))">
                @qf.Label
            </MudChip>
        }
        @if (_activeQuickFilter != null)
        {
            <MudChip T="string" Color="Color.Error" Variant="Variant.Outlined" Size="Size.Small"
                     OnClick="@(() => ApplyQuickFilterAsync(null))">
                Zru≈°it ‚úï
            </MudChip>
        }
    </MudStack>

    <!-- Filtrovac√≠ panel -->
    <MudExpansionPanels MultiExpansion="false">
        <MudExpansionPanel Text="Filtry" Expanded="true" Icon="@Icons.Material.Filled.FilterList">
            <MudGrid Spacing="2">

                <!-- Fulltext -->
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_filter.SearchText"
                                  Label="Hledat text"
                                  Variant="Variant.Outlined"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.Search"
                                  Clearable="true"
                                  OnClearButtonClick="@(() => { _filter.SearchText = null; })" />
                </MudItem>

                <!-- Typ nemovitosti -->
                <MudItem xs="6" md="3">
                    <MudSelect T="string?" @bind-Value="_filter.PropertyType"
                               Label="Typ nemovitosti"
                               Variant="Variant.Outlined"
                               Clearable="true">
                        <MudSelectItem T="string?" Value="@("House")">D≈Øm</MudSelectItem>
                        <MudSelectItem T="string?" Value="@("Apartment")">Byt</MudSelectItem>
                        <MudSelectItem T="string?" Value="@("Land")">Pozemek</MudSelectItem>
                        <MudSelectItem T="string?" Value="@("Cottage")">Chata / chalupa</MudSelectItem>
                        <MudSelectItem T="string?" Value="@("Commercial")">Komerƒçn√≠</MudSelectItem>
                        <MudSelectItem T="string?" Value="@("Industrial")">Pr≈Ømyslov√Ω</MudSelectItem>
                        <MudSelectItem T="string?" Value="@("Garage")">Gar√°≈æ</MudSelectItem>
                        <MudSelectItem T="string?" Value="@("Other")">Ostatn√≠</MudSelectItem>
                    </MudSelect>
                </MudItem>

                <!-- Typ nab√≠dky -->
                <MudItem xs="6" md="3">
                    <MudSelect T="string?" @bind-Value="_filter.OfferType"
                               Label="Nab√≠dka"
                               Variant="Variant.Outlined"
                               Clearable="true">
                        <MudSelectItem T="string?" Value="@("Sale")">Prodej</MudSelectItem>
                        <MudSelectItem T="string?" Value="@("Rent")">Pron√°jem</MudSelectItem>
                        <MudSelectItem T="string?" Value="@("Auction")">Dra≈æba</MudSelectItem>
                    </MudSelect>
                </MudItem>
                <!-- Dispozice -->
                <MudItem xs="12">
                    <MudText Typo="Typo.caption" Class="mb-1">Dispozice</MudText>
                    <MudChipSet T="string" SelectedValues="_selectedDispositiones"
                                SelectedValuesChanged="OnDispositionChangedAsync"
                                SelectionMode="SelectionMode.SingleSelection"
                                CheckMark="true">
                        @foreach (var disp in _availableDispositions)
 {
                            <MudChip T="string" Value="@disp" Size="Size.Small" Variant="Variant.Outlined">
                                @disp
                            </MudChip>
                        }
                    </MudChipSet>
                </MudItem>
                <!-- Cena od/do -->
                <MudItem xs="6" md="3">
                    <MudNumericField T="decimal?" @bind-Value="_filter.PriceMin"
                                     Label="Cena od (Kƒç)"
                                     Variant="Variant.Outlined"
                                     Format="N0"
                                     Clearable="true" />
                </MudItem>
                <MudItem xs="6" md="3">
                    <MudNumericField T="decimal?" @bind-Value="_filter.PriceMax"
                                     Label="Cena do (Kƒç)"
                                     Variant="Variant.Outlined"
                                     Format="N0"
                                     Clearable="true" />
                </MudItem>

                <!-- Plocha u≈æitkov√° -->
                <MudItem xs="6" md="3">
                    <MudNumericField T="double?" @bind-Value="_filter.AreaBuiltUpMin"
                                     Label="U≈æitn√° plocha od (m¬≤)"
                                     Variant="Variant.Outlined"
                                     Format="N0"
                                     Clearable="true" />
                </MudItem>
                <MudItem xs="6" md="3">
                    <MudNumericField T="double?" @bind-Value="_filter.AreaBuiltUpMax"
                                     Label="U≈æitn√° plocha do (m¬≤)"
                                     Variant="Variant.Outlined"
                                     Format="N0"
                                     Clearable="true" />
                </MudItem>

                <!-- Plocha pozemku -->
                <MudItem xs="6" md="3">
                    <MudNumericField T="double?" @bind-Value="_filter.AreaLandMin"
                                     Label="Pozemek od (m¬≤)"
                                     Variant="Variant.Outlined"
                                     Format="N0"
                                     Clearable="true" />
                </MudItem>
                <MudItem xs="6" md="3">
                    <MudNumericField T="double?" @bind-Value="_filter.AreaLandMax"
                                     Label="Pozemek do (m¬≤)"
                                     Variant="Variant.Outlined"
                                     Format="N0"
                                     Clearable="true" />
                </MudItem>

                <!-- Stav inzer√°tu -->
                <MudItem xs="12" sm="6" md="3">
                    <MudSelect T="string" @bind-Value="_filter.UserStatus" Label="M≈Øj stav"
                               Clearable="true" Dense="true" Variant="Variant.Outlined"
                               AdornmentIcon="@Icons.Material.Filled.Bookmarks">
                        <MudSelectItem T="string" Value="@((string?)null)">V≈°e</MudSelectItem>
                        <MudSelectItem T="string" Value="@("New")">
                            <MudChip T="string" Size="Size.Small" Color="Color.Default" Icon="@Icons.Material.Filled.FiberNew">Nov√©</MudChip>
                        </MudSelectItem>
                        <MudSelectItem T="string" Value="@("Liked")">
                            <MudChip T="string" Size="Size.Small" Color="Color.Success" Icon="@Icons.Material.Filled.Favorite">Zaj√≠mav√©</MudChip>
                        </MudSelectItem>
                        <MudSelectItem T="string" Value="@("Disliked")">
                            <MudChip T="string" Size="Size.Small" Color="Color.Error" Icon="@Icons.Material.Filled.HeartBroken">Nezaj√≠mav√©</MudChip>
                        </MudSelectItem>
                        <MudSelectItem T="string" Value="@("ToVisit")">
                            <MudChip T="string" Size="Size.Small" Color="Color.Warning" Icon="@Icons.Material.Filled.DirectionsCar">K n√°v≈°tƒõvƒõ</MudChip>
                        </MudSelectItem>
                        <MudSelectItem T="string" Value="@("Visited")">
                            <MudChip T="string" Size="Size.Small" Color="Color.Info" Icon="@Icons.Material.Filled.DoneAll">Nav≈°t√≠veno</MudChip>
                        </MudSelectItem>
                    </MudSelect>
                </MudItem>

                <!-- Zdroje -->
                <MudItem xs="12">
                    <MudText Typo="Typo.caption" Class="mb-1">Zdroje</MudText>
                    <MudChipSet T="string" @bind-SelectedValues="_selectedSourceCodes"
                                SelectionMode="SelectionMode.MultiSelection"
                                CheckMark="true">
                        @foreach (var src in _availableSources)
                        {
                            <MudChip T="string" Value="@src.Code" Size="Size.Small" Variant="Variant.Outlined">
                                @{ var logoFilter = SourceLogoUrl(src.Code); }
                                @if (logoFilter != null)
                                {
                                    <img src="@logoFilter" alt="@src.Code" style="height:16px;max-width:60px;object-fit:contain;vertical-align:middle;margin-right:4px;" />
                                }
                                else
                                {
                                    @src.Code
                                }
                            </MudChip>
                        }
                    </MudChipSet>
                </MudItem>

                <!-- Akce -->
                <MudItem xs="12">
                    <MudStack Row="true" Spacing="2">
                        <MudButton Color="Color.Primary" Variant="Variant.Filled"
                                   StartIcon="@Icons.Material.Filled.Search"
                                   OnClick="SearchAsync">
                            Hledat
                        </MudButton>
                        <MudButton Color="Color.Default" Variant="Variant.Outlined"
                                   StartIcon="@Icons.Material.Filled.Clear"
                                   OnClick="ResetFilterAsync">
                            Resetovat
                        </MudButton>
                    </MudStack>
                </MudItem>

            </MudGrid>
        </MudExpansionPanel>
    </MudExpansionPanels>

    <!-- Li≈°ta v√Ωsledk≈Ø + p≈ôep√≠naƒç pohledu -->
    <MudPaper Elevation="1" Class="pa-2 px-3">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudText Typo="Typo.h6">Inzer√°ty</MudText>
            <MudSpacer />
            @if (_totalCount > 0)
            {
                <MudChip T="string" Size="Size.Small" Color="Color.Primary" Class="mr-1">@_totalCount celkem</MudChip>
            }
            <MudTooltip Text="@(_cardView ? "Tabulkov√Ω pohled" : "Kartov√Ω pohled")">
                <MudIconButton Icon="@(_cardView ? Icons.Material.Filled.TableRows : Icons.Material.Filled.GridView)"
                               Size="Size.Small"
                               OnClick="ToggleViewAsync" />
            </MudTooltip>
        </MudStack>
    </MudPaper>

    @if (_cardView)
    {
        <!-- Kartov√Ω pohled -->
        @if (_loading)
        {
            <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
        }
        <!-- T≈ô√≠dƒõn√≠ karty ‚Äì kompaktn√≠ chipset -->
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Class="mb-2" Style="overflow-x:auto; display:flex; padding:8px 0; flex-wrap:wrap;">
            <MudText Typo="Typo.caption" Style="white-space:nowrap; flex-shrink:0; min-width:60px;">Se≈ôadit:</MudText>
            <MudChip T="string" 
                     Value="@("price")" 
                     Clickable="true" 
                     OnClick="@(() => OnCardSortChangedAsync("price"))"
                     Color="@(_filter.SortBy == "price" ? Color.Primary : Color.Default)"
                     Variant="@(_filter.SortBy == "price" ? Variant.Filled : Variant.Outlined)"
                     Size="Size.Small">Cena</MudChip>
            <MudChip T="string" 
                     Value="@("area")" 
                     Clickable="true" 
                     OnClick="@(() => OnCardSortChangedAsync("area"))"
                     Color="@(_filter.SortBy == "area" ? Color.Primary : Color.Default)"
                     Variant="@(_filter.SortBy == "area" ? Variant.Filled : Variant.Outlined)"
                     Size="Size.Small">Plocha</MudChip>
            <MudChip T="string" 
                     Value="@("land")" 
                     Clickable="true" 
                     OnClick="@(() => OnCardSortChangedAsync("land"))"
                     Color="@(_filter.SortBy == "land" ? Color.Primary : Color.Default)"
                     Variant="@(_filter.SortBy == "land" ? Variant.Filled : Variant.Outlined)"
                     Size="Size.Small">Pozemek</MudChip>
            <MudChip T="string" 
                     Value="@("date")" 
                     Clickable="true" 
                     OnClick="@(() => OnCardSortChangedAsync("date"))"
                     Color="@(_filter.SortBy == "date" ? Color.Primary : Color.Default)"
                     Variant="@(_filter.SortBy == "date" ? Variant.Filled : Variant.Outlined)"
                     Size="Size.Small">P≈ôid√°no</MudChip>
            @if (!string.IsNullOrEmpty(_filter.SortBy))
            {
                <MudTooltip Text="@(_filter.SortDescending ? "Sestupnƒõ" : "Vzestupnƒõ")">
                    <MudIconButton Icon="@(_filter.SortDescending ? Icons.Material.Filled.ArrowDownward : Icons.Material.Filled.ArrowUpward)"
                                   OnClick="ToggleCardSortDirectionAsync"
                                   Size="Size.Small" />
                </MudTooltip>
                <MudChip T="string" 
                         Clickable="true" 
                         OnClick="@(() => OnCardSortChangedAsync(null))"
                         Color="Color.Error"
                         Variant="Variant.Outlined"
                         Size="Size.Small">‚úï</MudChip>
            }
        </MudStack>
        <MudGrid Spacing="3">
            @foreach (var item in _cardItems)
            {
                <MudItem xs="12" sm="6" md="4" lg="3">
                    <MudCard @onclick="@(() => Navigation.NavigateTo($"/listings/{item.Id}"))"
                             Style="cursor:pointer; height:100%;"
                             Elevation="2">
                        @if (!string.IsNullOrWhiteSpace(item.ThumbnailUrl))
                        {
                            <MudCardMedia Image="@item.ThumbnailUrl" Height="180" />
                        }
                        else
                        {
                            <div style="height:120px; background:linear-gradient(135deg,#C17F3E18 0%,#4A6FA518 100%); display:flex; align-items:center; justify-content:center; border-radius:8px 8px 0 0;">
                                <MudIcon Icon="@Icons.Material.Filled.House" Size="Size.Large" Color="Color.Primary" Style="opacity:0.4" />
                            </div>
                        }
                        <MudCardContent Class="pa-2">
                            <MudText Typo="Typo.subtitle2"
                                     Style="overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;min-height:2.8em;">
                                @item.Title
                            </MudText>
                            @if (item.Price.HasValue)
                            {
                                <MudText Typo="Typo.h6" Color="@PriceColor(item.Price)" Class="fw-bold mt-1">
                                    @item.Price.Value.ToString("N0") Kƒç
                                </MudText>
                            }
                            else
                            {
                                <MudText Typo="Typo.body2" Color="Color.Default" Class="mt-1">Cena neuvedena</MudText>
                            }
                            @if (!string.IsNullOrWhiteSpace(item.LocationText))
                            {
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    <MudIcon Icon="@Icons.Material.Filled.LocationOn" Size="Size.Small" Style="vertical-align:text-bottom;" />
                                    @item.LocationText
                                </MudText>
                            }
                        </MudCardContent>
                        <MudCardActions Class="pa-2 pt-0">
                            @{ var cardLogo = SourceLogoUrl(item.SourceCode); }
                            @if (cardLogo != null)
                            {
                                <MudTooltip Text="@item.SourceName">
                                    <img src="@cardLogo" alt="@item.SourceName" style="height:22px;max-width:80px;object-fit:contain;opacity:0.85;" />
                                </MudTooltip>
                            }
                            else
                            {
                                <MudChip T="string" Size="Size.Small" Color="@SourceColor(item.SourceCode)" Variant="Variant.Outlined">@item.SourceName</MudChip>
                            }
                            <MudSpacer />
                            @{ var pti = PropertyTypeInfo(item.PropertyType); }
                            <MudChip T="string" Size="Size.Small" Color="@pti.Color" Variant="Variant.Text" Icon="@pti.Icon">@TranslatePropertyType(item.PropertyType)</MudChip>
                        </MudCardActions>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
        @if (_cardTotalPages > 1)
        {
            <MudStack AlignItems="AlignItems.Center" Class="mt-2">
                <MudPagination Count="@_cardTotalPages" Selected="_cardPage" SelectedChanged="CardPageChangedAsync" />
            </MudStack>
        }
    }
    else
    {
        <!-- Tabulkov√Ω pohled -->
        <MudTable T="ListingSummaryDto"
                  ServerData="@LoadServerData"
                  @ref="_table"
                  Hover="true"
                  Dense="true"
                  Loading="_loading"
                  RowsPerPage="20"
                  CurrentPage="@_tableCurrentPage"
                  Elevation="1"
                  OnRowClick="OnTableRowClicked"
                  RowClass="cursor-pointer">
            <ToolBarContent>
                <MudSpacer />
            </ToolBarContent>
            <HeaderContent>
                <MudTh>Zdroj</MudTh>
                <MudTh><MudTableSortLabel SortLabel="title" T="ListingSummaryDto">Titulek</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortLabel="location" T="ListingSummaryDto">Lokalita</MudTableSortLabel></MudTh>
                <MudTh>Typ</MudTh>
                <MudTh>Nab√≠dka</MudTh>
                <MudTh Style="text-align:right"><MudTableSortLabel SortLabel="price" T="ListingSummaryDto">Cena</MudTableSortLabel></MudTh>
                <MudTh Style="text-align:right"><MudTableSortLabel SortLabel="area" T="ListingSummaryDto">Plocha</MudTableSortLabel></MudTh>
                <MudTh Style="text-align:right"><MudTableSortLabel SortLabel="land" T="ListingSummaryDto">Pozemek</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortLabel="date" T="ListingSummaryDto">P≈ôid√°no</MudTableSortLabel></MudTh>
                <MudTh>Stav</MudTh>
                <MudTh></MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd Style="white-space:nowrap;">
                    @{ var tableLogoUrl = SourceLogoUrl(context.SourceCode); }
                    @if (tableLogoUrl != null)
                    {
                        <MudTooltip Text="@context.SourceName">
                            <img src="@tableLogoUrl" alt="@context.SourceName" style="height:20px;max-width:70px;object-fit:contain;vertical-align:middle;" />
                        </MudTooltip>
                    }
                    else
                    {
                        <MudChip T="string" Size="Size.Small" Color="@SourceColor(context.SourceCode)" Variant="Variant.Outlined">
                            @context.SourceName
                        </MudChip>
                    }
                </MudTd>
                <MudTd Style="max-width:280px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis">
                    @context.Title
                </MudTd>
                <MudTd>@context.LocationText</MudTd>
                <MudTd>
                    @{ var ptiRow = PropertyTypeInfo(context.PropertyType); }
                    <MudChip T="string" Size="Size.Small" Color="@ptiRow.Color" Variant="Variant.Text" Icon="@ptiRow.Icon">@TranslatePropertyType(context.PropertyType)</MudChip>
                </MudTd>
                <MudTd>@TranslateOfferType(context.OfferType)</MudTd>
                <MudTd Style="text-align:right">
                    @if (context.Price.HasValue)
                    {
                        <MudText Color="@PriceColor(context.Price)" Class="fw-bold">@context.Price.Value.ToString("N0") Kƒç</MudText>
                    }
                    else
                    {
                        <MudText Color="Color.Default">-</MudText>
                    }
                </MudTd>
                <MudTd Style="text-align:right">@(context.AreaBuiltUp?.ToString("N0") ?? "-") m¬≤</MudTd>
                <MudTd Style="text-align:right">@(context.AreaLand?.ToString("N0") ?? "-") m¬≤</MudTd>
                <MudTd>
                    @{ var si = StatusInfo(context.UserStatus); }
                    <MudChip T="string" Size="Size.Small" Color="@si.Color" Variant="Variant.Filled" Icon="@si.Icon">@si.Label</MudChip>
                </MudTd>
                <MudTd>
                    <MudStack Row="true" Spacing="0">
                        <MudTooltip Text="Detail">
                            <MudIconButton Icon="@Icons.Material.Filled.OpenInNew"
                                           Size="Size.Small"
                                           Color="Color.Primary"
                                           OnClick="@(() => NavigateToDetailAsync(context.Id))" />
                        </MudTooltip>
                        <MudTooltip Text="AI Anal√Ωza">
                            <MudIconButton Icon="@Icons.Material.Filled.AutoAwesome"
                                           Size="Size.Small"
                                           Color="Color.Secondary"
                                           OnClick="@(async () => await CreateAnalysisAsync(context.Id))" />
                        </MudTooltip>
                    </MudStack>
                </MudTd>
            </RowTemplate>
            <PagerContent>
                <MudTablePager PageSizeOptions="new int[] { 10, 20, 50, 100 }" />
            </PagerContent>
        </MudTable>
    }

</MudStack>

@code {
    private MudTable<ListingSummaryDto>? _table;
    private int _tableCurrentPage = 0; // 0-indexed, vizu√°ln√≠ CurrentPage binding pro MudTable
    private int _overridePage = -1;    // p≈ôi restore z SessionStorage: str√°nka pro prvn√≠ LoadServerData
    private bool _loading;
    private int _totalCount;

    // Kartov√Ω pohled
    private bool _cardView;
    private List<ListingSummaryDto> _cardItems = new();
    private int _cardPage = 1;
    private int _cardPageSize = 20;
    private int _cardTotalPages;

    private ListingFilterDto _filter = new() { Page = 1, PageSize = 20 };
    private IReadOnlyCollection<string>? _selectedSourceCodes = new List<string>();
    private List<SourceDto> _availableSources = new();
    private CancellationTokenSource _cts = new();

    // Dispozice
    private IReadOnlyCollection<string>? _selectedDispositiones = new List<string>();
    private static readonly List<string> _availableDispositions = new()
    {
        "1+1", "1+kk", 
        "2+1", "2+kk", 
        "3+1", "3+kk", 
        "4+1", "4+kk", 
        "5+1", "5+kk",
        "6+1", "6+2",
        "7+1", "7+2",
        "8+1", "8+2"
    };

    // Quick filtry
    private string? _activeQuickFilter;
    private static readonly List<(string Key, string Label, string? PropertyType, string? OfferType, string? UserStatus)> _quickFilters =
    [
        ("houses-sale",  "Domy k prodeji",  "House",     "Sale", null),
        ("apartments",   "Byty",             "Apartment", null,   null),
        ("land-sale",    "Pozemky k prodeji","Land",      "Sale", null),
        ("cottages",     "Chaty / chalupy",  "Cottage",   null,   null),
        ("rent",         "Pron√°jem",          null,        "Rent", null),
        ("liked",        "‚ù§Ô∏è Obl√≠ben√©",        null,        null,   "Liked"),
        ("to-visit",     "üöó K n√°v≈°tƒõvƒõ",      null,        null,   "ToVisit"),
    ];

    // --- Filter state persistence (obnoven√≠ po n√°vratu z detailu) ---
    private const string FilterStateKey = "listings_page_state";

    private record ListingsPageState(
        string?  SearchText,
        decimal? PriceMin,
        decimal? PriceMax,
        double?  AreaBuiltUpMin,
        double?  AreaBuiltUpMax,
        double?  AreaLandMin,
        double?  AreaLandMax,
        string?  PropertyType,
        string?  OfferType,
        string?  Disposition,
        string?  Region,
        string?  District,
        string?  Municipality,
        List<string>? SourceCodes,
        string?  ActiveQuickFilter,
        bool     CardView,
        int      CardPage,
        int      TablePage,  // 1-indexed ƒç√≠slo str√°nky tabulky
        string?  SortBy,     // Sloupec t≈ô√≠dƒõn√≠ ("Price", "Title", atd.)
        bool     SortDescending, // Sestupn√© t≈ô√≠dƒõn√≠
        string?  UserStatus  // Filtr dle m√©ho stavu ("Liked", "ToVisit", ...)
    );

    [SupplyParameterFromQuery(Name = "source")]
    public string? SourceQueryParam { get; set; }

    protected override async Task OnInitializedAsync()
    {
        // ‚ö†Ô∏è D≈ÆLE≈ΩIT√â PO≈òAD√ç: SessionStorage P≈òED Http.GetFromJsonAsync.
        //
        // Blazor Server renderuje komponent po ka≈æd√©m await. Pokud by HTTP
        // vol√°n√≠ pro zdroje probƒõhlo jako prvn√≠, MudTable by se inicializoval
        // s _tableCurrentPage=0 (SessionStorage je≈°tƒõ nep≈ôeƒçtena) ‚Üí strana 1.
        // ƒåten√≠m SessionStorage jako prvn√≠ zajist√≠me, ≈æe _tableCurrentPage je
        // spr√°vnƒõ nastaven je≈°tƒõ p≈ôed t√≠m, ne≈æ MudTable poprv√© zavol√° LoadServerData.

        ListingsPageState? restoredState = null;
        try
        {
            var saved = await SessionStorage.GetAsync<ListingsPageState>(FilterStateKey);
            if (saved.Success && saved.Value is { } s)
            {
                restoredState = s;
                _filter = new ListingFilterDto
                {
                    SearchText       = s.SearchText,
                    PriceMin         = s.PriceMin,
                    PriceMax         = s.PriceMax,
                    AreaBuiltUpMin   = s.AreaBuiltUpMin,
                    AreaBuiltUpMax   = s.AreaBuiltUpMax,
                    AreaLandMin      = s.AreaLandMin,
                    AreaLandMax      = s.AreaLandMax,
                    PropertyType     = s.PropertyType,
                    OfferType        = s.OfferType,
                    Disposition      = s.Disposition,
                    Region           = s.Region,
                    District         = s.District,
                    Municipality     = s.Municipality,
                    Page             = s.TablePage > 0 ? s.TablePage : 1,
                    PageSize         = 20,
                    SortBy           = s.SortBy,
                    SortDescending   = s.SortDescending,
                    UserStatus       = s.UserStatus,
                };
                _selectedSourceCodes  = s.SourceCodes ?? new List<string>();
                _selectedDispositiones = s.Disposition != null ? new[] { s.Disposition } : new List<string>();
                _activeQuickFilter    = s.ActiveQuickFilter;
                _cardView             = s.CardView;
                _cardPage             = s.CardPage;
                // _overridePage: LoadServerData ho p≈ôeƒçte na prvn√≠m vol√°n√≠ m√≠sto state.Page=0
                // (MudTable v ServerData m√≥du v≈ædy zaƒç√≠n√° s state.Page=0, CurrentPage je jen vizu√°ln√≠)
                _overridePage         = s.TablePage > 0 ? s.TablePage : 1;
                _tableCurrentPage     = Math.Max(0, s.TablePage - 1); // vizu√°ln√≠ paginator

                await SessionStorage.DeleteAsync(FilterStateKey);
            }
        }
        catch
        {
            // SessionStorage nemus√≠ b√Ωt dostupn√° (prerendering, standalone WASM apod.)
        }

        // Teprve teƒè naƒç√≠st zdroje ‚Äì _tableCurrentPage je ji≈æ spr√°vnƒõ nastaven,
        // tak≈æe MudTable se inicializuje se spr√°vnou str√°nkou.
        try
        {
            var sources = await Http.GetFromJsonAsync<List<SourceDto>>("api/sources");
            _availableSources = sources ?? new List<SourceDto>();

            // P≈ôedvybrat zdroj z query parametru (?source=REMAX) ‚Äì p≈ôep√≠≈°e restore
            if (!string.IsNullOrEmpty(SourceQueryParam) &&
                _availableSources.Any(s => s.Code.Equals(SourceQueryParam, StringComparison.OrdinalIgnoreCase)))
            {
                _selectedSourceCodes = new List<string> { SourceQueryParam.ToUpperInvariant() };
                return;
            }

            // Pro kartov√Ω pohled naƒçteme data (MudTable se naƒç√≠t√° s√°m p≈ôes ServerData)
            if (restoredState?.CardView == true)
                await LoadCardsAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Nepoda≈ôilo se naƒç√≠st zdroje: {ex.Message}", Severity.Warning);
        }
    }

    /// <summary>Ulo≈æ√≠ aktu√°ln√≠ stav str√°nky do SessionStorage p≈ôed navigac√≠ na detail.</summary>
    private async Task SaveStateAsync()
    {
        try
        {
            var state = new ListingsPageState(
                SearchText:        _filter.SearchText,
                PriceMin:          _filter.PriceMin,
                PriceMax:          _filter.PriceMax,
                AreaBuiltUpMin:    _filter.AreaBuiltUpMin,
                AreaBuiltUpMax:    _filter.AreaBuiltUpMax,
                AreaLandMin:       _filter.AreaLandMin,
                AreaLandMax:       _filter.AreaLandMax,
                PropertyType:      _filter.PropertyType,
                OfferType:         _filter.OfferType,
                Disposition:       _filter.Disposition,
                Region:            _filter.Region,
                District:          _filter.District,
                Municipality:      _filter.Municipality,
                SourceCodes:       _selectedSourceCodes?.ToList(),
                ActiveQuickFilter: _activeQuickFilter,
                CardView:          _cardView,
                CardPage:          _cardPage,
                TablePage:         _filter.Page,  // 1-indexed aktu√°ln√≠ str√°nka tabulky
                SortBy:            _filter.SortBy,
                SortDescending:    _filter.SortDescending,
                UserStatus:        _filter.UserStatus
            );
            await SessionStorage.SetAsync(FilterStateKey, state);
        }
        catch
        {
            // Ignoruj ‚Äì ulo≈æen√≠ stavu nen√≠ kritick√©
        }
    }

    private async Task<TableData<ListingSummaryDto>> LoadServerData(TableState state, CancellationToken ct)
    {
        _loading = true;
        try
        {
            // Pokud m√°me override str√°nku z SessionStorage (n√°vrat z detailu), pou≈æijeme ji
            // pr√°vƒõ jednou ‚Äì MudTable toti≈æ v≈ædy vol√° prvn√≠ LoadServerData s state.Page=0.
            if (_overridePage > 0)
            {
                _filter.Page = _overridePage;
                _overridePage = -1;
            }
            else
            {
                _filter.Page = Math.Max(1, state.Page + 1);
            }
            _filter.PageSize = state.PageSize;
            _filter.SourceCodes = (_selectedSourceCodes?.Count ?? 0) > 0
                ? _selectedSourceCodes!.ToList()
                : null;
            _filter.Disposition = (_selectedDispositiones?.Count ?? 0) > 0
                ? _selectedDispositiones!.First()
                : null;
            
            // T≈ô√≠dƒõn√≠: v≈ædy aktualizuj z UI state (jinak se smƒõr nikdy nep≈ôepne).
            // SessionStorage restore: _filter.SortBy je nastaven, ale state.SortLabel je pr√°zdn√Ω
            // (MudTable prvn√≠ vol√°n√≠ m√° SortLabel="") ‚Üí podm√≠nka ochr√°n√≠ ulo≈æen√Ω sort.
            if (!string.IsNullOrEmpty(state.SortLabel))
            {
                _filter.SortBy = state.SortLabel;
                _filter.SortDescending = state.SortDirection == MudBlazor.SortDirection.Descending;
            }

            var response = await Http.PostAsJsonAsync("api/listings/search", _filter, ct);
            response.EnsureSuccessStatusCode();

            var result = await response.Content.ReadFromJsonAsync<PagedResultDto<ListingSummaryDto>>(ct);
            _totalCount = result?.TotalCount ?? 0;
            return new TableData<ListingSummaryDto>
            {
                Items = result?.Items ?? Array.Empty<ListingSummaryDto>(),
                TotalItems = _totalCount
            };
        }
        catch (OperationCanceledException)
        {
            // Norm√°ln√≠ p≈ôedƒçasn√© ukonƒçen√≠ (NavigateTo / zmƒõna filtru) ‚Äì nezobrazovat chybu
            return new TableData<ListingSummaryDto> { Items = Array.Empty<ListingSummaryDto>(), TotalItems = _totalCount };
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Chyba naƒç√≠t√°n√≠: {ex.Message}", Severity.Error);
            return new TableData<ListingSummaryDto> { Items = Array.Empty<ListingSummaryDto>(), TotalItems = 0 };
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task LoadCardsAsync()
    {
        var ct = _cts.Token;
        _loading = true;
        try
        {
            var cardFilter = new ListingFilterDto
            {
                Page = _cardPage,
                PageSize = _cardPageSize,
                SearchText = _filter.SearchText,
                PropertyType = _filter.PropertyType,
                OfferType = _filter.OfferType,
                Disposition = (_selectedDispositiones?.Count ?? 0) > 0 ? _selectedDispositiones!.First() : null,
                PriceMin = _filter.PriceMin,
                PriceMax = _filter.PriceMax,
                AreaBuiltUpMin = _filter.AreaBuiltUpMin,
                AreaBuiltUpMax = _filter.AreaBuiltUpMax,
                AreaLandMin = _filter.AreaLandMin,
                AreaLandMax = _filter.AreaLandMax,
                Region = _filter.Region,
                District = _filter.District,
                Municipality = _filter.Municipality,
                SourceCodes = (_selectedSourceCodes?.Count ?? 0) > 0 ? _selectedSourceCodes!.ToList() : null,
                SortBy = _filter.SortBy,
                SortDescending = _filter.SortDescending,
            };
            var response = await Http.PostAsJsonAsync("api/listings/search", cardFilter, ct);
            ct.ThrowIfCancellationRequested();
            response.EnsureSuccessStatusCode();
            var result = await response.Content.ReadFromJsonAsync<PagedResultDto<ListingSummaryDto>>(cancellationToken: ct);
            _totalCount = result?.TotalCount ?? 0;
            _cardItems = result?.Items?.ToList() ?? new();
            _cardTotalPages = (int)Math.Ceiling((double)_totalCount / _cardPageSize);
        }
        catch (OperationCanceledException)
        {
            // Komponenta byla zru≈°ena nebo p≈ôepnuta ‚Äì ignorujeme
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Chyba naƒç√≠t√°n√≠: {ex.Message}", Severity.Error);
            _cardItems = new();
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private async Task ToggleViewAsync()
    {
        _cardView = !_cardView;
        if (_cardView)
        {
            _cardPage = 1;
            await LoadCardsAsync();
        }
    }

    private async Task CardPageChangedAsync(int page)
    {
        _cardPage = page;
        await LoadCardsAsync();
    }

    private async Task OnCardSortChangedAsync(string? sortBy)
    {
        _filter.SortBy = sortBy;
        if (string.IsNullOrEmpty(sortBy))
        {
            _filter.SortDescending = false; // Reset smƒõru p≈ôi zru≈°en√≠ t≈ô√≠dƒõn√≠
        }
        _cardPage = 1;
        await LoadCardsAsync();
    }

    private async Task ToggleCardSortDirectionAsync()
    {
        _filter.SortDescending = !_filter.SortDescending;
        _cardPage = 1;
        await LoadCardsAsync();
    }

    private async Task ApplyQuickFilterAsync(string? key)
    {
        _activeQuickFilter = key;
        var qf = key != null ? _quickFilters.FirstOrDefault(q => q.Key == key) : default;
        _filter.PropertyType = qf.PropertyType;
        _filter.OfferType    = qf.OfferType;
        _filter.UserStatus   = qf.UserStatus;

        if (_cardView)
        {
            _cardPage = 1;
            await LoadCardsAsync();
        }
        else
        {
            if (_table != null)
                await _table.ReloadServerData();
        }
    }

    private async Task SearchAsync()
    {
        _activeQuickFilter = null;
        if (_cardView)
        {
            _cardPage = 1;
            await LoadCardsAsync();
        }
        else if (_table != null)
            await _table.ReloadServerData();
    }

    private async Task ResetFilterAsync()
    {
        _filter = new ListingFilterDto { Page = 1, PageSize = 20 };
        _selectedSourceCodes = new List<string>(); // reset na pr√°zdnou kolekci (ne null)
        _selectedDispositiones = new List<string>(); // reset na pr√°zdnou kolekci
        _activeQuickFilter = null;

        if (_cardView)
        {
            _cardPage = 1;
            await LoadCardsAsync();
        }
        else if (_table is not null)
            await _table.ReloadServerData();
    }

    private async Task OnDispositionChangedAsync(IReadOnlyCollection<string> values)
    {
        _selectedDispositiones = values;
        // Automaticky refresh tabulky
        if (!_cardView && _table is not null)
            await _table.ReloadServerData();
        else if (_cardView)
        {
            _cardPage = 1;
            await LoadCardsAsync();
        }
    }

    private async Task OnTableRowClicked(TableRowClickEventArgs<ListingSummaryDto> args)
    {
        if (args.Item is not null)
        {
            await SaveStateAsync();
            Navigation.NavigateTo($"/listings/{args.Item.Id}");
        }
    }

    private async Task NavigateToDetailAsync(Guid id)
    {
        await SaveStateAsync();
        Navigation.NavigateTo($"/listings/{id}");
    }

    private async Task CreateAnalysisAsync(Guid id)
    {
        try
        {
            var request = new AnalysisJobCreateDto { StorageProvider = "Local" };
            var response = await Http.PostAsJsonAsync($"api/analysis/listing/{id}", request);
            if (!response.IsSuccessStatusCode)
            {
                Snackbar.Add("Chyba p≈ôi vytv√°≈ôen√≠ anal√Ωzy", Severity.Error);
                return;
            }
            Snackbar.Add("Anal√Ωza byla √∫spƒõ≈°nƒõ vytvo≈ôena", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Chyba: {ex.Message}", Severity.Error);
        }
    }

    private static string TranslatePropertyType(string? t) => t switch
    {
        "House"      => "D≈Øm",
        "Apartment"  => "Byt",
        "Land"       => "Pozemek",
        "Cottage"    => "Chata",
        "Commercial" => "Komerƒçn√≠",
        "Industrial" => "Pr≈Ømyslov√Ω",
        "Garage"     => "Gar√°≈æ",
        _            => t ?? "-"
    };

    private static string TranslateOfferType(string? t) => t switch
    {
        "Sale"    => "Prodej",
        "Rent"    => "Pron√°jem",
        "Auction" => "Dra≈æba",
        _         => t ?? "-"
    };

    private static (Color Color, string Icon, string Label) StatusInfo(string? s) => s switch
    {
        "New"      => (Color.Default,  Icons.Material.Filled.FiberNew,      "Nov√Ω"),
        "Liked"    => (Color.Success,  Icons.Material.Filled.Favorite,      "L√≠b√≠ se"),
        "Disliked" => (Color.Error,    Icons.Material.Filled.HeartBroken,   "Nel√≠b√≠"),
        "ToVisit"  => (Color.Warning,  Icons.Material.Filled.CalendarMonth, "Ke shl√©dnut√≠"),
        "Visited"  => (Color.Info,     Icons.Material.Filled.DoneAll,       "Shl√©dnuto"),
        "Ignored"  => (Color.Default,  Icons.Material.Filled.VisibilityOff, "Ignorov√°no"),
        _          => (Color.Default,  Icons.Material.Filled.Circle,        s ?? "Nov√Ω")
    };

    private static Color SourceColor(string? code) => code?.ToUpper() switch
    {
        var s when s?.Contains("SREALITY")  == true => Color.Primary,
        var s when s?.Contains("REMAX")     == true => Color.Error,
        var s when s?.Contains("CENTURY")   == true => Color.Warning,
        var s when s?.Contains("IDNES")     == true => Color.Info,
        var s when s?.Contains("HVREALITY") == true => Color.Secondary,
        var s when s?.Contains("PREMIAREAL")== true => Color.Tertiary,
        _ => Color.Default
    };

    private static Color PriceColor(decimal? price) => price switch
    {
        null        => Color.Default,
        < 1_000_000 => Color.Success,
        < 5_000_000 => Color.Warning,
        _           => Color.Error
    };

    private static (Color Color, string Icon) PropertyTypeInfo(string? t) => t switch
    {
        "House"      => (Color.Warning,   Icons.Material.Filled.House),
        "Apartment"  => (Color.Primary,   Icons.Material.Filled.Apartment),
        "Land"       => (Color.Success,   Icons.Material.Filled.Landscape),
        "Cottage"    => (Color.Tertiary,  Icons.Material.Filled.Cabin),
        "Commercial" => (Color.Secondary, Icons.Material.Filled.Store),
        "Industrial" => (Color.Error,     Icons.Material.Filled.Factory),
        "Garage"     => (Color.Dark,      Icons.Material.Filled.Garage),
        _            => (Color.Default,   Icons.Material.Filled.Home)
    };

    private static readonly Dictionary<string, string> _sourceLogoMap = new(StringComparer.OrdinalIgnoreCase)
    {
        { "REMAX",        "/images/logos/REMAX.svg" },
        { "MMR",          "/images/logos/MMR.svg" },
        { "PRODEJMETO",   "/images/logos/PRODEJMETO.svg" },
        { "LEXAMO",       "/images/logos/LEXAMO.svg" },
        { "PREMIAREALITY","/images/logos/PREMIAREALITY.svg" },
        { "CENTURY21",    "/images/logos/CENTURY21.svg" },
        { "SREALITY",     "/images/logos/SREALITY.png" },
        { "IDNES",        "/images/logos/IDNES.svg" },
        { "DELUXREALITY", "/images/logos/DELUXREALITY.png" },
        { "HVREALITY",    "/images/logos/HVREALITY.png" },
        { "ZNOJMOREALITY","/images/logos/ZNOJMOREALITY.png" },
        { "NEMZNOJMO",    "/images/logos/NEMZNOJMO.png" },
        { "REAS",         "/images/logos/REAS.svg" },
    };

    private static string? SourceLogoUrl(string? code)
        => code != null && _sourceLogoMap.TryGetValue(code, out var url) ? url : null;

    public void Dispose()
    {
        _cts.Cancel();
        _cts.Dispose();
    }
}


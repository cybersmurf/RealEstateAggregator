@page "/map"
@using System.Net.Http.Json
@using RealEstate.App.Models
@inject HttpClient Http
@inject IJSRuntime JS
@inject ISnackbar Snackbar
@implements IAsyncDisposable

<PageTitle>Mapa inzer√°t≈Ø ‚Äì Real Estate Aggregator</PageTitle>

<MudText Typo="Typo.h5" Class="mb-4">
    <MudIcon Icon="@Icons.Material.Filled.Map" Class="mr-2" />
    Mapa inzer√°t≈Ø
</MudText>

<!-- Horn√≠ toolbar: filtry + koridor -->
<MudPaper Class="pa-3 mb-3" Elevation="1">
    <MudGrid Spacing="2" AlignItems="Center">

        <!-- Filtry -->
        <MudItem xs="12" sm="6" md="3">
            <MudSelect T="string" @bind-Value="_selectedPropertyType" Label="Typ nemovitosti"
                       Clearable="true" Dense="true" Variant="Variant.Outlined">
                <MudSelectItem T="string" Value="@null">V≈°e</MudSelectItem>
                <MudSelectItem T="string" Value="@("House")">D≈Øm</MudSelectItem>
                <MudSelectItem T="string" Value="@("Apartment")">Byt</MudSelectItem>
                <MudSelectItem T="string" Value="@("Land")">Pozemek</MudSelectItem>
                <MudSelectItem T="string" Value="@("Cottage")">Chata</MudSelectItem>
                <MudSelectItem T="string" Value="@("Commercial")">Komerƒçn√≠</MudSelectItem>
            </MudSelect>
        </MudItem>

        <MudItem xs="12" sm="6" md="2">
            <MudSelect T="string" @bind-Value="_selectedOfferType" Label="Nab√≠dka"
                       Clearable="true" Dense="true" Variant="Variant.Outlined">
                <MudSelectItem T="string" Value="@null">V≈°e</MudSelectItem>
                <MudSelectItem T="string" Value="@("Sale")">Prodej</MudSelectItem>
                <MudSelectItem T="string" Value="@("Rent")">Pron√°jem</MudSelectItem>
                <MudSelectItem T="string" Value="@("Auction")">Dra≈æba</MudSelectItem>
            </MudSelect>
        </MudItem>

        <MudItem xs="12" sm="6" md="2">
            <MudNumericField T="decimal?" @bind-Value="_priceMax" Label="Max. cena (Kƒç)"
                             Format="N0" HideSpinButtons="true" Dense="true" Variant="Variant.Outlined" />
        </MudItem>

        <MudItem xs="12" sm="6" md="2">
            <MudButton Variant="Variant.Filled" Color="Color.Primary"
                       OnClick="LoadMapPointsAsync" StartIcon="@Icons.Material.Filled.Refresh"
                       Disabled="_isLoading" FullWidth="true">
                @(_isLoading ? "Naƒç√≠t√°m..." : "Zobrazit")
            </MudButton>
        </MudItem>

        <MudItem xs="12" sm="12" md="3">
            <MudText Typo="Typo.caption" Color="Color.Secondary">
                @(_mapPoints?.Count > 0 ? $"{_mapPoints.Count} inzer√°t≈Ø s GPS" : "Bez bod≈Ø na mapƒõ")
            </MudText>
        </MudItem>

    </MudGrid>
</MudPaper>

<!-- Sekce koridoru -->
<MudExpansionPanels Class="mb-3">
    <MudExpansionPanel Text="üó∫Ô∏è Vyhled√°v√°n√≠ v koridoru (buffer kolem trasy)" IsInitiallyExpanded="@_corridorExpanded">
        <MudGrid Spacing="2" AlignItems="Center">
            <MudItem xs="12" sm="5">
                <MudTextField @bind-Value="_corridorStart" Label="Poƒç√°teƒçn√≠ bod"
                              Placeholder="nap≈ô. ≈†t√≠tary nebo 48.9,15.9"
                              Variant="Variant.Outlined" Dense="true"
                              AdornmentIcon="@Icons.Material.Filled.TripOrigin" Adornment="Adornment.Start" />
            </MudItem>
            <MudItem xs="12" sm="5">
                <MudTextField @bind-Value="_corridorEnd" Label="C√≠lov√Ω bod"
                              Placeholder="nap≈ô. Poho≈ôelice nebo 48.98,16.52"
                              Variant="Variant.Outlined" Dense="true"
                              AdornmentIcon="@Icons.Material.Filled.Place" Adornment="Adornment.Start" />
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudNumericField T="int" @bind-Value="_corridorBufferM" Label="Buffer (m)"
                                 Min="500" Max="50000" Step="500" Dense="true" Variant="Variant.Outlined" />
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudCheckBox @bind-Value="_corridorUseRoute" Label="Pou≈æ√≠t re√°lnou silniƒçn√≠ trasu (OSRM)" Dense="true" />
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudTextField @bind-Value="_corridorSaveName" Label="Ulo≈æit oblast jako (voliteln√©)"
                              Placeholder="Neukl√°dat" Variant="Variant.Outlined" Dense="true" />
            </MudItem>
            <MudItem xs="12" sm="3">
                <MudButton Variant="Variant.Filled" Color="Color.Secondary"
                           OnClick="BuildCorridorAsync" Disabled="_isCorridorLoading" FullWidth="true"
                           StartIcon="@Icons.Material.Filled.Directions">
                    @(_isCorridorLoading ? "Poƒç√≠t√°m..." : "Hledat v koridoru")
                </MudButton>
            </MudItem>
            <MudItem xs="12" sm="3">
                <MudButton Variant="Variant.Text" Color="Color.Default"
                           OnClick="ClearCorridorAsync" Disabled="_corridorWkt == null" FullWidth="true"
                           StartIcon="@Icons.Material.Filled.Clear">
                    Vymazat koridor
                </MudButton>
            </MudItem>
            @if (_corridorResult != null)
            {
                <MudItem xs="12">
                    <MudAlert Severity="Severity.Info" Dense="true">
                        Koridor: <b>@_corridorStart ‚Üí @_corridorEnd</b> ¬∑ buffer @((_corridorResult.BufferMeters / 1000.0).ToString("F1")) km ¬∑
                        <b>@_corridorResult.ListingCount inzer√°t≈Ø</b> uvnit≈ô koridoru
                        @if (_corridorResult.SavedAreaId.HasValue)
                        {
                            <span> ¬∑ Oblast ulo≈æena ‚úì</span>
                        }
                    </MudAlert>
                </MudItem>
            }
        </MudGrid>
    </MudExpansionPanel>
</MudExpansionPanels>

<!-- Mapa -->
<MudPaper Elevation="2" Style="position:relative">
    @if (_isLoading || _isCorridorLoading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
    }
    <div id="@_mapId" style="height: 620px; width: 100%; border-radius: 4px;"></div>
</MudPaper>

<!-- Statistiky koordin√°t≈Ø + geocoding -->
@if (_geocodeStats != null)
{
    <MudPaper Class="pa-3 mt-2" Elevation="1">
        <MudGrid Spacing="1" AlignItems="Center">
            <MudItem xs="12" sm="8">
                <MudText Typo="Typo.body2">
                    <MudIcon Icon="@Icons.Material.Filled.GpsFixed" Size="Size.Small" Class="mr-1" />
                    GPS pokryt√≠:
                    <strong>@_geocodeStats.WithCoords / @_geocodeStats.Total inzer√°t≈Ø</strong>
                    (@((_geocodeStats.Total > 0 ? (double)_geocodeStats.WithCoords / _geocodeStats.Total * 100 : 0.0).ToString("F0")) %)
                    @if (_geocodeStats.ActiveWithoutCoords > 0)
                    {
                        <MudChip T="string" Color="Color.Warning" Size="Size.Small" Class="ml-2">
                            @_geocodeStats.ActiveWithoutCoords bez GPS
                        </MudChip>
                    }
                    else
                    {
                        <MudChip T="string" Color="Color.Success" Size="Size.Small" Class="ml-2">V≈°e geok√≥dov√°no ‚úì</MudChip>
                    }
                </MudText>
                @if (_lastGeocodeResult != null)
                {
                    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-1">
                        Posledn√≠ batch: @_lastGeocodeResult.Succeeded p≈ôid√°no, @_lastGeocodeResult.Failed selhalo,
                        zb√Ωv√° @_lastGeocodeResult.RemainingWithoutGps ¬∑ ~@(_lastGeocodeResult.AvgMsPerRequest) ms/req
                    </MudText>
                }
            </MudItem>
            @if (_geocodeStats.ActiveWithoutCoords > 0)
            {
                <MudItem xs="12" sm="4" Class="d-flex justify-end">
                    <MudButton Variant="Variant.Outlined" Color="Color.Warning"
                               OnClick="RunGeocodingBatchAsync"
                               Disabled="_isGeocoding"
                               StartIcon="@Icons.Material.Filled.LocationSearching"
                               Size="Size.Small">
                        @(_isGeocoding ? "Geocoduji 20 inzer√°t≈Ø..." : $"Geocodovat dal≈°√≠ch 20")
                    </MudButton>
                </MudItem>
            }
        </MudGrid>
    </MudPaper>
}

@code {
    private const string _mapId = "realestateMap";
    private DotNetObjectReference<Map>? _dotNetRef;

    // Map data
    private List<ListingMapPointApiDto>? _mapPoints;
    private bool _isLoading;

    // Filtry
    private string? _selectedPropertyType;
    private string? _selectedOfferType;
    private decimal? _priceMax;

    // Koridor
    private string _corridorStart = "";
    private string _corridorEnd = "";
    private int _corridorBufferM = 5000;
    private bool _corridorUseRoute = true;
    private string? _corridorSaveName;
    private bool _corridorExpanded = false;
    private bool _isCorridorLoading;
    private CorridorResultApiDto? _corridorResult;
    private string? _corridorWkt;

    // Statistiky geocodingu
    private GeocodeStatsDto? _geocodeStats;
    private bool _isGeocoding;
    private BulkGeocodeResultApiDto? _lastGeocodeResult;

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _dotNetRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("leafletMap.init", _mapId, 49.0, 16.6, 8);
            await LoadMapPointsAsync();
            await LoadGeocodeStatsAsync();
        }
    }

    private async Task LoadMapPointsAsync()
    {
        _isLoading = true;
        StateHasChanged();

        try
        {
            var url = BuildMapPointsUrl();
            _mapPoints = await Http.GetFromJsonAsync<List<ListingMapPointApiDto>>(url);

            if (_mapPoints != null)
            {
                await JS.InvokeVoidAsync("leafletMap.setMarkers", _mapId, _mapPoints, _dotNetRef);

                if (string.IsNullOrEmpty(_corridorWkt))
                    await JS.InvokeVoidAsync("leafletMap.fitMarkers", _mapId);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Chyba p≈ôi naƒç√≠t√°n√≠ bod≈Ø: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task BuildCorridorAsync()
    {
        if (string.IsNullOrWhiteSpace(_corridorStart) || string.IsNullOrWhiteSpace(_corridorEnd))
        {
            Snackbar.Add("Zadejte poƒç√°teƒçn√≠ i c√≠lov√Ω bod koridoru.", Severity.Warning);
            return;
        }

        _isCorridorLoading = true;
        StateHasChanged();

        try
        {
            var request = new
            {
                start = _corridorStart,
                end = _corridorEnd,
                bufferMeters = _corridorBufferM,
                useRoute = _corridorUseRoute,
                saveAsName = string.IsNullOrWhiteSpace(_corridorSaveName) ? null : _corridorSaveName
            };

            var response = await Http.PostAsJsonAsync("api/spatial/corridor", request);
            if (!response.IsSuccessStatusCode)
            {
                var err = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Chyba koridoru: {err}", Severity.Error);
                return;
            }

            _corridorResult = await response.Content.ReadFromJsonAsync<CorridorResultApiDto>();
            _corridorWkt = _corridorResult?.PolygonWkt;

            if (!string.IsNullOrEmpty(_corridorWkt))
            {
                // Nakresli koridor + vyhledej inzer√°ty uvnit≈ô
                await JS.InvokeVoidAsync("leafletMap.drawCorridor", _mapId, _corridorWkt);
                await SearchInCorridorAsync(_corridorWkt);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Chyba: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isCorridorLoading = false;
            StateHasChanged();
        }
    }

    private async Task SearchInCorridorAsync(string wkt)
    {
        try
        {
            var request = new
            {
                polygonWkt = wkt,
                propertyType = _selectedPropertyType,
                offerType = _selectedOfferType,
                priceMax = _priceMax,
                page = 1,
                pageSize = 500
            };

            var response = await Http.PostAsJsonAsync("api/spatial/search", request);
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<List<ListingMapPointApiDto>>();
                if (result != null)
                {
                    _mapPoints = result;
                    await JS.InvokeVoidAsync("leafletMap.setMarkers", _mapId, _mapPoints, _dotNetRef);
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Chyba p≈ôi hled√°n√≠ v koridoru: {ex.Message}", Severity.Warning);
        }
    }

    private async Task ClearCorridorAsync()
    {
        _corridorResult = null;
        _corridorWkt = null;
        await JS.InvokeVoidAsync("leafletMap.clearCorridor", _mapId);
        await LoadMapPointsAsync();
    }

    private async Task LoadGeocodeStatsAsync()
    {
        try
        {
            _geocodeStats = await Http.GetFromJsonAsync<GeocodeStatsDto>("api/spatial/geocode-stats");
        }
        catch { /* neblokuj√≠c√≠ */ }
        StateHasChanged();
    }

    private async Task RunGeocodingBatchAsync()
    {
        _isGeocoding = true;
        StateHasChanged();
        try
        {
            var response = await Http.PostAsync("api/spatial/bulk-geocode?batchSize=20", null);
            if (response.IsSuccessStatusCode)
            {
                _lastGeocodeResult = await response.Content.ReadFromJsonAsync<BulkGeocodeResultApiDto>();
                Snackbar.Add($"Geocodov√°no: {_lastGeocodeResult?.Succeeded} ‚úì, zb√Ωv√° {_lastGeocodeResult?.RemainingWithoutGps}", Severity.Success);
                await LoadGeocodeStatsAsync();
                // Obnov markery na mapƒõ
                if (_corridorWkt != null)
                    await SearchInCorridorAsync(_corridorWkt);
                else
                    await LoadMapPointsAsync();
            }
            else
            {
                Snackbar.Add("Geocoding selhal ‚Äì zkuste znovu", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Geocoding chyba: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isGeocoding = false;
            StateHasChanged();
        }
    }

    private string BuildMapPointsUrl()
    {
        var parts = new List<string>();
        if (!string.IsNullOrEmpty(_selectedPropertyType)) parts.Add($"propertyType={Uri.EscapeDataString(_selectedPropertyType)}");
        if (!string.IsNullOrEmpty(_selectedOfferType)) parts.Add($"offerType={Uri.EscapeDataString(_selectedOfferType)}");
        if (_priceMax.HasValue) parts.Add($"priceMax={_priceMax.Value}");
        var qs = parts.Count > 0 ? "?" + string.Join("&", parts) : "";
        return $"api/spatial/map-points{qs}";
    }

    [JSInvokable]
    public void OnMarkerClicked(Guid listingId)
    {
        // Callback z Leaflet ‚Äì zat√≠m jen log, roz≈°i≈ôiteln√© na panel
        _ = listingId;
    }

    public async ValueTask DisposeAsync()
    {
        try { await JS.InvokeVoidAsync("leafletMap.destroy", _mapId); } catch { }
        _dotNetRef?.Dispose();
    }

    // ‚îÄ‚îÄ‚îÄ DTO records (pouze pro Map.razor ‚Äì nemapujeme p≈ôes glob√°ln√≠ Models) ‚îÄ‚îÄ

    private sealed record ListingMapPointApiDto(
        Guid Id, string Title, decimal? Price, string LocationText,
        double Latitude, double Longitude,
        string PropertyType, string OfferType,
        string SourceCode, string? MainPhotoUrl);

    private sealed record CorridorResultApiDto(
        string PolygonWkt,
        double StartLat, double StartLon,
        double EndLat, double EndLon,
        int BufferMeters,
        int ListingCount,
        Guid? SavedAreaId);

    private sealed record GeocodeStatsDto(
        int Total, int WithCoords, int ActiveWithoutCoords,
        int FromScraper, int FromNominatim);

    private sealed record BulkGeocodeResultApiDto(
        int Processed, int Succeeded, int Failed,
        int RemainingWithoutGps, int AvgMsPerRequest);
}

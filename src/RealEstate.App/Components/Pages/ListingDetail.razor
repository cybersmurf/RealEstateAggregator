@page "/listings/{id:guid}"
@implements IDisposable

@inject HttpClient Http
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    @if (_loading)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
        <MudText Typo="Typo.body1">Naƒç√≠t√°m...</MudText>
    }
    else if (_listing == null)
    {
        <MudAlert Severity="Severity.Error">Inzer√°t nenalezen.</MudAlert>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="@(() => Navigation.NavigateTo("/listings"))">
            Zpƒõt na seznam
        </MudButton>
    }
    else
    {
        <MudStack Spacing="3">
            <!-- Header -->
            <MudPaper Class="pa-4">
                <MudStack Spacing="2">
                    <MudText Typo="Typo.h4">@_listing.Title</MudText>
                    <MudStack Row="true" Spacing="2">
                        <MudChip T="string" Size="Size.Small" Color="Color.Primary">@_listing.SourceName</MudChip>
                        <MudChip T="string" Size="Size.Small" Color="Color.Secondary">@GetPropertyTypeLabel(_listing.PropertyType)</MudChip>
                        <MudChip T="string" Size="Size.Small" Color="Color.Info">@GetOfferTypeLabel(_listing.OfferType)</MudChip>
                    </MudStack>
                    <MudText Typo="Typo.h5" Color="Color.Success">
                        @(_listing.Price?.ToString("N0") ?? "Cena nen√≠ uvedena") Kƒç
                        @if (!string.IsNullOrWhiteSpace(_listing.PriceNote))
                        {
                            <MudText Typo="Typo.caption">(@_listing.PriceNote)</MudText>
                        }
                    </MudText>
                </MudStack>
            </MudPaper>

            <!-- Photo Carousel -->
            @if (_listing.Photos.Any())
            {
                <MudPaper Class="pa-4">
                    <MudCarousel TData="object" Style="height:400px;" ShowArrows="true" ShowBullets="true" EnableSwipeGesture="true" AutoCycle="false">
                        @foreach (var photo in _listing.Photos.OrderBy(p => p.Order))
                        {
                            var photoSrc = !string.IsNullOrEmpty(photo.StoredUrl) ? photo.StoredUrl : photo.OriginalUrl;
                            <MudCarouselItem>
                                <div class="d-flex justify-center align-center" style="height:100%">
                                    <img src="@photoSrc" alt="Foto"
                                         style="max-width:100%; max-height:100%; object-fit:contain;"
                                         onerror="this.style.display='none';this.nextElementSibling.style.display='flex'" />
                                    <div style="display:none; width:100%; height:100%; align-items:center; justify-content:center; color:#9e9e9e;">
                                        <span>üì∑ Foto nen√≠ k dispozici</span>
                                    </div>
                                </div>
                            </MudCarouselItem>
                        }
                    </MudCarousel>
                </MudPaper>
            }
            else
            {
                <MudAlert Severity="Severity.Info">≈Ω√°dn√© fotografie nejsou k dispozici.</MudAlert>
            }

            <!-- Details -->
            <MudPaper Class="pa-4">
                <MudText Typo="Typo.h6" Class="mb-3">Detaily</MudText>
                <MudSimpleTable Striped="true" Dense="true">
                    <tbody>
                        <tr>
                            <td><strong>Lokalita</strong></td>
                            <td>@_listing.LocationText</td>
                        </tr>
                        @if (!string.IsNullOrWhiteSpace(_listing.Municipality))
                        {
                            <tr>
                                <td><strong>Obec</strong></td>
                                <td>@_listing.Municipality</td>
                            </tr>
                        }
                        @if (!string.IsNullOrWhiteSpace(_listing.District))
                        {
                            <tr>
                                <td><strong>Okres</strong></td>
                                <td>@_listing.District</td>
                            </tr>
                        }
                        @if (!string.IsNullOrWhiteSpace(_listing.Region))
                        {
                            <tr>
                                <td><strong>Kraj</strong></td>
                                <td>@_listing.Region</td>
                            </tr>
                        }
                        @if (_listing.AreaBuiltUp.HasValue)
                        {
                            <tr>
                                <td><strong>Zastavƒõn√° plocha</strong></td>
                                <td>@_listing.AreaBuiltUp.Value.ToString("N0") m¬≤</td>
                            </tr>
                        }
                        @if (_listing.AreaLand.HasValue)
                        {
                            <tr>
                                <td><strong>Plocha pozemku</strong></td>
                                <td>@_listing.AreaLand.Value.ToString("N0") m¬≤</td>
                            </tr>
                        }
                        @if (_listing.Rooms.HasValue)
                        {
                            <tr>
                                <td><strong>Poƒçet pokoj≈Ø</strong></td>
                                <td>@_listing.Rooms.Value</td>
                            </tr>
                        }
                        @if (_listing.HasKitchen.HasValue)
                        {
                            <tr>
                                <td><strong>Kuchy≈à</strong></td>
                                <td>@(_listing.HasKitchen.Value ? "Ano" : "Ne")</td>
                            </tr>
                        }
                        @if (!string.IsNullOrWhiteSpace(_listing.ConstructionType))
                        {
                            <tr>
                                <td><strong>Konstrukce</strong></td>
                                <td>@_listing.ConstructionType</td>
                            </tr>
                        }
                        @if (!string.IsNullOrWhiteSpace(_listing.Condition))
                        {
                            <tr>
                                <td><strong>Stav</strong></td>
                                <td>@_listing.Condition</td>
                            </tr>
                        }
                        <tr>
                            <td><strong>Poprv√© vidƒõno</strong></td>
                            <td>@_listing.FirstSeenAt.ToString("dd.MM.yyyy HH:mm")</td>
                        </tr>
                        @if (_listing.LastSeenAt.HasValue)
                        {
                            <tr>
                                <td><strong>Naposledy vidƒõno</strong></td>
                                <td>@_listing.LastSeenAt.Value.ToString("dd.MM.yyyy HH:mm")</td>
                            </tr>
                        }
                        <tr>
                            <td><strong>URL</strong></td>
                            <td><MudLink Href="@_listing.SourceUrl" Target="_blank">Otev≈ô√≠t p≈Øvodn√≠ inzer√°t</MudLink></td>
                        </tr>
                    </tbody>
                </MudSimpleTable>
            </MudPaper>

            <!-- Description -->
            <MudPaper Class="pa-4">
                <MudText Typo="Typo.h6" Class="mb-3">Popis</MudText>
                <MudText Typo="Typo.body1" Style="white-space: pre-wrap;">@_listing.Description</MudText>
            </MudPaper>

            <!-- Katastr nemovitosti -->
            <MudPaper Class="pa-4">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.AccountBalance" Color="Color.Info" />
                    <MudText Typo="Typo.h6">Katastr nemovitosti</MudText>
                    @if (_cadastreData?.FetchStatus == "found")
                    {
                        <MudChip T="string" Color="Color.Success" Size="Size.Small"
                                 Icon="@Icons.Material.Filled.CheckCircle">
                            RUIAN @_cadastreData.RuianKod
                        </MudChip>
                    }
                </MudStack>

                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-2">
                    Adresa pro vyhledavani: <strong>@_listing.LocationText</strong>
                </MudText>

                <MudText Typo="Typo.subtitle2" Class="mb-1">Co zkontrolovat v KN:</MudText>
                <MudSimpleTable Dense="true" Class="mb-3" Style="font-size:0.85em">
                    <tbody>
                        <tr>
                            <td>&#x1F534;</td>
                            <td><strong>Zastavni prava</strong></td>
                            <td>Hypoteky a exekuce na listu vlastnictvi (LV)</td>
                        </tr>
                        <tr>
                            <td>&#x1F7E1;</td>
                            <td><strong>Vecna bremena</strong></td>
                            <td>Pravo pruchodu, vedeni siti, uzivani treti osobou</td>
                        </tr>
                        <tr>
                            <td>&#x26A0;&#xFE0F;</td>
                            <td><strong>Vymera pozemku</strong></td>
                            <td>Overit vs. @(_listing.AreaLand.HasValue ? _listing.AreaLand.Value.ToString("N0") + " m¬≤" : "?") z inzeratu</td>
                        </tr>
                        <tr>
                            <td>&#x26A0;&#xFE0F;</td>
                            <td><strong>Druh pozemku</strong></td>
                            <td>Zastavena plocha / zahrada / orna puda</td>
                        </tr>
                        <tr>
                            <td>&#x26A0;&#xFE0F;</td>
                            <td><strong>Pristupova cesta</strong></td>
                            <td>Na cizim pozemku nebo vecne bremeno?</td>
                        </tr>
                    </tbody>
                </MudSimpleTable>

                <MudStack Row="true" Spacing="2" Wrap="Wrap.Wrap" AlignItems="AlignItems.Center">
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Info"
                               StartIcon="@Icons.Material.Filled.OpenInNew"
                               Href="@GetCadastreUrl()"
                               Target="_blank">
                        Otevrit v KN
                    </MudButton>
                    @if (_cadastreData?.FetchStatus != "found")
                    {
                        <MudTooltip Text="Nacte primy odkaz na nahlizenidokn.cuzk.cz">
                            <MudButton Variant="Variant.Outlined"
                                       Color="Color.Default"
                                       Size="Size.Small"
                                       StartIcon="@Icons.Material.Filled.LocationOn"
                                       OnClick="FetchRuianAsync"
                                       Disabled="_cadastreLoading">
                                @if (_cadastreLoading)
                                {
                                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-1" />
                                    <span>Hledam...</span>
                                }
                                else
                                {
                                    <span>Najit primy odkaz (RUIAN)</span>
                                }
                            </MudButton>
                        </MudTooltip>
                    }
                    @if (_cadastreData?.FetchStatus == "not_found")
                    {
                        <MudText Typo="Typo.caption" Color="Color.Warning">Adresa v RUIAN nenalezena</MudText>
                    }
                </MudStack>
            </MudPaper>

            <!-- User State -->
            <MudPaper Class="pa-4">
                <MudText Typo="Typo.h6" Class="mb-3">M≈Øj stav</MudText>
                <MudStack Spacing="2">
                    <MudButtonGroup Variant="Variant.Outlined" Color="Color.Primary">
                        <MudButton OnClick="@(() => UpdateUserStatus("New"))" 
                                   Disabled="@(_userState.Status == "New")"
                                   Color="@(_userState.Status == "New" ? Color.Primary : Color.Default)">
                            Nov√©
                        </MudButton>
                        <MudButton OnClick="@(() => UpdateUserStatus("Liked"))" 
                                   Disabled="@(_userState.Status == "Liked")"
                                   Color="@(_userState.Status == "Liked" ? Color.Success : Color.Default)">
                            Zaj√≠mav√©
                        </MudButton>
                        <MudButton OnClick="@(() => UpdateUserStatus("Disliked"))" 
                                   Disabled="@(_userState.Status == "Disliked")"
                                   Color="@(_userState.Status == "Disliked" ? Color.Error : Color.Default)">
                            Nezaj√≠mav√©
                        </MudButton>
                        <MudButton OnClick="@(() => UpdateUserStatus("ToVisit"))" 
                                   Disabled="@(_userState.Status == "ToVisit")"
                                   Color="@(_userState.Status == "ToVisit" ? Color.Warning : Color.Default)">
                            K n√°v≈°tƒõvƒõ
                        </MudButton>
                        <MudButton OnClick="@(() => UpdateUserStatus("Visited"))" 
                                   Disabled="@(_userState.Status == "Visited")"
                                   Color="@(_userState.Status == "Visited" ? Color.Info : Color.Default)">
                            Nav≈°t√≠veno
                        </MudButton>
                    </MudButtonGroup>

                    <MudTextField @bind-Value="_userState.Notes" 
                                  Label="Pozn√°mky" 
                                  Lines="3" 
                                  Variant="Variant.Outlined"
                                  OnBlur="SaveNotesAsync" />

                    @if (_userState.LastUpdated.HasValue)
                    {
                        <MudText Typo="Typo.caption">
                            Naposledy upraveno: @_userState.LastUpdated.Value.ToString("dd.MM.yyyy HH:mm")
                        </MudText>
                    }
                </MudStack>
            </MudPaper>

            <!-- Actions -->
            <MudStack Spacing="2">
                <MudStack Row="true" Spacing="2" Wrap="Wrap.Wrap">
                    <MudButton Color="Color.Primary" 
                               Variant="Variant.Filled" 
                               OnClick="@(() => Navigation.NavigateTo("/listings"))">
                        Zpƒõt na seznam
                    </MudButton>
                    <MudButton Color="Color.Secondary" 
                               Variant="Variant.Filled" 
                               OnClick="CreateAnalysisAsync">
                        Vytvo≈ôit anal√Ωzu
                    </MudButton>
                    <MudButton Color="Color.Warning"
                               Variant="Variant.Filled"
                               OnClick="CopyAiBriefAsync"
                               Disabled="_aiBriefLoading"
                               StartIcon="@Icons.Material.Filled.ContentCopy">
                        @if (_aiBriefLoading)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            <span>P≈ôipravuji‚Ä¶</span>
                        }
                        else
                        {
                            <span>Zkop√≠rovat pro AI</span>
                        }
                    </MudButton>
                    <MudButton Color="Color.Success"
                               Variant="Variant.Filled"
                               OnClick="ExportToDriveAsync"
                               Disabled="_driveExporting"
                               StartIcon="@Icons.Material.Filled.CloudUpload">
                        @if (_driveExporting)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            <span>Nahr√°v√°m na Drive‚Ä¶</span>
                        }
                        else
                        {
                            <span>Export na Google Drive</span>
                        }
                    </MudButton>
                    <MudButton Color="Color.Info"
                               Variant="Variant.Filled"
                               OnClick="ExportToOneDriveAsync"
                               Disabled="_oneDriveExporting"
                               StartIcon="@Icons.Material.Filled.CloudUpload">
                        @if (_oneDriveExporting)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            <span>Nahr√°v√°m na OneDrive‚Ä¶</span>
                        }
                        else
                        {
                            <span>Export na OneDrive</span>
                        }
                    </MudButton>
                </MudStack>

                @if (_driveResult is not null)
                {
                    <MudAlert Severity="Severity.Success" Dense="false">
                        <MudStack Spacing="1">
                            <MudText Typo="Typo.body1">
                                <strong>Slo≈æka p≈ôipraven√°:</strong> @_driveResult.FolderName
                            </MudText>
                            <MudText Typo="Typo.caption" Style="word-break:break-all">
                                @_driveResult.FolderUrl
                            </MudText>
                            <MudStack Row="true" Spacing="2">
                                <MudButton Variant="Variant.Filled" Size="Size.Small" Color="Color.Success"
                                           StartIcon="@Icons.Material.Filled.OpenInNew"
                                           Href="@_driveResult.FolderUrl" Target="_blank">
                                    Otev≈ô√≠t v Google Drive
                                </MudButton>
                                <MudButton Variant="Variant.Outlined" Size="Size.Small" Color="Color.Default"
                                           StartIcon="@Icons.Material.Filled.ContentCopy"
                                           OnClick="CopyDriveUrlAsync">
                                    Kop√≠rovat URL
                                </MudButton>
                            </MudStack>
                            <MudText Typo="Typo.caption" Color="Color.Success">
                                Slo≈æka obsahuje INFO.md, DATA.json, AI_INSTRUKCE.md a fotky ze scrapu.
                                Nahraj vlastn√≠ fotky z prohl√≠dky do podslo≈æky <strong>Moje_fotky_z_prohlidky</strong>.
                            </MudText>
                            @if (_driveResult.PhotosTotal > 0)
                            {
                                <MudText Typo="Typo.caption"
                                         Color="@(_driveResult.PhotosUploaded == _driveResult.PhotosTotal ? Color.Success : Color.Warning)">
                                    üì∑ Fotky: @_driveResult.PhotosUploaded / @_driveResult.PhotosTotal nahr√°no
                                    @if (_driveResult.PhotosUploaded < _driveResult.PhotosTotal)
                                    {
                                        <span> ‚Äì @(_driveResult.PhotosTotal - _driveResult.PhotosUploaded) fotek se nepoda≈ôilo st√°hnout (CDN vypr≈°el)</span>
                                    }
                                </MudText>
                            }
                            @if (DriveInspectionId is not null)
                            {
                                <MudDivider />
                                <MudText Typo="Typo.body2"><strong>üì∏ Nahr√°t fotky z prohl√≠dky</strong></MudText>
                                <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center" Wrap="Wrap.Wrap">
                                    <MudFileUpload T="IReadOnlyList<IBrowserFile>"
                                                   FilesChanged="@(files => _driveInspectionFiles = files ?? [])"
                                                   Accept=".jpg,.jpeg,.png,.heic,.heif,.webp"
                                                   MaximumFileCount="150">
                                        <ActivatorContent>
                                            <MudButton Variant="Variant.Outlined" Size="Size.Small" Color="Color.Success"
                                                       StartIcon="@Icons.Material.Filled.PhotoCamera">
                                                @if (_driveInspectionFiles.Count > 0)
                                                {
                                                    <span>Vybr√°no @_driveInspectionFiles.Count fotek ‚Äì zmƒõnit</span>
                                                }
                                                else
                                                {
                                                    <span>Vybrat fotky z prohl√≠dky</span>
                                                }
                                            </MudButton>
                                        </ActivatorContent>
                                    </MudFileUpload>
                                    @if (_driveInspectionFiles.Count > 0)
                                    {
                                        <MudButton Variant="Variant.Filled" Size="Size.Small" Color="Color.Success"
                                                   StartIcon="@Icons.Material.Filled.CloudUpload"
                                                   Disabled="@_uploadingDrivePhotos"
                                                   OnClick="UploadDriveInspectionPhotosAsync">
                                            @if (_uploadingDrivePhotos)
                                            {
                                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                                <span>Nahr√°v√°m‚Ä¶</span>
                                            }
                                            else
                                            {
                                                <span>Nahr√°t @_driveInspectionFiles.Count fotek na Drive</span>
                                            }
                                        </MudButton>
                                    }
                                </MudStack>
                            }
                        </MudStack>
                    </MudAlert>
                }

                @if (_oneDriveResult is not null)
                {
                    <MudAlert Severity="Severity.Info" Dense="false">
                        <MudStack Spacing="2">
                            <MudText Typo="Typo.body1">
                                <strong>OneDrive slo≈æka:</strong> @_oneDriveResult.FolderName
                            </MudText>
                            <MudText Typo="Typo.caption" Style="word-break:break-all">
                                @_oneDriveResult.FolderUrl
                            </MudText>
                            <MudStack Row="true" Spacing="2">
                                <MudButton Variant="Variant.Filled" Size="Size.Small" Color="Color.Info"
                                           StartIcon="@Icons.Material.Filled.OpenInNew"
                                           Href="@_oneDriveResult.FolderUrl" Target="_blank">
                                    Otev≈ô√≠t v OneDrive
                                </MudButton>
                                <MudButton Variant="Variant.Outlined" Size="Size.Small" Color="Color.Default"
                                           StartIcon="@Icons.Material.Filled.ContentCopy"
                                           OnClick="CopyOneDriveUrlAsync">
                                    Kop√≠rovat URL
                                </MudButton>
                            </MudStack>
                            @if (_oneDriveResult.PhotosTotal > 0)
                            {
                                <MudText Typo="Typo.caption"
                                         Color="@(_oneDriveResult.PhotosUploaded == _oneDriveResult.PhotosTotal ? Color.Info : Color.Warning)">
                                    üì∑ Fotky: @_oneDriveResult.PhotosUploaded / @_oneDriveResult.PhotosTotal nahr√°no
                                    @if (_oneDriveResult.PhotosUploaded < _oneDriveResult.PhotosTotal)
                                    {
                                        <span> ‚Äì @(_oneDriveResult.PhotosTotal - _oneDriveResult.PhotosUploaded) fotek se nepoda≈ôilo st√°hnout (CDN vypr≈°el)</span>
                                    }
                                </MudText>
                            }
                            <MudDivider />
                            <MudText Typo="Typo.body2"><strong>üß† Ulo≈æit anal√Ωzu z Clauda</strong></MudText>
                            <MudText Typo="Typo.caption" Color="Color.Info">
                                Zkop√≠ruj v√Ωsledek anal√Ωzy z Clauda/Perplexity a vlo≈æ ho n√≠≈æe. Tlaƒç√≠tko ho ulo≈æ√≠ p≈ô√≠mo do OneDrive slo≈æky jako ANALYZA_datum.md.
                            </MudText>
                            <MudTextField @bind-Value="_analysisText"
                                          T="string"
                                          Label="V√Ωsledek anal√Ωzy z AI"
                                          Placeholder="Sem vlo≈æ text anal√Ωzy od Clauda‚Ä¶"
                                          Lines="8"
                                          Variant="Variant.Outlined"
                                          FullWidth="true" />
                            <MudButton Variant="Variant.Filled" Color="Color.Warning"
                                       StartIcon="@Icons.Material.Filled.Save"
                                       Disabled="@(string.IsNullOrWhiteSpace(_analysisText) || _savingAnalysis)"
                                       OnClick="SaveAnalysisToOneDriveAsync">
                                @if (_savingAnalysis)
                                {
                                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                    <span>Ukl√°d√°m‚Ä¶</span>
                                }
                                else
                                {
                                    <span>Ulo≈æit anal√Ωzu do OneDrive</span>
                                }
                            </MudButton>
                            @if (OneDriveInspectionId is not null)
                            {
                                <MudDivider />
                                <MudText Typo="Typo.body2"><strong>üì∏ Nahr√°t fotky z prohl√≠dky</strong></MudText>
                                <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center" Wrap="Wrap.Wrap">
                                    <MudFileUpload T="IReadOnlyList<IBrowserFile>"
                                                   FilesChanged="@(files => _oneDriveInspectionFiles = files ?? [])"
                                                   Accept=".jpg,.jpeg,.png,.heic,.heif,.webp"
                                                   MaximumFileCount="150">
                                        <ActivatorContent>
                                            <MudButton Variant="Variant.Outlined" Size="Size.Small" Color="Color.Info"
                                                       StartIcon="@Icons.Material.Filled.PhotoCamera">
                                                @if (_oneDriveInspectionFiles.Count > 0)
                                                {
                                                    <span>Vybr√°no @_oneDriveInspectionFiles.Count fotek ‚Äì zmƒõnit</span>
                                                }
                                                else
                                                {
                                                    <span>Vybrat fotky z prohl√≠dky</span>
                                                }
                                            </MudButton>
                                        </ActivatorContent>
                                    </MudFileUpload>
                                    @if (_oneDriveInspectionFiles.Count > 0)
                                    {
                                        <MudButton Variant="Variant.Filled" Size="Size.Small" Color="Color.Info"
                                                   StartIcon="@Icons.Material.Filled.CloudUpload"
                                                   Disabled="@_uploadingOneDrivePhotos"
                                                   OnClick="UploadOneDriveInspectionPhotosAsync">
                                            @if (_uploadingOneDrivePhotos)
                                            {
                                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                                <span>Nahr√°v√°m‚Ä¶</span>
                                            }
                                            else
                                            {
                                                <span>Nahr√°t @_oneDriveInspectionFiles.Count fotek na OneDrive</span>
                                            }
                                        </MudButton>
                                    }
                                </MudStack>
                            }
                        </MudStack>
                    </MudAlert>
                }
                @if (OneDriveExportedButNoSession)
                {
                    <MudAlert Severity="Severity.Info" Dense="false">
                        <MudStack Spacing="2">
                            <MudText Typo="Typo.body1">
                                <strong>OneDrive:</strong> Slo≈æka existuje (exportov√°no d≈ô√≠ve)
                            </MudText>
                            <MudText Typo="Typo.caption" Color="Color.Info">
                                Str√°nka byla obnovena ‚Äì odkaz na slo≈æku nen√≠ v session. Klikni ‚ÄûExport na OneDrive" pro opƒõtovn√© zobrazen√≠ odkazu.
                            </MudText>
                            @if (OneDriveInspectionId is not null)
                            {
                                <MudDivider />
                                <MudText Typo="Typo.body2"><strong>üì∏ Nahr√°t fotky z prohl√≠dky</strong></MudText>
                                <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center" Wrap="Wrap.Wrap">
                                    <MudFileUpload T="IReadOnlyList<IBrowserFile>"
                                                   FilesChanged="@(files => _oneDriveInspectionFiles = files ?? [])"
                                                   Accept=".jpg,.jpeg,.png,.heic,.heif,.webp"
                                                   MaximumFileCount="150">
                                        <ActivatorContent>
                                            <MudButton Variant="Variant.Outlined" Size="Size.Small" Color="Color.Info"
                                                       StartIcon="@Icons.Material.Filled.PhotoCamera">
                                                @if (_oneDriveInspectionFiles.Count > 0)
                                                {
                                                    <span>Vybr√°no @_oneDriveInspectionFiles.Count fotek ‚Äì zmƒõnit</span>
                                                }
                                                else
                                                {
                                                    <span>Vybrat fotky z prohl√≠dky</span>
                                                }
                                            </MudButton>
                                        </ActivatorContent>
                                    </MudFileUpload>
                                    @if (_oneDriveInspectionFiles.Count > 0)
                                    {
                                        <MudButton Variant="Variant.Filled" Size="Size.Small" Color="Color.Info"
                                                   StartIcon="@Icons.Material.Filled.CloudUpload"
                                                   Disabled="@_uploadingOneDrivePhotos"
                                                   OnClick="UploadOneDriveInspectionPhotosAsync">
                                            @if (_uploadingOneDrivePhotos)
                                            {
                                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                                <span>Nahr√°v√°m‚Ä¶</span>
                                            }
                                            else
                                            {
                                                <span>Nahr√°t @_oneDriveInspectionFiles.Count fotek na OneDrive</span>
                                            }
                                        </MudButton>
                                    }
                                </MudStack>
                            }
                        </MudStack>
                    </MudAlert>
                }
            </MudStack>

            <!-- RAG Chat -->
            <MudPaper Class="pa-4">
                <MudText Typo="Typo.h6" Class="mb-1">ü§ñ AI Chat</MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-3">
                    Ptej se na z√°kladƒõ ulo≈æen√Ωch anal√Ωz. Klikni ‚ÄûEmbedovat popis" pro
                    inicializaci (staƒç√≠ jednou ‚Äì popis inzer√°tu se ulo≈æ√≠ jako znalostn√≠ z√°znam).
                </MudText>
                <MudStack Spacing="2">
                    <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center" Wrap="Wrap.Wrap">
                        <MudButton Variant="Variant.Outlined" Size="Size.Small"
                                   Color="@(_ragDescriptionEmbedded ? Color.Success : Color.Warning)"
                                   StartIcon="@(_ragDescriptionEmbedded ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.AutoFixHigh)"
                                   Disabled="@(_ragEmbedding || _ragDescriptionEmbedded)"
                                   OnClick="EmbedDescriptionAsync">
                            @if (_ragEmbedding)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-1" />
                                <span>Embeduji popis‚Ä¶</span>
                            }
                            else if (_ragDescriptionEmbedded)
                            {
                                <span>Popis embedov√°n ‚úì</span>
                            }
                            else
                            {
                                <span>Embedovat popis inzer√°tu</span>
                            }
                        </MudButton>
                        @if (_ragAnalysisCount > 0)
                        {
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                @_ragAnalysisCount z√°znamy v knowledge base
                            </MudText>
                        }
                    </MudStack>

                    <MudTextField @bind-Value="_ragQuestion"
                                  T="string"
                                  Label="Ot√°zka k inzer√°tu"
                                  Placeholder="Nap≈ô. Jak√© jsou nev√Ωhody? Je cena p≈ôimƒõ≈ôen√°? Vhodn√© pro rodinu?"
                                  Lines="2"
                                  Variant="Variant.Outlined"
                                  FullWidth="true"
                                  OnKeyDown="@(async (e) => { if (e.Key == "Enter" && !e.ShiftKey) await AskRagAsync(); })" />
                    <MudButton Variant="Variant.Filled" Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.QuestionAnswer"
                               Disabled="@(string.IsNullOrWhiteSpace(_ragQuestion) || _ragLoading)"
                               OnClick="AskRagAsync">
                        @if (_ragLoading)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            <span>P≈ôem√Ω≈°l√≠m‚Ä¶</span>
                        }
                        else
                        {
                            <span>Zeptat se</span>
                        }
                    </MudButton>

                    @if (_ragAnswer is not null)
                    {
                        <MudDivider />
                        <MudAlert Severity="@(_ragHasEmbeddings ? Severity.Info : Severity.Warning)"
                                  Dense="false" NoIcon="false">
                            <MudText Typo="Typo.body2" Style="white-space: pre-wrap;">@_ragAnswer</MudText>
                        </MudAlert>
                        @if (_ragSources.Count > 0)
                        {
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                Vyu≈æit√© z√°znamy:
                                @foreach (var s in _ragSources)
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Default"
                                             Class="ml-1">@(s.Title ?? s.Source) ¬∑ @s.Similarity.ToString("P0")</MudChip>
                                }
                            </MudText>
                        }
                    }
                </MudStack>
            </MudPaper>
        </MudStack>
    }
</MudContainer>

@code {
    [Parameter]
    public Guid Id { get; set; }

    private bool _loading = true;
    private ListingDetailDto? _listing;
    private ListingUserStateDto _userState = new();
    private CancellationTokenSource _cts = new();

    // Google Drive export
    private bool _driveExporting = false;
    private DriveExportResult? _driveResult;
    private record DriveExportResult(string FolderUrl, string FolderName, string FolderId, string? InspectionFolderId = null,
        int PhotosUploaded = 0, int PhotosTotal = 0);

    // OneDrive export
    private bool _oneDriveExporting = false;
    private DriveExportResult? _oneDriveResult;

    // AI brief
    private bool _aiBriefLoading = false;

    // Ulo≈æen√≠ anal√Ωzy
    private string _analysisText = string.Empty;
    private bool _savingAnalysis = false;

    // Upload fotek z prohl√≠dky
    private IReadOnlyList<IBrowserFile> _driveInspectionFiles = [];
    private IReadOnlyList<IBrowserFile> _oneDriveInspectionFiles = [];
    private bool _uploadingDrivePhotos = false;
    private bool _uploadingOneDrivePhotos = false;

    // Export state z DB (trval√Ω, p≈ôe≈æ√≠v√° refresh str√°nky)
    private record ExportState(string? DriveFolderId, string? DriveFolderUrl, string? DriveInspectionFolderId,
        string? OneDriveFolderId, string? OneDriveInspectionFolderId);
    private ExportState? _exportState;

    // Computed helpers ‚Äì true i kdy≈æ _driveResult/oneDriveResult jsou null (stav naƒçten z DB)
    private string? DriveInspectionId => _driveResult?.InspectionFolderId ?? _exportState?.DriveInspectionFolderId;
    private string? OneDriveInspectionId => _oneDriveResult?.InspectionFolderId ?? _exportState?.OneDriveInspectionFolderId;
    private bool OneDriveExportedButNoSession => _oneDriveResult is null && _exportState?.OneDriveFolderId is not null;

    // Katastr nemovitosti (RUIAN)
    private CadastreDataDto? _cadastreData;
    private bool _cadastreLoading;
    private record CadastreDataDto(Guid Id, Guid ListingId, long? RuianKod, string? CadastreUrl, string FetchStatus, DateTime FetchedAt);

    // RAG Chat
    private string _ragQuestion = string.Empty;
    private string? _ragAnswer;
    private bool _ragHasEmbeddings;
    private List<RagChunkInfo> _ragSources = [];
    private bool _ragLoading;
    private bool _ragEmbedding;
    private bool _ragDescriptionEmbedded;
    private int _ragAnalysisCount;
    private record RagChunkInfo(Guid AnalysisId, string? Title, string ContentExcerpt, string Source, double Similarity, DateTime CreatedAt);
    private record RagAskResponse(string Answer, List<RagChunkInfo> Sources, bool HasEmbeddings);
    private record RagEmbedStatus(int TotalAnalyses, int WithEmbedding);


    private static readonly IReadOnlyDictionary<string, string> PropertyTypeLabels =
        new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase)
        {
            ["House"] = "D≈Øm",
            ["Apartment"] = "Byt",
            ["Land"] = "Pozemek",
            ["Cottage"] = "Chata",
            ["Commercial"] = "Komerƒçn√≠",
            ["Other"] = "Ostatn√≠"
        };

    private static readonly IReadOnlyDictionary<string, string> OfferTypeLabels =
        new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase)
        {
            ["Sale"]    = "Prodej",
            ["Rent"]    = "Pron√°jem",
            ["Auction"] = "Dra≈æba"
        };

    protected override async Task OnInitializedAsync()
    {
        await LoadListingAsync();
        await LoadExportStateAsync();
        await LoadRagAnalysesAsync();
        await LoadCadastreDataAsync();
    }

    private async Task LoadCadastreDataAsync()
    {
        try
        {
            _cadastreData = await Http.GetFromJsonAsync<CadastreDataDto>(
                $"api/cadastre/listings/{Id}", _cts.Token);
        }
        catch { /* katastralni data jsou optional */ }
    }

    private string GetCadastreUrl()
    {
        if (_cadastreData?.FetchStatus == "found" && !string.IsNullOrWhiteSpace(_cadastreData.CadastreUrl))
            return _cadastreData.CadastreUrl;
        return "https://nahlizenidokn.cuzk.cz/";
    }

    private async Task FetchRuianAsync()
    {
        _cadastreLoading = true;
        try
        {
            var response = await Http.PostAsync($"api/cadastre/listings/{Id}/fetch", null, _cts.Token);
            if (response.IsSuccessStatusCode)
            {
                _cadastreData = await response.Content.ReadFromJsonAsync<CadastreDataDto>();
                if (_cadastreData?.FetchStatus == "found")
                    Snackbar.Add("Primy odkaz na KN nalezen", Severity.Success);
                else
                    Snackbar.Add("Adresa v RUIAN nenalezena - otevri KN rucne", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"RUIAN chyba: {ex.Message}", Severity.Error);
        }
        finally
        {
            _cadastreLoading = false;
        }
    }

    private async Task LoadExportStateAsync()
    {
        try
        {
            _exportState = await Http.GetFromJsonAsync<ExportState>($"api/listings/{Id}/export-state", _cts.Token);
            // Pokud u≈æ byl Drive export, p≈ôed-pln√≠me _driveResult (URL je trval√° pro GD)
            if (_exportState?.DriveFolderUrl is not null && _driveResult is null)
            {
                _driveResult = new DriveExportResult(
                    _exportState.DriveFolderUrl,
                    "[ulo≈æen√Ω export]",
                    _exportState.DriveFolderId!,
                    _exportState.DriveInspectionFolderId);
            }
        }
        catch { /* export-state je optional, ignorujeme chybu */ }
    }

    private async Task LoadListingAsync()
    {
        _loading = true;
        try
        {
            _listing = await Http.GetFromJsonAsync<ListingDetailDto>($"api/listings/{Id}");
            if (_listing != null)
            {
                _userState = _listing.UserState ?? new();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Chyba p≈ôi naƒç√≠t√°n√≠: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task UpdateUserStatus(string status)
    {
        try
        {
            _userState.Status = status;
            _userState.LastUpdated = DateTime.Now;

            var request = new ListingUserStateUpdateDto
            {
                Status = _userState.Status,
                Notes = _userState.Notes
            };

            var response = await Http.PostAsJsonAsync($"api/listings/{Id}/state", request);
            if (response.IsSuccessStatusCode)
            {
                var updated = await response.Content.ReadFromJsonAsync<ListingUserStateDto>();
                if (updated is not null)
                {
                    _userState = updated;
                }
                Snackbar.Add("Stav ulo≈æen", Severity.Success);
            }
            else
            {
                Snackbar.Add("Chyba p≈ôi ukl√°d√°n√≠ stavu", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Chyba: {ex.Message}", Severity.Error);
        }
    }

    private async Task SaveNotesAsync()
    {
        try
        {
            _userState.LastUpdated = DateTime.Now;

            var request = new ListingUserStateUpdateDto
            {
                Status = _userState.Status,
                Notes = _userState.Notes
            };

            var response = await Http.PostAsJsonAsync($"api/listings/{Id}/state", request);
            if (response.IsSuccessStatusCode)
            {
                var updated = await response.Content.ReadFromJsonAsync<ListingUserStateDto>();
                if (updated is not null)
                {
                    _userState = updated;
                }
                Snackbar.Add("Pozn√°mky ulo≈æeny", Severity.Success);
            }
            else
            {
                Snackbar.Add("Chyba p≈ôi ukl√°d√°n√≠ pozn√°mek", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Chyba: {ex.Message}", Severity.Error);
        }
    }

    private async Task CreateAnalysisAsync()
    {
        try
        {
            var request = new AnalysisJobCreateDto
            {
                StorageProvider = "Local"
            };

            var response = await Http.PostAsJsonAsync($"api/analysis/listing/{Id}", request);
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Anal√Ωza byla vytvo≈ôena", Severity.Success);
            }
            else
            {
                Snackbar.Add("Chyba p≈ôi vytv√°≈ôen√≠ anal√Ωzy", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Chyba: {ex.Message}", Severity.Error);
        }
    }

    private async Task CopyAiBriefAsync()
    {
        _aiBriefLoading = true;
        StateHasChanged();
        try
        {
            var response = await Http.GetAsync($"api/listings/{Id}/ai-brief", _cts.Token);
            if (response.IsSuccessStatusCode)
            {
                var text = await response.Content.ReadAsStringAsync(_cts.Token);
                await JS.InvokeVoidAsync("navigator.clipboard.writeText", text);
                Snackbar.Add("‚úÖ Zkop√≠rov√°no! Vlo≈æ p≈ô√≠mo do Clauda nebo Perplexity.", Severity.Success);
            }
            else
            {
                Snackbar.Add($"Chyba p≈ôi naƒç√≠t√°n√≠ AI briefinku: {response.StatusCode}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Chyba: {ex.Message}", Severity.Error);
        }
        finally
        {
            _aiBriefLoading = false;
        }
    }

    private async Task ExportToDriveAsync()
    {
        _driveExporting = true;
        _driveResult = null;
        StateHasChanged();
        try
        {
            var response = await Http.PostAsync($"api/listings/{Id}/export-drive", null, _cts.Token);
            if (response.IsSuccessStatusCode)
            {
                _driveResult = await response.Content.ReadFromJsonAsync<DriveExportResult>(_cts.Token);
                Snackbar.Add("Export na Google Drive byl √∫spƒõ≈°n√Ω!", Severity.Success);
            }
            else
            {
                var err = await response.Content.ReadAsStringAsync(_cts.Token);
                Snackbar.Add($"Chyba p≈ôi exportu: {response.StatusCode}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Chyba: {ex.Message}", Severity.Error);
        }
        finally
        {
            _driveExporting = false;
        }
    }

    private async Task CopyDriveUrlAsync()
    {
        if (_driveResult is null) return;
        try
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", _driveResult.FolderUrl);
            Snackbar.Add("URL zkop√≠rov√°no do schr√°nky", Severity.Info);
        }
        catch
        {
            Snackbar.Add(_driveResult.FolderUrl, Severity.Normal);
        }
    }

    private async Task ExportToOneDriveAsync()
    {
        _oneDriveExporting = true;
        _oneDriveResult = null;
        StateHasChanged();
        try
        {
            var response = await Http.PostAsync($"api/listings/{Id}/export-onedrive", null, _cts.Token);
            if (response.IsSuccessStatusCode)
            {
                _oneDriveResult = await response.Content.ReadFromJsonAsync<DriveExportResult>(_cts.Token);
                Snackbar.Add("Export na OneDrive byl √∫spƒõ≈°n√Ω!", Severity.Success);
            }
            else
            {
                Snackbar.Add($"Chyba p≈ôi exportu na OneDrive: {response.StatusCode}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Chyba: {ex.Message}", Severity.Error);
        }
        finally
        {
            _oneDriveExporting = false;
        }
    }

    private async Task CopyOneDriveUrlAsync()
    {
        if (_oneDriveResult is null) return;
        try
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", _oneDriveResult.FolderUrl);
            Snackbar.Add("URL zkop√≠rov√°no do schr√°nky", Severity.Info);
        }
        catch
        {
            Snackbar.Add(_oneDriveResult.FolderUrl, Severity.Normal);
        }
    }

    private async Task SaveAnalysisToOneDriveAsync()
    {
        if (_oneDriveResult is null || string.IsNullOrWhiteSpace(_analysisText)) return;
        _savingAnalysis = true;
        StateHasChanged();
        try
        {
            var content = new StringContent(_analysisText, System.Text.Encoding.UTF8, "text/plain");
            var response = await Http.PostAsync(
                $"api/listings/{Id}/save-analysis?folderId={Uri.EscapeDataString(_oneDriveResult.FolderId)}",
                content, _cts.Token);
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("‚úÖ Anal√Ωza ulo≈æena do OneDrive slo≈æky!", Severity.Success);
                _analysisText = string.Empty;
            }
            else
            {
                var err = await response.Content.ReadAsStringAsync(_cts.Token);
                Snackbar.Add($"Chyba p≈ôi ukl√°d√°n√≠: {response.StatusCode}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Chyba: {ex.Message}", Severity.Error);
        }
        finally
        {
            _savingAnalysis = false;
        }
    }

    private async Task UploadDriveInspectionPhotosAsync()
    {
        if (_driveInspectionFiles is not { Count: > 0 }) return;
        // Folder ID je v DB, nemus√≠me m√≠t _driveResult v session
        if (_exportState?.DriveInspectionFolderId is null && _driveResult?.InspectionFolderId is null)
        {
            Snackbar.Add("Nejprve exportujte inzer√°t na Google Drive.", Severity.Warning);
            return;
        }
        _uploadingDrivePhotos = true;
        StateHasChanged();
        try
        {
            // Naƒçti v≈°echny soubory do pamƒõti NEJDRIVE ne≈æ postavis MultipartFormDataContent
            // (IBrowserFile stream nelze ƒç√≠st v backgroundu, mus√≠ p≈ôe≈æ√≠t po dobu SendAsync)
            var readFiles = new List<(string Name, byte[] Data, string Ct)>();
            foreach (var file in _driveInspectionFiles)
            {
                try
                {
                    await using var stream = file.OpenReadStream(maxAllowedSize: 30 * 1024 * 1024, _cts.Token);
                    using var ms = new MemoryStream();
                    await stream.CopyToAsync(ms, _cts.Token);
                    var safeName = string.IsNullOrWhiteSpace(file.Name) ? $"foto_{readFiles.Count + 1}.jpg" : Path.GetFileName(file.Name);
                    var ct2 = string.IsNullOrWhiteSpace(file.ContentType) ? "image/jpeg" : file.ContentType;
                    readFiles.Add((safeName, ms.ToArray(), ct2));
                }
                catch (Exception ex)
                {
                    Snackbar.Add($"‚ö†Ô∏è Skipping {file.Name}: {ex.Message}", Severity.Warning);
                }
            }

            if (readFiles.Count == 0)
            {
                Snackbar.Add("Nepoda≈ôilo se naƒç√≠st ≈æ√°dn√Ω soubor.", Severity.Warning);
                return;
            }

            using var content = new MultipartFormDataContent();
            for (int i = 0; i < readFiles.Count; i++)
            {
                var (name, data, ct2) = readFiles[i];
                var fileContent = new ByteArrayContent(data);
                fileContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue(ct2);
                content.Add(fileContent, "files", $"prohlidka_{i + 1:D2}_{name}");
            }

            var url = $"api/listings/{Id}/upload-inspection-photos?provider=drive";
            var response = await Http.PostAsync(url, content, _cts.Token);
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add($"‚úÖ {readFiles.Count} fotek nahr√°no na Google Drive!", Severity.Success);
                _driveInspectionFiles = [];
            }
            else
            {
                var err = await response.Content.ReadAsStringAsync(_cts.Token);
                Snackbar.Add($"Chyba p≈ôi nahr√°v√°n√≠: {response.StatusCode}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Chyba: {ex.Message}", Severity.Error);
        }
        finally
        {
            _uploadingDrivePhotos = false;
        }
    }

    private async Task UploadOneDriveInspectionPhotosAsync()
    {
        if (_oneDriveInspectionFiles is not { Count: > 0 }) return;
        if (_exportState?.OneDriveInspectionFolderId is null && _oneDriveResult?.InspectionFolderId is null)
        {
            Snackbar.Add("Nejprve exportujte inzer√°t na OneDrive.", Severity.Warning);
            return;
        }
        _uploadingOneDrivePhotos = true;
        StateHasChanged();
        try
        {
            var readFiles = new List<(string Name, byte[] Data, string Ct)>();
            foreach (var file in _oneDriveInspectionFiles)
            {
                try
                {
                    await using var stream = file.OpenReadStream(maxAllowedSize: 30 * 1024 * 1024, _cts.Token);
                    using var ms = new MemoryStream();
                    await stream.CopyToAsync(ms, _cts.Token);
                    var safeName = string.IsNullOrWhiteSpace(file.Name) ? $"foto_{readFiles.Count + 1}.jpg" : Path.GetFileName(file.Name);
                    var ct2 = string.IsNullOrWhiteSpace(file.ContentType) ? "image/jpeg" : file.ContentType;
                    readFiles.Add((safeName, ms.ToArray(), ct2));
                }
                catch (Exception ex)
                {
                    Snackbar.Add($"‚ö†Ô∏è Skipping {file.Name}: {ex.Message}", Severity.Warning);
                }
            }

            if (readFiles.Count == 0)
            {
                Snackbar.Add("Nepoda≈ôilo se naƒç√≠st ≈æ√°dn√Ω soubor.", Severity.Warning);
                return;
            }

            using var content = new MultipartFormDataContent();
            for (int i = 0; i < readFiles.Count; i++)
            {
                var (name, data, ct2) = readFiles[i];
                var fileContent = new ByteArrayContent(data);
                fileContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue(ct2);
                content.Add(fileContent, "files", $"prohlidka_{i + 1:D2}_{name}");
            }

            var url = $"api/listings/{Id}/upload-inspection-photos?provider=onedrive";
            var response = await Http.PostAsync(url, content, _cts.Token);
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add($"‚úÖ {readFiles.Count} fotek nahr√°no na OneDrive!", Severity.Success);
                _oneDriveInspectionFiles = [];
            }
            else
            {
                Snackbar.Add($"Chyba p≈ôi nahr√°v√°n√≠: {response.StatusCode}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Chyba: {ex.Message}", Severity.Error);
        }
        finally
        {
            _uploadingOneDrivePhotos = false;
        }
    }


    private static string GetPropertyTypeLabel(string? value)
    {
        if (string.IsNullOrWhiteSpace(value))
        {
            return "-";
        }

        return PropertyTypeLabels.TryGetValue(value, out var label) ? label : value;
    }

    private static string GetOfferTypeLabel(string? value)
    {
        if (string.IsNullOrWhiteSpace(value))
        {
            return "-";
        }

        return OfferTypeLabels.TryGetValue(value, out var label) ? label : value;
    }

    public void Dispose()
    {
        _cts.Cancel();
        _cts.Dispose();
    }

    // ‚îÄ‚îÄ‚îÄ RAG Chat ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    private record RagAnalysisInfo(Guid Id, string Source, bool HasEmbedding, string? Title);

    private async Task LoadRagAnalysesAsync()
    {
        try
        {
            var analyses = await Http.GetFromJsonAsync<List<RagAnalysisInfo>>(
                $"api/listings/{Id}/analyses", _cts.Token);
            if (analyses is not null)
            {
                _ragAnalysisCount = analyses.Count;
                _ragDescriptionEmbedded = analyses.Any(a => a.Source == "auto");
            }
        }
        catch { /* RAG status je optional */ }
    }

    private async Task EmbedDescriptionAsync()
    {
        _ragEmbedding = true;
        try
        {
            var resp = await Http.PostAsync($"api/listings/{Id}/embed-description", null, _cts.Token);
            if (resp.IsSuccessStatusCode)
            {
                _ragDescriptionEmbedded = true;
                _ragAnalysisCount++;
                Snackbar.Add("Popis inzer√°tu embedov√°n ‚Äì nyn√≠ se lze pt√°t!", Severity.Success);
            }
            else
            {
                var err = await resp.Content.ReadAsStringAsync();
                Snackbar.Add($"Embed selhal: {err}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Chyba: {ex.Message}", Severity.Error);
        }
        finally
        {
            _ragEmbedding = false;
        }
    }

    private async Task AskRagAsync()
    {
        if (string.IsNullOrWhiteSpace(_ragQuestion)) return;
        _ragLoading = true;
        _ragAnswer = null;
        _ragSources = [];
        try
        {
            var payload = new { question = _ragQuestion, topK = 5 };
            var resp = await Http.PostAsJsonAsync($"api/listings/{Id}/ask", payload, _cts.Token);
            if (resp.IsSuccessStatusCode)
            {
                var result = await resp.Content.ReadFromJsonAsync<RagAskResponse>(_cts.Token);
                if (result is not null)
                {
                    _ragAnswer = result.Answer;
                    _ragHasEmbeddings = result.HasEmbeddings;
                    _ragSources = result.Sources ?? [];
                }
            }
            else
            {
                _ragAnswer = $"Chyba API: {resp.StatusCode}";
                _ragHasEmbeddings = false;
            }
        }
        catch (Exception ex)
        {
            _ragAnswer = $"Chyba: {ex.Message}";
        }
        finally
        {
            _ragLoading = false;
        }
    }

}

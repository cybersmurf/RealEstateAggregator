@page "/listings/{id:guid}"
@implements IDisposable

@inject HttpClient Http
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    @if (_loading)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
        <MudText Typo="Typo.body1">Naƒç√≠t√°m...</MudText>
    }
    else if (_listing == null)
    {
        <MudAlert Severity="Severity.Error">Inzer√°t nenalezen.</MudAlert>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="@(() => Navigation.NavigateTo("/listings"))">
            Zpƒõt na seznam
        </MudButton>
    }
    else
    {
        <MudStack Spacing="3">
            <!-- Header -->
            <MudPaper Class="pa-4">
                <MudStack Spacing="2">
                    <MudText Typo="Typo.h4">@_listing.Title</MudText>
                    <MudStack Row="true" Spacing="2">
                        <MudChip T="string" Size="Size.Small" Color="Color.Primary">@_listing.SourceName</MudChip>
                        <MudChip T="string" Size="Size.Small" Color="Color.Secondary">@GetPropertyTypeLabel(_listing.PropertyType)</MudChip>
                        <MudChip T="string" Size="Size.Small" Color="Color.Info">@GetOfferTypeLabel(_listing.OfferType)</MudChip>
                    </MudStack>
                    <MudText Typo="Typo.h5" Color="Color.Success">
                        @(_listing.Price?.ToString("N0") ?? "Cena nen√≠ uvedena") Kƒç
                        @if (!string.IsNullOrWhiteSpace(_listing.PriceNote))
                        {
                            <MudText Typo="Typo.caption">(@_listing.PriceNote)</MudText>
                        }
                    </MudText>
                </MudStack>
            </MudPaper>

            <!-- Photo Carousel -->
            @if (_listing.Photos.Any())
            {
                <MudPaper Class="pa-4">
                    <MudCarousel TData="object" Style="height:400px;" ShowArrows="true" ShowBullets="true" EnableSwipeGesture="true" AutoCycle="false">
                        @foreach (var photo in _listing.Photos.OrderBy(p => p.Order))
                        {
                            var photoSrc = !string.IsNullOrEmpty(photo.StoredUrl) ? photo.StoredUrl : photo.OriginalUrl;
                            <MudCarouselItem>
                                <div class="d-flex justify-center align-center" style="height:100%">
                                    <img src="@photoSrc" alt="Foto"
                                         style="max-width:100%; max-height:100%; object-fit:contain;"
                                         onerror="this.style.display='none';this.nextElementSibling.style.display='flex'" />
                                    <div style="display:none; width:100%; height:100%; align-items:center; justify-content:center; color:#9e9e9e;">
                                        <span>üì∑ Foto nen√≠ k dispozici</span>
                                    </div>
                                </div>
                            </MudCarouselItem>
                        }
                    </MudCarousel>
                </MudPaper>
            }
            else
            {
                <MudAlert Severity="Severity.Info">≈Ω√°dn√© fotografie nejsou k dispozici.</MudAlert>
            }

            <!-- Details -->
            <MudPaper Class="pa-4">
                <MudText Typo="Typo.h6" Class="mb-3">Detaily</MudText>
                <MudSimpleTable Striped="true" Dense="true">
                    <tbody>
                        <tr>
                            <td><strong>Lokalita</strong></td>
                            <td>@_listing.LocationText</td>
                        </tr>
                        @if (!string.IsNullOrWhiteSpace(_listing.Municipality))
                        {
                            <tr>
                                <td><strong>Obec</strong></td>
                                <td>@_listing.Municipality</td>
                            </tr>
                        }
                        @if (!string.IsNullOrWhiteSpace(_listing.District))
                        {
                            <tr>
                                <td><strong>Okres</strong></td>
                                <td>@_listing.District</td>
                            </tr>
                        }
                        @if (!string.IsNullOrWhiteSpace(_listing.Region))
                        {
                            <tr>
                                <td><strong>Kraj</strong></td>
                                <td>@_listing.Region</td>
                            </tr>
                        }
                        @if (_listing.AreaBuiltUp.HasValue)
                        {
                            <tr>
                                <td><strong>Zastavƒõn√° plocha</strong></td>
                                <td>@_listing.AreaBuiltUp.Value.ToString("N0") m¬≤</td>
                            </tr>
                        }
                        @if (_listing.AreaLand.HasValue)
                        {
                            <tr>
                                <td><strong>Plocha pozemku</strong></td>
                                <td>@_listing.AreaLand.Value.ToString("N0") m¬≤</td>
                            </tr>
                        }
                        @if (_listing.Rooms.HasValue)
                        {
                            <tr>
                                <td><strong>Poƒçet pokoj≈Ø</strong></td>
                                <td>@_listing.Rooms.Value</td>
                            </tr>
                        }
                        @if (_listing.HasKitchen.HasValue)
                        {
                            <tr>
                                <td><strong>Kuchy≈à</strong></td>
                                <td>@(_listing.HasKitchen.Value ? "Ano" : "Ne")</td>
                            </tr>
                        }
                        @if (!string.IsNullOrWhiteSpace(_listing.ConstructionType))
                        {
                            <tr>
                                <td><strong>Konstrukce</strong></td>
                                <td>@_listing.ConstructionType</td>
                            </tr>
                        }
                        @if (!string.IsNullOrWhiteSpace(_listing.Condition))
                        {
                            <tr>
                                <td><strong>Stav</strong></td>
                                <td>@_listing.Condition</td>
                            </tr>
                        }
                        <tr>
                            <td><strong>Poprv√© vidƒõno</strong></td>
                            <td>@_listing.FirstSeenAt.ToString("dd.MM.yyyy HH:mm")</td>
                        </tr>
                        @if (_listing.LastSeenAt.HasValue)
                        {
                            <tr>
                                <td><strong>Naposledy vidƒõno</strong></td>
                                <td>@_listing.LastSeenAt.Value.ToString("dd.MM.yyyy HH:mm")</td>
                            </tr>
                        }
                        <tr>
                            <td><strong>URL</strong></td>
                            <td><MudLink Href="@_listing.SourceUrl" Target="_blank">Otev≈ô√≠t p≈Øvodn√≠ inzer√°t</MudLink></td>
                        </tr>
                    </tbody>
                </MudSimpleTable>
            </MudPaper>

            <!-- Description -->
            <MudPaper Class="pa-4">
                <MudText Typo="Typo.h6" Class="mb-3">Popis</MudText>
                <MudText Typo="Typo.body1" Style="white-space: pre-wrap;">@_listing.Description</MudText>
            </MudPaper>

            <!-- User State -->
            <MudPaper Class="pa-4">
                <MudText Typo="Typo.h6" Class="mb-3">M≈Øj stav</MudText>
                <MudStack Spacing="2">
                    <MudButtonGroup Variant="Variant.Outlined" Color="Color.Primary">
                        <MudButton OnClick="@(() => UpdateUserStatus("New"))" 
                                   Disabled="@(_userState.Status == "New")"
                                   Color="@(_userState.Status == "New" ? Color.Primary : Color.Default)">
                            Nov√©
                        </MudButton>
                        <MudButton OnClick="@(() => UpdateUserStatus("Liked"))" 
                                   Disabled="@(_userState.Status == "Liked")"
                                   Color="@(_userState.Status == "Liked" ? Color.Success : Color.Default)">
                            Zaj√≠mav√©
                        </MudButton>
                        <MudButton OnClick="@(() => UpdateUserStatus("Disliked"))" 
                                   Disabled="@(_userState.Status == "Disliked")"
                                   Color="@(_userState.Status == "Disliked" ? Color.Error : Color.Default)">
                            Nezaj√≠mav√©
                        </MudButton>
                        <MudButton OnClick="@(() => UpdateUserStatus("ToVisit"))" 
                                   Disabled="@(_userState.Status == "ToVisit")"
                                   Color="@(_userState.Status == "ToVisit" ? Color.Warning : Color.Default)">
                            K n√°v≈°tƒõvƒõ
                        </MudButton>
                        <MudButton OnClick="@(() => UpdateUserStatus("Visited"))" 
                                   Disabled="@(_userState.Status == "Visited")"
                                   Color="@(_userState.Status == "Visited" ? Color.Info : Color.Default)">
                            Nav≈°t√≠veno
                        </MudButton>
                    </MudButtonGroup>

                    <MudTextField @bind-Value="_userState.Notes" 
                                  Label="Pozn√°mky" 
                                  Lines="3" 
                                  Variant="Variant.Outlined"
                                  OnBlur="SaveNotesAsync" />

                    @if (_userState.LastUpdated.HasValue)
                    {
                        <MudText Typo="Typo.caption">
                            Naposledy upraveno: @_userState.LastUpdated.Value.ToString("dd.MM.yyyy HH:mm")
                        </MudText>
                    }
                </MudStack>
            </MudPaper>

            <!-- Actions -->
            <MudStack Spacing="2">
                <MudStack Row="true" Spacing="2" Wrap="Wrap.Wrap">
                    <MudButton Color="Color.Primary" 
                               Variant="Variant.Filled" 
                               OnClick="@(() => Navigation.NavigateTo("/listings"))">
                        Zpƒõt na seznam
                    </MudButton>
                    <MudButton Color="Color.Secondary" 
                               Variant="Variant.Filled" 
                               OnClick="CreateAnalysisAsync">
                        Vytvo≈ôit anal√Ωzu
                    </MudButton>
                    <MudButton Color="Color.Success"
                               Variant="Variant.Filled"
                               OnClick="ExportToDriveAsync"
                               Disabled="_driveExporting"
                               StartIcon="@Icons.Material.Filled.CloudUpload">
                        @if (_driveExporting)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            <span>Nahr√°v√°m na Drive‚Ä¶</span>
                        }
                        else
                        {
                            <span>Export na Google Drive</span>
                        }
                    </MudButton>
                </MudStack>

                @if (_driveResult is not null)
                {
                    <MudAlert Severity="Severity.Success" Dense="false">
                        <MudStack Spacing="1">
                            <MudText Typo="Typo.body1">
                                <strong>Slo≈æka p≈ôipraven√°:</strong> @_driveResult.FolderName
                            </MudText>
                            <MudText Typo="Typo.caption" Style="word-break:break-all">
                                @_driveResult.FolderUrl
                            </MudText>
                            <MudStack Row="true" Spacing="2">
                                <MudButton Variant="Variant.Filled" Size="Size.Small" Color="Color.Success"
                                           StartIcon="@Icons.Material.Filled.OpenInNew"
                                           Href="@_driveResult.FolderUrl" Target="_blank">
                                    Otev≈ô√≠t v Google Drive
                                </MudButton>
                                <MudButton Variant="Variant.Outlined" Size="Size.Small" Color="Color.Default"
                                           StartIcon="@Icons.Material.Filled.ContentCopy"
                                           OnClick="CopyDriveUrlAsync">
                                    Kop√≠rovat URL
                                </MudButton>
                            </MudStack>
                            <MudText Typo="Typo.caption" Color="Color.Success">
                                Slo≈æka obsahuje INFO.md, DATA.json, AI_INSTRUKCE.md a fotky ze scrapu.
                                Nahraj vlastn√≠ fotky z prohl√≠dky do podslo≈æky <strong>Moje_fotky_z_prohlidky</strong>.
                            </MudText>
                        </MudStack>
                    </MudAlert>
                }
            </MudStack>
        </MudStack>
    }
</MudContainer>

@code {
    [Parameter]
    public Guid Id { get; set; }

    private bool _loading = true;
    private ListingDetailDto? _listing;
    private ListingUserStateDto _userState = new();
    private CancellationTokenSource _cts = new();

    // Google Drive export
    private bool _driveExporting = false;
    private DriveExportResult? _driveResult;
    private record DriveExportResult(string FolderUrl, string FolderName, string FolderId);


    private static readonly IReadOnlyDictionary<string, string> PropertyTypeLabels =
        new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase)
        {
            ["House"] = "D≈Øm",
            ["Apartment"] = "Byt",
            ["Land"] = "Pozemek",
            ["Cottage"] = "Chata",
            ["Commercial"] = "Komerƒçn√≠",
            ["Other"] = "Ostatn√≠"
        };

    private static readonly IReadOnlyDictionary<string, string> OfferTypeLabels =
        new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase)
        {
            ["Sale"]    = "Prodej",
            ["Rent"]    = "Pron√°jem",
            ["Auction"] = "Dra≈æba"
        };

    protected override async Task OnInitializedAsync()
    {
        await LoadListingAsync();
    }

    private async Task LoadListingAsync()
    {
        _loading = true;
        try
        {
            _listing = await Http.GetFromJsonAsync<ListingDetailDto>($"api/listings/{Id}");
            if (_listing != null)
            {
                _userState = _listing.UserState ?? new();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Chyba p≈ôi naƒç√≠t√°n√≠: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task UpdateUserStatus(string status)
    {
        try
        {
            _userState.Status = status;
            _userState.LastUpdated = DateTime.Now;

            var request = new ListingUserStateUpdateDto
            {
                Status = _userState.Status,
                Notes = _userState.Notes
            };

            var response = await Http.PostAsJsonAsync($"api/listings/{Id}/state", request);
            if (response.IsSuccessStatusCode)
            {
                var updated = await response.Content.ReadFromJsonAsync<ListingUserStateDto>();
                if (updated is not null)
                {
                    _userState = updated;
                }
                Snackbar.Add("Stav ulo≈æen", Severity.Success);
            }
            else
            {
                Snackbar.Add("Chyba p≈ôi ukl√°d√°n√≠ stavu", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Chyba: {ex.Message}", Severity.Error);
        }
    }

    private async Task SaveNotesAsync()
    {
        try
        {
            _userState.LastUpdated = DateTime.Now;

            var request = new ListingUserStateUpdateDto
            {
                Status = _userState.Status,
                Notes = _userState.Notes
            };

            var response = await Http.PostAsJsonAsync($"api/listings/{Id}/state", request);
            if (response.IsSuccessStatusCode)
            {
                var updated = await response.Content.ReadFromJsonAsync<ListingUserStateDto>();
                if (updated is not null)
                {
                    _userState = updated;
                }
                Snackbar.Add("Pozn√°mky ulo≈æeny", Severity.Success);
            }
            else
            {
                Snackbar.Add("Chyba p≈ôi ukl√°d√°n√≠ pozn√°mek", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Chyba: {ex.Message}", Severity.Error);
        }
    }

    private async Task CreateAnalysisAsync()
    {
        try
        {
            var request = new AnalysisJobCreateDto
            {
                StorageProvider = "Local"
            };

            var response = await Http.PostAsJsonAsync($"api/analysis/listing/{Id}", request);
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Anal√Ωza byla vytvo≈ôena", Severity.Success);
            }
            else
            {
                Snackbar.Add("Chyba p≈ôi vytv√°≈ôen√≠ anal√Ωzy", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Chyba: {ex.Message}", Severity.Error);
        }
    }

    private async Task ExportToDriveAsync()
    {
        _driveExporting = true;
        _driveResult = null;
        StateHasChanged();
        try
        {
            var response = await Http.PostAsync($"api/listings/{Id}/export-drive", null, _cts.Token);
            if (response.IsSuccessStatusCode)
            {
                _driveResult = await response.Content.ReadFromJsonAsync<DriveExportResult>(_cts.Token);
                Snackbar.Add("Export na Google Drive byl √∫spƒõ≈°n√Ω!", Severity.Success);
            }
            else
            {
                var err = await response.Content.ReadAsStringAsync(_cts.Token);
                Snackbar.Add($"Chyba p≈ôi exportu: {response.StatusCode}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Chyba: {ex.Message}", Severity.Error);
        }
        finally
        {
            _driveExporting = false;
        }
    }

    private async Task CopyDriveUrlAsync()
    {
        if (_driveResult is null) return;
        try
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", _driveResult.FolderUrl);
            Snackbar.Add("URL zkop√≠rov√°no do schr√°nky", Severity.Info);
        }
        catch
        {
            Snackbar.Add(_driveResult.FolderUrl, Severity.Normal);
        }
    }


    private static string GetPropertyTypeLabel(string? value)
    {
        if (string.IsNullOrWhiteSpace(value))
        {
            return "-";
        }

        return PropertyTypeLabels.TryGetValue(value, out var label) ? label : value;
    }

    private static string GetOfferTypeLabel(string? value)
    {
        if (string.IsNullOrWhiteSpace(value))
        {
            return "-";
        }

        return OfferTypeLabels.TryGetValue(value, out var label) ? label : value;
    }

    public void Dispose()
    {
        _cts.Cancel();
        _cts.Dispose();
    }

}

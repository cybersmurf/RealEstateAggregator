@page "/listings/{id:guid}"
@implements IDisposable
@using System.Text.Json

@inject HttpClient Http
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    @if (_loading)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
        <MudText Typo="Typo.body1">Naƒç√≠t√°m...</MudText>
    }
    else if (_listing == null)
    {
        <MudAlert Severity="Severity.Error">Inzer√°t nenalezen.</MudAlert>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="@(() => Navigation.NavigateTo("/listings"))">
            Zpƒõt na seznam
        </MudButton>
    }
    else
    {
        <MudStack Spacing="3">
            <!-- Header -->
            <MudPaper Class="pa-4">
                <MudStack Spacing="2">
                    <MudText Typo="Typo.h4">@_listing.Title</MudText>
                    <MudStack Row="true" Spacing="2">
                        <MudChip T="string" Size="Size.Small" Color="Color.Primary">@_listing.SourceName</MudChip>
                        <MudChip T="string" Size="Size.Small" Color="Color.Secondary">@GetPropertyTypeLabel(_listing.PropertyType)</MudChip>
                        <MudChip T="string" Size="Size.Small" Color="Color.Info">@GetOfferTypeLabel(_listing.OfferType)</MudChip>
                    </MudStack>
                    <MudText Typo="Typo.h5" Color="Color.Success">
                        @(_listing.Price?.ToString("N0") ?? "Cena nen√≠ uvedena") Kƒç
                        @if (!string.IsNullOrWhiteSpace(_listing.PriceNote))
                        {
                            <MudText Typo="Typo.caption">(@_listing.PriceNote)</MudText>
                        }
                    </MudText>
                </MudStack>
            </MudPaper>

            <!-- Photo Carousel -->
            @if (_listing.Photos.Any())
            {
                <MudPaper Class="pa-4">
                    <MudCarousel TData="object" Style="height:400px;" ShowArrows="true" ShowBullets="true" EnableSwipeGesture="true" AutoCycle="false">
                        @foreach (var photo in _listing.Photos.OrderBy(p => p.Order))
                        {
                            var photoSrc = !string.IsNullOrEmpty(photo.StoredUrl) ? photo.StoredUrl : photo.OriginalUrl;
                            <MudCarouselItem>
                                <div class="d-flex justify-center align-center" style="height:100%">
                                    <img src="@photoSrc" alt="Foto"
                                         style="max-width:100%; max-height:100%; object-fit:contain;"
                                         onerror="this.style.display='none';this.nextElementSibling.style.display='flex'" />
                                    <div style="display:none; width:100%; height:100%; align-items:center; justify-content:center; color:#9e9e9e;">
                                        <span>üì∑ Foto nen√≠ k dispozici</span>
                                    </div>
                                </div>
                            </MudCarouselItem>
                        }
                    </MudCarousel>
                </MudPaper>
            }
            else
            {
                <MudAlert Severity="Severity.Info">≈Ω√°dn√© fotografie nejsou k dispozici.</MudAlert>
            }

            <!-- AI Klasifikace fotek -->
            @if (_listing.Photos.Any())
            {
                <MudPaper Class="pa-4">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-3" Wrap="Wrap.Wrap">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Wrap="Wrap.Wrap">
                            <MudText Typo="Typo.h6">üì∏ AI klasifikace fotek</MudText>
                            <MudChip T="string" Size="Size.Small"
                                     Color="@(PhotoClassifiedCount == _listing.Photos.Count ? Color.Success : Color.Default)">
                                @PhotoClassifiedCount/@_listing.Photos.Count klasifikov√°no
                            </MudChip>
                            @if (PhotoDamageCount > 0)
                            {
                                <MudChip T="string" Size="Size.Small" Color="Color.Error"
                                         Icon="@Icons.Material.Filled.Warning">
                                    @PhotoDamageCount po≈°kozen√≠
                                </MudChip>
                            }
                            @if (PhotoFeedbackWrongCount > 0)
                            {
                                <MudChip T="string" Size="Size.Small" Color="Color.Warning"
                                         Icon="@Icons.Material.Filled.ThumbDown">
                                    @PhotoFeedbackWrongCount ≈°patnƒõ
                                </MudChip>
                            }
                        </MudStack>
                        @if (PhotoClassifiedCount < _listing.Photos.Count)
                        {
                            <MudButton Variant="Variant.Outlined" Size="Size.Small" Color="Color.Secondary"
                                       StartIcon="@Icons.Material.Filled.AutoFixHigh"
                                       OnClick="TriggerPhotoClassificationAsync"
                                       Disabled="_classifyLoading">
                                @(_classifyLoading ? "Klasifikuji‚Ä¶" : $"Klasifikovat ({_listing.Photos.Count - PhotoClassifiedCount} nehotov√Ωch)")
                            </MudButton>
                        }
                        @if (PhotoClassifiedCount > 0)
                        {
                            <MudButton Variant="Variant.Outlined" Size="Size.Small" Color="Color.Info"
                                       StartIcon="@Icons.Material.Filled.Sort"
                                       OnClick="SortPhotosByCategoryAsync"
                                       Disabled="_sortLoading">
                                @(_sortLoading ? "≈òad√≠m‚Ä¶" : "Se≈ôadit dle kategorie")
                            </MudButton>
                            <MudButton Variant="Variant.Outlined" Size="Size.Small" Color="Color.Default"
                                       StartIcon="@Icons.Material.Filled.Accessibility"
                                       OnClick="TriggerAltTextAsync"
                                       Disabled="_altTextLoading">
                                @(_altTextLoading ? "Generuji alt text‚Ä¶" : $"Alt text ({_listing.Photos.Count(p => string.IsNullOrEmpty(p.AltText))} chyb√≠)")
                            </MudButton>
                        }
                    </MudStack>

                    <MudGrid Spacing="2">
                        @{ int _photoIdx = 0; }
                        @foreach (var photo in _listing.Photos.OrderBy(p => p.Order))
                        {
                            var pSrc = !string.IsNullOrEmpty(photo.StoredUrl) ? photo.StoredUrl : photo.OriginalUrl;
                            var fb   = _photoFeedbacks.GetValueOrDefault(photo.Id);
                            var borderStyle = photo.DamageDetected
                                ? "border: 2px solid var(--mud-palette-error);"
                                : fb == "wrong"
                                    ? "border: 2px solid var(--mud-palette-warning);"
                                    : fb == "correct"
                                        ? "border: 2px solid var(--mud-palette-success);"
                                        : "";
                            var _capturedIdx = _photoIdx++;
                            <MudItem xs="12" sm="6" md="4" lg="3">
                                <MudCard Outlined="true" Style="@borderStyle">
                                    <!-- N√°hled fotky s p≈ôekrytn√Ωmi odznaky -->
                                    <button type="button"
                                            @onclick="() => OpenLightbox(_capturedIdx)"
                                            style="display:block;position:relative;height:150px;overflow:hidden;background:#111;width:100%;padding:0;border:none;cursor:zoom-in;"
                                            aria-label="Zobrazit fotku v pln√©m rozli≈°en√≠">
                                        <img src="@pSrc" alt="@(!string.IsNullOrEmpty(photo.AltText) ? photo.AltText : GetCategoryLabel(photo.PhotoCategory))"
                                             style="width:100%;height:150px;object-fit:cover;"
                                             onerror="this.style.opacity='0.15'" />
                                        @if (photo.DamageDetected)
                                        {
                                            <div style="position:absolute;top:4px;left:4px;background:rgba(211,47,47,.9);color:#fff;border-radius:12px;padding:2px 8px;font-size:10px;font-weight:600;">
                                                ‚ö† Po≈°kozen√≠
                                            </div>
                                        }
                                        @if (photo.IsClassified)
                                        {
                                            <div style="position:absolute;top:4px;right:4px;background:rgba(0,0,0,.65);color:#fff;border-radius:12px;padding:2px 8px;font-size:10px;font-weight:600;">
                                                @GetCategoryLabel(photo.PhotoCategory)
                                            </div>
                                        }
                                        else
                                        {
                                            <div style="position:absolute;bottom:4px;right:4px;background:rgba(0,0,0,.5);color:#aaa;border-radius:12px;padding:2px 6px;font-size:9px;">
                                                neklasifikov√°no
                                            </div>
                                        }
                                    </button>

                                    @if (photo.IsClassified)
                                    {
                                        <MudCardContent Class="pa-2">
                                            <!-- Confidence progress bar -->
                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Class="mb-1">
                                                <MudProgressLinear
                                                    Value="@((double)(photo.ClassificationConfidence ?? 0) * 100)"
                                                    Color="@GetConfidenceColor(photo.ClassificationConfidence)"
                                                    Style="flex:1;" Size="Size.Small" Rounded="true" />
                                                <MudText Typo="Typo.caption" Style="white-space:nowrap;min-width:28px;text-align:right;">
                                                    @($"{(photo.ClassificationConfidence ?? 0) * 100:0}%")
                                                </MudText>
                                            </MudStack>

                                            <!-- AI popis (2 ≈ô√°dky, tooltip pro pln√Ω text) -->
                                            @if (!string.IsNullOrEmpty(photo.PhotoDescription))
                                            {
                                                <MudTooltip Text="@photo.PhotoDescription" Placement="Placement.Bottom">
                                                    <MudText Typo="Typo.caption" Class="mud-text-secondary"
                                                             Style="overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;line-height:1.3em;cursor:help;">
                                                        @photo.PhotoDescription
                                                    </MudText>
                                                </MudTooltip>
                                            }

                                            <!-- ≈†t√≠tky (labels) -->
                                            @{var lbls = GetPhotoLabels(photo.PhotoLabels);}
                                            @if (lbls.Count > 0)
                                            {
                                                <div class="mt-1 d-flex flex-wrap" style="gap:2px;">
                                                    @foreach (var lbl in lbls)
                                                    {
                                                        var isDanger = lbl is "mold" or "water_damage" or "crack" or "damaged_roof" or "broken_windows";
                                                        <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined"
                                                                 Color="@(isDanger ? Color.Error : Color.Default)"
                                                                 Style="height:18px;font-size:9px;margin:1px;padding:0 6px;">
                                                            @TranslateLabel(lbl)
                                                        </MudChip>
                                                    }
                                                </div>
                                            }
                                        </MudCardContent>

                                        <!-- Feedback tlaƒç√≠tka -->
                                        <MudCardActions Class="pa-1 d-flex justify-space-between align-center">
                                            <MudText Typo="Typo.caption" Class="mud-text-disabled" Style="font-size:9px;padding-left:4px;">
                                                @(fb == "correct" ? "‚úì Spr√°vnƒõ" : fb == "wrong" ? "‚úó ≈†patnƒõ" : "Ohodnotit")
                                            </MudText>
                                            <div style="display:flex;gap:0;">
                                                <MudTooltip Text="Klasifikace sed√≠">
                                                    <MudIconButton Icon="@Icons.Material.Filled.ThumbUp" Size="Size.Small"
                                                                   Color="@(fb == "correct" ? Color.Success : Color.Default)"
                                                                   OnClick="() => ToggleCorrectFeedbackAsync(photo.Id)"
                                                                   aria-label="Klasifikace sed√≠" />
                                                </MudTooltip>
                                                <MudTooltip Text="≈†patn√° kategorie">
                                                    <MudIconButton Icon="@Icons.Material.Filled.ThumbDown" Size="Size.Small"
                                                                   Color="@(fb == "wrong" ? Color.Error : Color.Default)"
                                                                   OnClick="() => ToggleWrongFeedbackAsync(photo.Id)"
                                                                   aria-label="≈†patn√° kategorie" />
                                                </MudTooltip>
                                            </div>
                                        </MudCardActions>
                                    }
                                </MudCard>
                            </MudItem>
                        }
                    </MudGrid>
                </MudPaper>
            }

            <!-- Details -->
            <MudPaper Class="pa-4">
                <MudText Typo="Typo.h6" Class="mb-3">Detaily</MudText>
                <MudSimpleTable Striped="true" Dense="true">
                    <tbody>
                        <tr>
                            <td><strong>Lokalita</strong></td>
                            <td>@_listing.LocationText</td>
                        </tr>
                        @if (!string.IsNullOrWhiteSpace(_listing.Municipality))
                        {
                            <tr>
                                <td><strong>Obec</strong></td>
                                <td>@_listing.Municipality</td>
                            </tr>
                        }
                        @if (!string.IsNullOrWhiteSpace(_listing.District))
                        {
                            <tr>
                                <td><strong>Okres</strong></td>
                                <td>@_listing.District</td>
                            </tr>
                        }
                        @if (!string.IsNullOrWhiteSpace(_listing.Region))
                        {
                            <tr>
                                <td><strong>Kraj</strong></td>
                                <td>@_listing.Region</td>
                            </tr>
                        }
                        @if (_listing.AreaBuiltUp.HasValue)
                        {
                            <tr>
                                <td><strong>Zastavƒõn√° plocha</strong></td>
                                <td>@_listing.AreaBuiltUp.Value.ToString("N0") m¬≤</td>
                            </tr>
                        }
                        @if (_listing.AreaLand.HasValue)
                        {
                            <tr>
                                <td><strong>Plocha pozemku</strong></td>
                                <td>@_listing.AreaLand.Value.ToString("N0") m¬≤</td>
                            </tr>
                        }
                        @if (_listing.Rooms.HasValue)
                        {
                            <tr>
                                <td><strong>Poƒçet pokoj≈Ø</strong></td>
                                <td>@_listing.Rooms.Value</td>
                            </tr>
                        }
                        @if (_listing.HasKitchen.HasValue)
                        {
                            <tr>
                                <td><strong>Kuchy≈à</strong></td>
                                <td>@(_listing.HasKitchen.Value ? "Ano" : "Ne")</td>
                            </tr>
                        }
                        @if (!string.IsNullOrWhiteSpace(_listing.ConstructionType))
                        {
                            <tr>
                                <td><strong>Konstrukce</strong></td>
                                <td>@_listing.ConstructionType</td>
                            </tr>
                        }
                        @if (!string.IsNullOrWhiteSpace(_listing.Condition))
                        {
                            <tr>
                                <td><strong>Stav</strong></td>
                                <td>@_listing.Condition</td>
                            </tr>
                        }
                        <tr>
                            <td><strong>Poprv√© vidƒõno</strong></td>
                            <td>@_listing.FirstSeenAt.ToString("dd.MM.yyyy HH:mm")</td>
                        </tr>
                        @if (_listing.LastSeenAt.HasValue)
                        {
                            <tr>
                                <td><strong>Naposledy vidƒõno</strong></td>
                                <td>@_listing.LastSeenAt.Value.ToString("dd.MM.yyyy HH:mm")</td>
                            </tr>
                        }
                        <tr>
                            <td><strong>URL</strong></td>
                            <td><MudLink Href="@_listing.SourceUrl" Target="_blank">Otev≈ô√≠t p≈Øvodn√≠ inzer√°t</MudLink></td>
                        </tr>
                    </tbody>
                </MudSimpleTable>
            </MudPaper>

            <!-- Description -->
            <MudPaper Class="pa-4">
                <MudText Typo="Typo.h6" Class="mb-3">Popis</MudText>
                <MudText Typo="Typo.body1" Style="white-space: pre-wrap;">@_listing.Description</MudText>
            </MudPaper>

            <!-- Ollama AI insights: Smart Tags + Price Signal + Normalized Data -->
            @if (!string.IsNullOrEmpty(_listing.SmartTags)
                || !string.IsNullOrEmpty(_listing.PriceSignal)
                || !string.IsNullOrEmpty(_listing.AiNormalizedData))
            {
                <MudPaper Class="pa-4">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-3">
                        <MudIcon Icon="@Icons.Material.Filled.AutoAwesome" Color="Color.Secondary" />
                        <MudText Typo="Typo.h6">AI anal√Ωza</MudText>
                    </MudStack>

                    @if (!string.IsNullOrEmpty(_listing.PriceSignal))
                    {
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-2">
                            <MudText Typo="Typo.subtitle2">Cenov√Ω sign√°l:</MudText>
                            <MudChip T="string"
                                     Color="@(_listing.PriceSignal == "low" ? Color.Success : _listing.PriceSignal == "high" ? Color.Error : Color.Warning)"
                                     Icon="@(_listing.PriceSignal == "low" ? Icons.Material.Filled.TrendingDown : _listing.PriceSignal == "high" ? Icons.Material.Filled.TrendingUp : Icons.Material.Filled.TrendingFlat)"
                                     Size="Size.Small">
                                @(_listing.PriceSignal == "low" ? "Podhodnocen√°" : _listing.PriceSignal == "high" ? "Nadhodnocen√°" : "P≈ôimƒõ≈ôen√°")
                            </MudChip>
                        </MudStack>
                        @if (!string.IsNullOrEmpty(_listing.PriceSignalReason))
                        {
                            <MudText Typo="Typo.caption" Class="mud-text-secondary mb-3">@_listing.PriceSignalReason</MudText>
                        }
                    }

                    @if (!string.IsNullOrEmpty(_listing.SmartTags))
                    {
                        var tags = TryParseStringArray(_listing.SmartTags);
                        @if (tags.Count > 0)
                        {
                            <MudStack Row="true" Wrap="Wrap.Wrap" Spacing="1" Class="mb-3" AlignItems="AlignItems.Center">
                                <MudText Typo="Typo.subtitle2" Class="mr-1">Tagy:</MudText>
                                @foreach (var tag in tags)
                                {
                                    <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined" Color="Color.Secondary">@tag</MudChip>
                                }
                            </MudStack>
                        }
                    }

                    @if (!string.IsNullOrEmpty(_listing.AiNormalizedData))
                    {
                        var norm = TryParseNormalizedData(_listing.AiNormalizedData);
                        @if (norm.Count > 0)
                        {
                            <MudSimpleTable Dense="true" Hover="true" Striped="true" Style="font-size:0.82rem;">
                                <tbody>
                                    @foreach (var kv in norm)
                                    {
                                        <tr>
                                            <td style="width:45%;color:var(--mud-palette-text-secondary)">@kv.Key</td>
                                            <td>@kv.Value</td>
                                        </tr>
                                    }
                                </tbody>
                            </MudSimpleTable>
                        }
                    }

                    <!-- Akce: generovat data -->
                    <MudStack Row="true" Spacing="1" Class="mt-3" Wrap="Wrap.Wrap">
                        <MudButton Variant="Variant.Text" Size="Size.Small" Color="Color.Secondary"
                                   StartIcon="@Icons.Material.Filled.Label"
                                   OnClick="TriggerSmartTagsAsync"
                                   Disabled="_aiTextLoading">
                            @(_aiTextLoading ? "‚Ä¶" : string.IsNullOrEmpty(_listing.SmartTags) ? "Generovat tagy" : "P≈ôegenerovat tagy")
                        </MudButton>
                        <MudButton Variant="Variant.Text" Size="Size.Small" Color="Color.Secondary"
                                   StartIcon="@Icons.Material.Filled.PriceCheck"
                                   OnClick="TriggerPriceOpinionAsync"
                                   Disabled="_aiTextLoading">
                            @(_aiTextLoading ? "‚Ä¶" : string.IsNullOrEmpty(_listing.PriceSignal) ? "Cenov√Ω sign√°l" : "P≈ôepoƒç√≠tat cenu")
                        </MudButton>
                        <MudButton Variant="Variant.Text" Size="Size.Small" Color="Color.Secondary"
                                   StartIcon="@Icons.Material.Filled.DataObject"
                                   OnClick="TriggerNormalizeAsync"
                                   Disabled="_aiTextLoading">
                            @(_aiTextLoading ? "‚Ä¶" : string.IsNullOrEmpty(_listing.AiNormalizedData) ? "Normalizovat popis" : "P≈ôenormalizovat")
                        </MudButton>
                    </MudStack>
                </MudPaper>
            }
            @if (string.IsNullOrEmpty(_listing.SmartTags)
                && string.IsNullOrEmpty(_listing.PriceSignal)
                && string.IsNullOrEmpty(_listing.AiNormalizedData))
            {
                <MudPaper Class="pa-3">
                    <MudStack Row="true" Spacing="1" Wrap="Wrap.Wrap" AlignItems="AlignItems.Center">
                        <MudIcon Icon="@Icons.Material.Filled.AutoAwesome" Color="Color.Secondary" Size="Size.Small" />
                        <MudText Typo="Typo.subtitle2" Class="mr-2">AI anal√Ωza:</MudText>
                        <MudButton Variant="Variant.Outlined" Size="Size.Small" Color="Color.Secondary"
                                   StartIcon="@Icons.Material.Filled.Label"
                                   OnClick="TriggerSmartTagsAsync"
                                   Disabled="_aiTextLoading">Tagy</MudButton>
                        <MudButton Variant="Variant.Outlined" Size="Size.Small" Color="Color.Secondary"
                                   StartIcon="@Icons.Material.Filled.PriceCheck"
                                   OnClick="TriggerPriceOpinionAsync"
                                   Disabled="_aiTextLoading">Cenov√Ω sign√°l</MudButton>
                        <MudButton Variant="Variant.Outlined" Size="Size.Small" Color="Color.Secondary"
                                   StartIcon="@Icons.Material.Filled.DataObject"
                                   OnClick="TriggerNormalizeAsync"
                                   Disabled="_aiTextLoading">Normalizovat popis</MudButton>
                    </MudStack>
                </MudPaper>
            }

            <!-- Katastr nemovitosti -->
            <MudPaper Class="pa-4">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.AccountBalance" Color="Color.Info" />
                    <MudText Typo="Typo.h6">Katastr nemovitosti</MudText>
                    @if (_cadastreData?.FetchStatus == "found")
                    {
                        <MudChip T="string" Color="Color.Success" Size="Size.Small"
                                 Icon="@Icons.Material.Filled.CheckCircle">
                            RUIAN @_cadastreData.RuianKod
                        </MudChip>
                    }
                </MudStack>

                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-2">
                    Adresa pro vyhledavani: <strong>@_listing.LocationText</strong>
                </MudText>

                @if (_ocrParsed is not null)
                {
                    <!-- Srovn√°n√≠ inzer√°t vs KN (data z OCR) -->
                    <MudText Typo="Typo.subtitle2" Class="mb-2">üìä Inzer√°t vs. Katastr:</MudText>
                    <MudSimpleTable Dense="true" Class="mb-3" Style="font-size:0.85em">
                        <tbody>
                            @{
                                var _knArea    = _ocrParsed.LandAreaM2;
                                var _listArea  = _listing.AreaLand.HasValue ? (int?)((int)_listing.AreaLand.Value) : null;
                                bool? _areaOk  = _knArea.HasValue && _listArea.HasValue
                                    ? Math.Abs(_knArea.Value - _listArea.Value) / (double)Math.Max(1, _listArea.Value) < 0.05
                                    : null;
                                var _encLines  = ParseEncumbrances(_ocrParsed.EncumbrancesJson).ToList();
                            }
                            <tr>
                                <td>@(_areaOk == true ? "‚úÖ" : _areaOk == false ? "‚ö†Ô∏è" : "üìê")</td>
                                <td><strong>V√Ωmƒõra pozemku</strong></td>
                                <td>
                                    inzer√°t: <strong>@(_listArea.HasValue ? _listArea.Value.ToString("N0") + " m¬≤" : "nezad√°no")</strong>
                                    &nbsp;‚Üí&nbsp;
                                    KN: <strong style="color:@(_areaOk == false ? "#d32f2f" : _areaOk == true ? "#2e7d32" : "inherit")">@(_knArea.HasValue ? _knArea.Value.ToString("N0") + " m¬≤" : "?")</strong>
                                    @if (_areaOk == false && _listArea.HasValue && _knArea.HasValue)
                                    {
                                        <span style="color:#d32f2f"> (rozd√≠l @(Math.Abs(_knArea.Value - _listArea.Value)) m¬≤)</span>
                                    }
                                </td>
                            </tr>
                            @if (!string.IsNullOrWhiteSpace(_ocrParsed.LandType))
                            {
                                <tr>
                                    <td>üè∑Ô∏è</td>
                                    <td><strong>Druh pozemku v KN</strong></td>
                                    <td>@_ocrParsed.LandType</td>
                                </tr>
                            }
                            @if (!string.IsNullOrWhiteSpace(_ocrParsed.ParcelNumber))
                            {
                                <tr>
                                    <td>üìå</td>
                                    <td><strong>Parceln√≠ ƒç√≠slo</strong></td>
                                    <td>@_ocrParsed.ParcelNumber</td>
                                </tr>
                            }
                            @if (!string.IsNullOrWhiteSpace(_ocrParsed.LvNumber))
                            {
                                <tr>
                                    <td>üìÑ</td>
                                    <td><strong>List vlastnictv√≠ (LV)</strong></td>
                                    <td>@_ocrParsed.LvNumber</td>
                                </tr>
                            }
                            <tr>
                                <td>@(_encLines.Count == 0 ? "‚úÖ" : "üî¥")</td>
                                <td><strong>Omezen√≠ vlastnick√©ho pr√°va</strong></td>
                                <td>
                                    @if (_encLines.Count == 0)
                                    {
                                        <span style="color:#2e7d32">V KN ≈æ√°dn√° omezen√≠ nenalezena</span>
                                    }
                                    else
                                    {
                                        @foreach (var _enc in _encLines)
                                        {
                                            <div>‚Ä¢ @_enc</div>
                                        }
                                    }
                                </td>
                            </tr>
                        </tbody>
                    </MudSimpleTable>
                }
                else
                {
                    <MudText Typo="Typo.subtitle2" Class="mb-1">Co zkontrolovat v KN:</MudText>
                    <MudSimpleTable Dense="true" Class="mb-3" Style="font-size:0.85em">
                        <tbody>
                            <tr>
                                <td>&#x1F534;</td>
                                <td><strong>Zastavni prava</strong></td>
                                <td>Hypoteky a exekuce na listu vlastnictvi (LV)</td>
                            </tr>
                            <tr>
                                <td>&#x1F7E1;</td>
                                <td><strong>Vecna bremena</strong></td>
                                <td>Pravo pruchodu, vedeni siti, uzivani treti osobou</td>
                            </tr>
                            <tr>
                                <td>&#x26A0;&#xFE0F;</td>
                                <td><strong>Vymera pozemku</strong></td>
                                <td>Overit vs. @(_listing.AreaLand.HasValue ? _listing.AreaLand.Value.ToString("N0") + " m¬≤" : "?") z inzeratu</td>
                            </tr>
                            <tr>
                                <td>&#x26A0;&#xFE0F;</td>
                                <td><strong>Druh pozemku</strong></td>
                                <td>Zastavena plocha / zahrada / orna puda</td>
                            </tr>
                            <tr>
                                <td>&#x26A0;&#xFE0F;</td>
                                <td><strong>Pristupova cesta</strong></td>
                                <td>Na cizim pozemku nebo vecne bremeno?</td>
                            </tr>
                        </tbody>
                    </MudSimpleTable>
                }

                <MudStack Row="true" Spacing="2" Wrap="Wrap.Wrap" AlignItems="AlignItems.Center">
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Info"
                               StartIcon="@Icons.Material.Filled.OpenInNew"
                               Href="@GetCadastreUrl()"
                               Target="_blank">
                        Otevrit v KN
                    </MudButton>
                    @if (_cadastreData?.FetchStatus != "found")
                    {
                        <MudTooltip Text="Nacte primy odkaz na nahlizenidokn.cuzk.cz">
                            <MudButton Variant="Variant.Outlined"
                                       Color="Color.Default"
                                       Size="Size.Small"
                                       StartIcon="@Icons.Material.Filled.LocationOn"
                                       OnClick="FetchRuianAsync"
                                       Disabled="_cadastreLoading">
                                @if (_cadastreLoading)
                                {
                                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-1" />
                                    <span>Hledam...</span>
                                }
                                else
                                {
                                    <span>Najit primy odkaz (RUIAN)</span>
                                }
                            </MudButton>
                        </MudTooltip>
                    }
                    @if (_cadastreData?.FetchStatus == "not_found")
                    {
                        <MudText Typo="Typo.caption" Color="Color.Warning">Adresa v RUIAN nenalezena</MudText>
                    }
                </MudStack>

                <!-- ‚îÄ‚îÄ OCR screenshot z nahl√≠≈æen√≠dokn ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
                <MudDivider Class="my-3" />
                <MudText Typo="Typo.subtitle2" Class="mb-2">
                    @(_ocrParsed is not null ? "üîÑ Aktualizovat OCR" : "üìã OCR ze screenshotu (nahl√≠≈æen√≠dokn.cuzk.cz)")
                </MudText>

                @if (_ocrParsed is not null)
                {
                    <!-- Extrahovan√° KN data z OCR -->
                    <MudAlert Severity="Severity.Success" Dense="true" Class="mb-2">
                        OCR zpracov√°no. Extrahovan√° data:
                    </MudAlert>
                    <MudSimpleTable Dense="true" Class="mb-3" Style="font-size:0.85em">
                        <tbody>
                            @if (!string.IsNullOrWhiteSpace(_ocrParsed.ParcelNumber))
                            {
                                <tr><td>üìå Parceln√≠ ƒç√≠slo</td><td><strong>@_ocrParsed.ParcelNumber</strong></td></tr>
                            }
                            @if (!string.IsNullOrWhiteSpace(_ocrParsed.LvNumber))
                            {
                                <tr><td>üìÑ ƒå√≠slo LV</td><td><strong>@_ocrParsed.LvNumber</strong></td></tr>
                            }
                            @if (_ocrParsed.LandAreaM2.HasValue)
                            {
                                <tr><td>üìê V√Ωmƒõra</td><td><strong>@_ocrParsed.LandAreaM2.Value.ToString("N0") m¬≤</strong></td></tr>
                            }
                            @if (!string.IsNullOrWhiteSpace(_ocrParsed.LandType))
                            {
                                <tr><td>üè∑Ô∏è Druh pozemku</td><td>@_ocrParsed.LandType</td></tr>
                            }
                            @if (!string.IsNullOrWhiteSpace(_ocrParsed.OwnerType))
                            {
                                <tr><td>üë§ Vlastn√≠k</td><td>@_ocrParsed.OwnerType</td></tr>
                            }
                        </tbody>
                    </MudSimpleTable>
                    @if (!string.IsNullOrWhiteSpace(_ocrParsed.EncumbrancesJson) && _ocrParsed.EncumbrancesJson != "[]")
                    {
                        <MudAlert Severity="Severity.Warning" Dense="true" Class="mb-2">
                            ‚ö†Ô∏è Omezen√≠ vlastnick√©ho pr√°va:
                        </MudAlert>
                        @foreach (var encLine in ParseEncumbrances(_ocrParsed.EncumbrancesJson))
                        {
                            <MudText Typo="Typo.body2">‚Ä¢ @encLine</MudText>
                        }
                    }
                    else if (_ocrParsed is not null)
                    {
                        <MudChip T="string" Color="Color.Success" Size="Size.Small" Icon="@Icons.Material.Filled.CheckCircle">
                            Bez zjevn√Ωch omezen√≠
                        </MudChip>
                    }
                }
                @if (!string.IsNullOrEmpty(_ocrPreviewSrc))
                {
                    <img src="@_ocrPreviewSrc" alt="N√°hled screenshotu KN"
                         style="max-width:100%; max-height:300px; object-fit:contain; border:1px solid #e0e0e0; border-radius:4px; margin-bottom:8px;" />
                }

                <!-- Drop zone: paste Ctrl+V nebo p≈ôet√°hni soubor -->
                <div id="kn-ocr-dropzone"
                     class="kn-ocr-dropzone @(_ocrDragging ? "kn-ocr-dragover" : "")"
                     style="border:2px dashed @(_ocrDragging ? "#1976d2" : "#bdbdbd"); border-radius:8px; padding:20px; text-align:center; cursor:pointer; background:@(_ocrDragging ? "#e3f2fd" : "transparent"); transition:all 0.2s;"
                     aria-label="Z√≥na pro vlo≈æen√≠ screenshotu z katastru. Stisknƒõte Ctrl+V nebo p≈ôet√°hnƒõte soubor.">
                    @if (_ocrLoading)
                    {
                        <MudProgressCircular Indeterminate="true" Size="Size.Small" Class="mr-2" />
                        <MudText Typo="Typo.body2" Color="Color.Primary">Zpracov√°v√°m screenshot p≈ôes Ollama Vision...</MudText>
                    }
                    else
                    {
                        <MudIcon Icon="@Icons.Material.Outlined.ContentPaste" Style="font-size:2rem; color:#9e9e9e;" aria-hidden="true" />
                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                            Vlo≈æ screenshot pomoc√≠ <strong>Ctrl+V</strong> nebo p≈ôet√°hni soubor sem
                        </MudText>
                        <MudText Typo="Typo.caption" Color="Color.Tertiary">
                            ( otev≈ôi nahl√≠≈æen√≠dokn.cuzk.cz, vyhledej parcelu, po≈ôiƒè PrintScreen, sem Ctrl+V )
                        </MudText>
                    }
                </div>

                <MudStack Row="true" Spacing="2" Class="mt-2" AlignItems="AlignItems.Center" Wrap="Wrap.Wrap">
                    <MudFileUpload T="IBrowserFile"
                                   Accept="image/*"
                                   FilesChanged="HandleOcrFileUpload"
                                   MaximumFileCount="1"
                                   Disabled="_ocrLoading">
                        <ActivatorContent>
                            <MudButton Variant="Variant.Outlined"
                                       Size="Size.Small"
                                       StartIcon="@Icons.Material.Filled.Upload"
                                       Disabled="_ocrLoading">
                                Nahr√°t soubor
                            </MudButton>
                        </ActivatorContent>
                    </MudFileUpload>
                    @if (_ocrParsed is not null)
                    {
                        <MudButton Size="Size.Small"
                                   Variant="Variant.Text"
                                   Color="Color.Default"
                                   OnClick="@(() => { _ocrData = null; _ocrParsed = null; _ocrPreviewSrc = null; StateHasChanged(); })">
                            Vymazat OCR v√Ωsledek
                        </MudButton>
                    }
                </MudStack>
            </MudPaper>

            <!-- User State -->
            <MudPaper Class="pa-4">
                <MudText Typo="Typo.h6" Class="mb-3">M≈Øj stav</MudText>
                <MudStack Spacing="2">
                    <MudButtonGroup Variant="Variant.Outlined" Color="Color.Primary">
                        <MudButton OnClick="@(() => UpdateUserStatus("New"))" 
                                   Disabled="@(_userState.Status == "New")"
                                   Color="@(_userState.Status == "New" ? Color.Primary : Color.Default)">
                            Nov√©
                        </MudButton>
                        <MudButton OnClick="@(() => UpdateUserStatus("Liked"))" 
                                   Disabled="@(_userState.Status == "Liked")"
                                   Color="@(_userState.Status == "Liked" ? Color.Success : Color.Default)">
                            Zaj√≠mav√©
                        </MudButton>
                        <MudButton OnClick="@(() => UpdateUserStatus("Disliked"))" 
                                   Disabled="@(_userState.Status == "Disliked")"
                                   Color="@(_userState.Status == "Disliked" ? Color.Error : Color.Default)">
                            Nezaj√≠mav√©
                        </MudButton>
                        <MudButton OnClick="@(() => UpdateUserStatus("ToVisit"))" 
                                   Disabled="@(_userState.Status == "ToVisit")"
                                   Color="@(_userState.Status == "ToVisit" ? Color.Warning : Color.Default)">
                            K n√°v≈°tƒõvƒõ
                        </MudButton>
                        <MudButton OnClick="@(() => UpdateUserStatus("Visited"))" 
                                   Disabled="@(_userState.Status == "Visited")"
                                   Color="@(_userState.Status == "Visited" ? Color.Info : Color.Default)">
                            Nav≈°t√≠veno
                        </MudButton>
                    </MudButtonGroup>

                    <MudTextField @bind-Value="_userState.Notes" 
                                  Label="Pozn√°mky" 
                                  Lines="3" 
                                  Variant="Variant.Outlined"
                                  OnBlur="SaveNotesAsync" />

                    @if (_userState.LastUpdated.HasValue)
                    {
                        <MudText Typo="Typo.caption">
                            Naposledy upraveno: @_userState.LastUpdated.Value.ToString("dd.MM.yyyy HH:mm")
                        </MudText>
                    }
                </MudStack>
            </MudPaper>

            <!-- Actions -->
            <MudStack Spacing="2">
                <MudStack Row="true" Spacing="2" Wrap="Wrap.Wrap">
                    <MudButton Color="Color.Primary" 
                               Variant="Variant.Filled" 
                               OnClick="@(() => Navigation.NavigateTo("/listings"))">
                        Zpƒõt na seznam
                    </MudButton>
                    <MudButton Color="Color.Secondary" 
                               Variant="Variant.Filled" 
                               OnClick="CreateAnalysisAsync">
                        Vytvo≈ôit anal√Ωzu
                    </MudButton>
                    <MudButton Color="Color.Warning"
                               Variant="Variant.Filled"
                               OnClick="CopyAiBriefAsync"
                               Disabled="_aiBriefLoading"
                               StartIcon="@Icons.Material.Filled.ContentCopy">
                        @if (_aiBriefLoading)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            <span>P≈ôipravuji‚Ä¶</span>
                        }
                        else
                        {
                            <span>Zkop√≠rovat pro AI</span>
                        }
                    </MudButton>
                    <MudButton Color="Color.Success"
                               Variant="Variant.Filled"
                               OnClick="ExportToDriveAsync"
                               Disabled="_driveExporting"
                               StartIcon="@Icons.Material.Filled.CloudUpload">
                        @if (_driveExporting)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            <span>Nahr√°v√°m na Drive‚Ä¶</span>
                        }
                        else
                        {
                            <span>Export na Google Drive</span>
                        }
                    </MudButton>
                    <MudButton Color="Color.Info"
                               Variant="Variant.Filled"
                               OnClick="ExportToOneDriveAsync"
                               Disabled="_oneDriveExporting"
                               StartIcon="@Icons.Material.Filled.CloudUpload">
                        @if (_oneDriveExporting)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            <span>Nahr√°v√°m na OneDrive‚Ä¶</span>
                        }
                        else
                        {
                            <span>Export na OneDrive</span>
                        }
                    </MudButton>
                </MudStack>

                @if (_driveResult is not null)
                {
                    <MudAlert Severity="Severity.Success" Dense="false">
                        <MudStack Spacing="1">
                            <MudText Typo="Typo.body1">
                                <strong>Slo≈æka p≈ôipraven√°:</strong> @_driveResult.FolderName
                            </MudText>
                            <MudText Typo="Typo.caption" Style="word-break:break-all">
                                @_driveResult.FolderUrl
                            </MudText>
                            <MudStack Row="true" Spacing="2">
                                <MudButton Variant="Variant.Filled" Size="Size.Small" Color="Color.Success"
                                           StartIcon="@Icons.Material.Filled.OpenInNew"
                                           Href="@_driveResult.FolderUrl" Target="_blank">
                                    Otev≈ô√≠t v Google Drive
                                </MudButton>
                                <MudButton Variant="Variant.Outlined" Size="Size.Small" Color="Color.Default"
                                           StartIcon="@Icons.Material.Filled.ContentCopy"
                                           OnClick="CopyDriveUrlAsync">
                                    Kop√≠rovat URL
                                </MudButton>
                            </MudStack>
                            <MudText Typo="Typo.caption" Color="Color.Success">
                                Slo≈æka obsahuje INFO.md, DATA.json, AI_INSTRUKCE.md a fotky ze scrapu.
                                Nahraj vlastn√≠ fotky z prohl√≠dky do podslo≈æky <strong>Moje_fotky_z_prohlidky</strong>.
                            </MudText>
                            @if (_driveFiles is { Count: > 0 })
                            {
                                <MudDivider />
                                <MudText Typo="Typo.body2"><strong>üìë Anal√Ωzy v Drive slo≈æce:</strong></MudText>
                                @foreach (var df in _driveFiles)
                                {
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                        <MudIcon Icon="@Icons.Material.Filled.Description" Size="Size.Small" Color="Color.Success" aria-hidden="true" />
                                        <MudLink Href="@df.WebViewLink" Target="_blank" Typo="Typo.body2">@df.Name</MudLink>
                                        @if (df.ModifiedAt.HasValue)
                                        {
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">@df.ModifiedAt.Value.ToLocalTime().ToString("d. M. yyyy")</MudText>
                                        }
                                    </MudStack>
                                }
                            }
                            @if (_driveResult.PhotosTotal > 0)
                            {
                                <MudText Typo="Typo.caption"
                                         Color="@(_driveResult.PhotosUploaded == _driveResult.PhotosTotal ? Color.Success : Color.Warning)">
                                    üì∑ Fotky: @_driveResult.PhotosUploaded / @_driveResult.PhotosTotal nahr√°no
                                    @if (_driveResult.PhotosUploaded < _driveResult.PhotosTotal)
                                    {
                                        <span> ‚Äì @(_driveResult.PhotosTotal - _driveResult.PhotosUploaded) fotek se nepoda≈ôilo st√°hnout (CDN vypr≈°el)</span>
                                    }
                                </MudText>
                            }
                            @if (DriveInspectionId is not null)
                            {
                                <MudDivider />
                                <MudText Typo="Typo.body2"><strong>üì∏ Nahr√°t fotky z prohl√≠dky</strong></MudText>
                                <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center" Wrap="Wrap.Wrap">
                                    <MudFileUpload T="IReadOnlyList<IBrowserFile>"
                                                   FilesChanged="@(files => _driveInspectionFiles = files ?? [])"
                                                   Accept=".jpg,.jpeg,.png,.heic,.heif,.webp"
                                                   MaximumFileCount="150">
                                        <ActivatorContent>
                                            <MudButton Variant="Variant.Outlined" Size="Size.Small" Color="Color.Success"
                                                       StartIcon="@Icons.Material.Filled.PhotoCamera">
                                                @if (_driveInspectionFiles.Count > 0)
                                                {
                                                    <span>Vybr√°no @_driveInspectionFiles.Count fotek ‚Äì zmƒõnit</span>
                                                }
                                                else
                                                {
                                                    <span>Vybrat fotky z prohl√≠dky</span>
                                                }
                                            </MudButton>
                                        </ActivatorContent>
                                    </MudFileUpload>
                                    @if (_driveInspectionFiles.Count > 0)
                                    {
                                        <MudButton Variant="Variant.Filled" Size="Size.Small" Color="Color.Success"
                                                   StartIcon="@Icons.Material.Filled.CloudUpload"
                                                   Disabled="@_uploadingDrivePhotos"
                                                   OnClick="UploadDriveInspectionPhotosAsync">
                                            @if (_uploadingDrivePhotos)
                                            {
                                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                                <span>Nahr√°v√°m‚Ä¶</span>
                                            }
                                            else
                                            {
                                                <span>Nahr√°t @_driveInspectionFiles.Count fotek na Drive</span>
                                            }
                                        </MudButton>
                                    }
                                    <MudButton Variant="Variant.Outlined" Size="Size.Small" Color="Color.Primary"
                                               StartIcon="@Icons.Material.Filled.Sync"
                                               Disabled="@_scanningDriveInspection"
                                               OnClick="ScanDriveInspectionAsync"
                                               aria-label="Importovat nov√© fotky z Google Drive slo≈æky Moje_fotky_z_prohlidky">
                                        @if (_scanningDriveInspection)
                                        {
                                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                            <span>Scanuji GD‚Ä¶</span>
                                        }
                                        else
                                        {
                                            <span>Sync z GD</span>
                                        }
                                    </MudButton>
                                </MudStack>
                            }
                        </MudStack>
                    </MudAlert>
                }

                @if (_oneDriveResult is not null)
                {
                    <MudAlert Severity="Severity.Info" Dense="false">
                        <MudStack Spacing="2">
                            <MudText Typo="Typo.body1">
                                <strong>OneDrive slo≈æka:</strong> @_oneDriveResult.FolderName
                            </MudText>
                            <MudText Typo="Typo.caption" Style="word-break:break-all">
                                @_oneDriveResult.FolderUrl
                            </MudText>
                            <MudStack Row="true" Spacing="2">
                                <MudButton Variant="Variant.Filled" Size="Size.Small" Color="Color.Info"
                                           StartIcon="@Icons.Material.Filled.OpenInNew"
                                           Href="@_oneDriveResult.FolderUrl" Target="_blank">
                                    Otev≈ô√≠t v OneDrive
                                </MudButton>
                                <MudButton Variant="Variant.Outlined" Size="Size.Small" Color="Color.Default"
                                           StartIcon="@Icons.Material.Filled.ContentCopy"
                                           OnClick="CopyOneDriveUrlAsync">
                                    Kop√≠rovat URL
                                </MudButton>
                            </MudStack>
                            @if (_oneDriveResult.PhotosTotal > 0)
                            {
                                <MudText Typo="Typo.caption"
                                         Color="@(_oneDriveResult.PhotosUploaded == _oneDriveResult.PhotosTotal ? Color.Info : Color.Warning)">
                                    üì∑ Fotky: @_oneDriveResult.PhotosUploaded / @_oneDriveResult.PhotosTotal nahr√°no
                                    @if (_oneDriveResult.PhotosUploaded < _oneDriveResult.PhotosTotal)
                                    {
                                        <span> ‚Äì @(_oneDriveResult.PhotosTotal - _oneDriveResult.PhotosUploaded) fotek se nepoda≈ôilo st√°hnout (CDN vypr≈°el)</span>
                                    }
                                </MudText>
                            }
                            <MudDivider />
                            <MudText Typo="Typo.body2"><strong>üß† Ulo≈æit anal√Ωzu z Clauda</strong></MudText>
                            <MudText Typo="Typo.caption" Color="Color.Info">
                                Zkop√≠ruj v√Ωsledek anal√Ωzy z Clauda/Perplexity a vlo≈æ ho n√≠≈æe. Tlaƒç√≠tko ho ulo≈æ√≠ p≈ô√≠mo do OneDrive slo≈æky jako ANALYZA_datum.md.
                            </MudText>
                            <MudTextField @bind-Value="_analysisText"
                                          T="string"
                                          Label="V√Ωsledek anal√Ωzy z AI"
                                          Placeholder="Sem vlo≈æ text anal√Ωzy od Clauda‚Ä¶"
                                          Lines="8"
                                          Variant="Variant.Outlined"
                                          FullWidth="true" />
                            <MudButton Variant="Variant.Filled" Color="Color.Warning"
                                       StartIcon="@Icons.Material.Filled.Save"
                                       Disabled="@(string.IsNullOrWhiteSpace(_analysisText) || _savingAnalysis)"
                                       OnClick="SaveAnalysisToOneDriveAsync">
                                @if (_savingAnalysis)
                                {
                                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                    <span>Ukl√°d√°m‚Ä¶</span>
                                }
                                else
                                {
                                    <span>Ulo≈æit anal√Ωzu do OneDrive</span>
                                }
                            </MudButton>
                            @if (OneDriveInspectionId is not null)
                            {
                                <MudDivider />
                                <MudText Typo="Typo.body2"><strong>üì∏ Nahr√°t fotky z prohl√≠dky</strong></MudText>
                                <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center" Wrap="Wrap.Wrap">
                                    <MudFileUpload T="IReadOnlyList<IBrowserFile>"
                                                   FilesChanged="@(files => _oneDriveInspectionFiles = files ?? [])"
                                                   Accept=".jpg,.jpeg,.png,.heic,.heif,.webp"
                                                   MaximumFileCount="150">
                                        <ActivatorContent>
                                            <MudButton Variant="Variant.Outlined" Size="Size.Small" Color="Color.Info"
                                                       StartIcon="@Icons.Material.Filled.PhotoCamera">
                                                @if (_oneDriveInspectionFiles.Count > 0)
                                                {
                                                    <span>Vybr√°no @_oneDriveInspectionFiles.Count fotek ‚Äì zmƒõnit</span>
                                                }
                                                else
                                                {
                                                    <span>Vybrat fotky z prohl√≠dky</span>
                                                }
                                            </MudButton>
                                        </ActivatorContent>
                                    </MudFileUpload>
                                    @if (_oneDriveInspectionFiles.Count > 0)
                                    {
                                        <MudButton Variant="Variant.Filled" Size="Size.Small" Color="Color.Info"
                                                   StartIcon="@Icons.Material.Filled.CloudUpload"
                                                   Disabled="@_uploadingOneDrivePhotos"
                                                   OnClick="UploadOneDriveInspectionPhotosAsync">
                                            @if (_uploadingOneDrivePhotos)
                                            {
                                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                                <span>Nahr√°v√°m‚Ä¶</span>
                                            }
                                            else
                                            {
                                                <span>Nahr√°t @_oneDriveInspectionFiles.Count fotek na OneDrive</span>
                                            }
                                        </MudButton>
                                    }
                                </MudStack>
                            }
                        </MudStack>
                    </MudAlert>
                }
                @if (OneDriveExportedButNoSession)
                {
                    <MudAlert Severity="Severity.Info" Dense="false">
                        <MudStack Spacing="2">
                            <MudText Typo="Typo.body1">
                                <strong>OneDrive:</strong> Slo≈æka existuje (exportov√°no d≈ô√≠ve)
                            </MudText>
                            <MudText Typo="Typo.caption" Color="Color.Info">
                                Str√°nka byla obnovena ‚Äì odkaz na slo≈æku nen√≠ v session. Klikni ‚ÄûExport na OneDrive" pro opƒõtovn√© zobrazen√≠ odkazu.
                            </MudText>
                            @if (OneDriveInspectionId is not null)
                            {
                                <MudDivider />
                                <MudText Typo="Typo.body2"><strong>üì∏ Nahr√°t fotky z prohl√≠dky</strong></MudText>
                                <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center" Wrap="Wrap.Wrap">
                                    <MudFileUpload T="IReadOnlyList<IBrowserFile>"
                                                   FilesChanged="@(files => _oneDriveInspectionFiles = files ?? [])"
                                                   Accept=".jpg,.jpeg,.png,.heic,.heif,.webp"
                                                   MaximumFileCount="150">
                                        <ActivatorContent>
                                            <MudButton Variant="Variant.Outlined" Size="Size.Small" Color="Color.Info"
                                                       StartIcon="@Icons.Material.Filled.PhotoCamera">
                                                @if (_oneDriveInspectionFiles.Count > 0)
                                                {
                                                    <span>Vybr√°no @_oneDriveInspectionFiles.Count fotek ‚Äì zmƒõnit</span>
                                                }
                                                else
                                                {
                                                    <span>Vybrat fotky z prohl√≠dky</span>
                                                }
                                            </MudButton>
                                        </ActivatorContent>
                                    </MudFileUpload>
                                    @if (_oneDriveInspectionFiles.Count > 0)
                                    {
                                        <MudButton Variant="Variant.Filled" Size="Size.Small" Color="Color.Info"
                                                   StartIcon="@Icons.Material.Filled.CloudUpload"
                                                   Disabled="@_uploadingOneDrivePhotos"
                                                   OnClick="UploadOneDriveInspectionPhotosAsync">
                                            @if (_uploadingOneDrivePhotos)
                                            {
                                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                                <span>Nahr√°v√°m‚Ä¶</span>
                                            }
                                            else
                                            {
                                                <span>Nahr√°t @_oneDriveInspectionFiles.Count fotek na OneDrive</span>
                                            }
                                        </MudButton>
                                    }
                                </MudStack>
                            }
                        </MudStack>
                    </MudAlert>
                }
            </MudStack>

            <!-- RAG Chat -->
            <MudPaper Class="pa-4">
                <MudText Typo="Typo.h6" Class="mb-1">ü§ñ AI Chat</MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-3">
                    Ptej se na z√°kladƒõ ulo≈æen√Ωch anal√Ωz. Klikni ‚ÄûEmbedovat popis" pro
                    inicializaci (staƒç√≠ jednou ‚Äì popis inzer√°tu se ulo≈æ√≠ jako znalostn√≠ z√°znam).
                </MudText>
                <MudStack Spacing="2">
                    <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center" Wrap="Wrap.Wrap">
                        <MudButton Variant="Variant.Outlined" Size="Size.Small"
                                   Color="@(_ragDescriptionEmbedded ? Color.Success : Color.Warning)"
                                   StartIcon="@(_ragDescriptionEmbedded ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.AutoFixHigh)"
                                   Disabled="@(_ragEmbedding || _ragDescriptionEmbedded)"
                                   OnClick="EmbedDescriptionAsync">
                            @if (_ragEmbedding)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-1" />
                                <span>Embeduji popis‚Ä¶</span>
                            }
                            else if (_ragDescriptionEmbedded)
                            {
                                <span>Popis embedov√°n ‚úì</span>
                            }
                            else
                            {
                                <span>Embedovat popis inzer√°tu</span>
                            }
                        </MudButton>
                        @if (_ragAnalysisCount > 0)
                        {
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                @_ragAnalysisCount z√°znamy v knowledge base
                            </MudText>
                        }
                    </MudStack>

                    <MudTextField @bind-Value="_ragQuestion"
                                  T="string"
                                  Label="Ot√°zka k inzer√°tu"
                                  Placeholder="Nap≈ô. Jak√© jsou nev√Ωhody? Je cena p≈ôimƒõ≈ôen√°? Vhodn√© pro rodinu?"
                                  Lines="2"
                                  Variant="Variant.Outlined"
                                  FullWidth="true"
                                  OnKeyDown="@(async (e) => { if (e.Key == "Enter" && !e.ShiftKey) await AskRagAsync(); })" />
                    <MudButton Variant="Variant.Filled" Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.QuestionAnswer"
                               Disabled="@(string.IsNullOrWhiteSpace(_ragQuestion) || _ragLoading)"
                               OnClick="AskRagAsync">
                        @if (_ragLoading)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            <span>P≈ôem√Ω≈°l√≠m‚Ä¶</span>
                        }
                        else
                        {
                            <span>Zeptat se</span>
                        }
                    </MudButton>

                    @if (_ragAnswer is not null)
                    {
                        <MudDivider />
                        <MudAlert Severity="@(_ragHasEmbeddings ? Severity.Info : Severity.Warning)"
                                  Dense="false" NoIcon="false">
                            <MudText Typo="Typo.body2" Style="white-space: pre-wrap;">@_ragAnswer</MudText>
                        </MudAlert>
                        @if (_ragSources.Count > 0)
                        {
                            <MudText Typo="Typo.subtitle2" Color="Color.Secondary" Class="mt-2 mb-1">üìé Vyu≈æit√© z√°znamy (@_ragSources.Count)</MudText>
                            @foreach (var s in _ragSources)
                            {
                                <MudPaper Outlined="true" Class="pa-3 mb-2" Style="border-radius:8px;">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-1">
                                        <MudTooltip Text="@($"Relevance: {s.Similarity:P1}")">
                                            <MudChip T="string"
                                                     Color="@GetRagScoreColor(s.Similarity)"
                                                     Size="Size.Small"
                                                     Variant="Variant.Filled"
                                                     Icon="@Icons.Material.Filled.Analytics">
                                                @s.Similarity.ToString("P0")
                                            </MudChip>
                                        </MudTooltip>
                                        <MudText Typo="Typo.body2" Style="font-weight:600;flex:1;">@(s.Title ?? "‚Äì")</MudText>
                                        <MudChip T="string"
                                                 Size="Size.Small"
                                                 Variant="Variant.Outlined"
                                                 Color="@(s.Source == "claude" ? Color.Secondary : s.Source == "user" ? Color.Tertiary : Color.Default)">
                                            @s.Source
                                        </MudChip>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">@s.CreatedAt.ToString("dd.MM.yy")</MudText>
                                    </MudStack>
                                    <MudProgressLinear Value="@(s.Similarity * 100)"
                                                      Color="@GetRagScoreColor(s.Similarity)"
                                                      Rounded="true"
                                                      Size="Size.Small"
                                                      Class="mb-2" />
                                    <MudText Typo="Typo.caption" Color="Color.Secondary"
                                             Style="display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;">
                                        @s.ContentExcerpt
                                    </MudText>
                                </MudPaper>
                            }
                        }
                    }
                </MudStack>
            </MudPaper>
        </MudStack>
    }
</MudContainer>

@* ‚îÄ‚îÄ Lightbox overlay ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ *@
@if (_lbOpen && _listing?.Photos is { Count: > 0 })
{
    var _lbPhotos = _listing.Photos.OrderBy(p => p.Order).ToList();
    var _lbPhoto  = _lbPhotos[Math.Clamp(_lbIdx, 0, _lbPhotos.Count - 1)];
    var _lbSrc    = !string.IsNullOrEmpty(_lbPhoto.StoredUrl) ? _lbPhoto.StoredUrl : _lbPhoto.OriginalUrl;
    var _lbTotal  = _lbPhotos.Count;
    <div style="position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,0.93);display:flex;align-items:center;justify-content:center;"
         @onclick="LightboxClose"
         @onkeydown="LightboxKeyDown"
         tabindex="0"
         role="dialog"
         aria-modal="true"
         aria-label="Prohl√≠≈æeƒç fotek">

        @* P≈ôedchoz√≠ *@
        @if (_lbIdx > 0)
        {
            <button type="button" @onclick:stopPropagation="true" @onclick="LightboxPrev"
                    style="position:absolute;left:14px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,.18);border:none;border-radius:50%;width:52px;height:52px;font-size:28px;color:#fff;cursor:pointer;line-height:1;z-index:10000;"
                    aria-label="P≈ôedchoz√≠ fotka">&#8249;</button>
        }

        @* Foto *@
        <img src="@_lbSrc"
             alt="@(!string.IsNullOrEmpty(_lbPhoto.AltText) ? _lbPhoto.AltText : GetCategoryLabel(_lbPhoto.PhotoCategory))"
             style="max-width:90vw;max-height:88vh;object-fit:contain;border-radius:4px;box-shadow:0 4px 32px #000;user-select:none;"
             @onclick:stopPropagation="true" />

        @* Dal≈°√≠ *@
        @if (_lbIdx < _lbTotal - 1)
        {
            <button type="button" @onclick:stopPropagation="true" @onclick="LightboxNext"
                    style="position:absolute;right:14px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,.18);border:none;border-radius:50%;width:52px;height:52px;font-size:28px;color:#fff;cursor:pointer;line-height:1;z-index:10000;"
                    aria-label="Dal≈°√≠ fotka">&#8250;</button>
        }

        @* Zav≈ô√≠t + poƒç√≠tadlo *@
        <div style="position:absolute;top:12px;right:16px;display:flex;align-items:center;gap:16px;z-index:10000;">
            <span style="color:#bbb;font-size:13px;font-variant-numeric:tabular-nums;">@(_lbIdx + 1) / @_lbTotal</span>
            <button type="button" @onclick:stopPropagation="true" @onclick="LightboxClose"
                    style="background:rgba(255,255,255,.18);border:none;border-radius:50%;width:36px;height:36px;font-size:18px;color:#fff;cursor:pointer;line-height:1;"
                    aria-label="Zav≈ô√≠t prohl√≠≈æeƒç fotek">&#x2715;</button>
        </div>

        @* Kategorie + confidence dole *@
        @if (_lbPhoto.IsClassified && !string.IsNullOrWhiteSpace(_lbPhoto.PhotoCategory))
        {
            <div style="position:absolute;bottom:16px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.7);color:#fff;border-radius:8px;padding:4px 14px;font-size:12px;white-space:nowrap;z-index:10000;">
                @GetCategoryLabel(_lbPhoto.PhotoCategory)
                @if (_lbPhoto.ClassificationConfidence.HasValue)
                {
                    <span style="opacity:.6"> ¬∑ @($"{_lbPhoto.ClassificationConfidence.Value * 100:0}%")</span>
                }
            </div>
        }
    </div>
}

@code {
    [Parameter]
    public Guid Id { get; set; }

    private bool _loading = true;
    private ListingDetailDto? _listing;
    private ListingUserStateDto _userState = new();
    private CancellationTokenSource _cts = new();

    // Google Drive export
    private bool _driveExporting = false;
    private DriveExportResult? _driveResult;
    private record DriveExportResult(string FolderUrl, string FolderName, string FolderId, string? InspectionFolderId = null,
        int PhotosUploaded = 0, int PhotosTotal = 0);

    // Soubory s anal√Ωzami z Google Drive slo≈æky
    private List<DriveFileItem>? _driveFiles;
    private record DriveFileItem(string Id, string Name, string WebViewLink, DateTime? ModifiedAt);

    // ‚îÄ‚îÄ Lightbox (AI klasifikace fotek) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    private bool _lbOpen;
    private int  _lbIdx;

    private void OpenLightbox(int idx)
    {
        _lbIdx   = idx;
        _lbOpen  = true;
    }

    private void LightboxClose() => _lbOpen = false;

    private void LightboxPrev()
    {
        if (_lbIdx > 0) _lbIdx--;
    }

    private void LightboxNext()
    {
        var max = (_listing?.Photos.Count ?? 1) - 1;
        if (_lbIdx < max) _lbIdx++;
    }

    private void LightboxKeyDown(KeyboardEventArgs e)
    {
        switch (e.Key)
        {
            case "ArrowLeft":  LightboxPrev();  break;
            case "ArrowRight": LightboxNext();  break;
            case "Escape":     LightboxClose(); break;
        }
    }

    // OneDrive export
    private bool _oneDriveExporting = false;
    private DriveExportResult? _oneDriveResult;

    // AI brief
    private bool _aiBriefLoading = false;

    // Ulo≈æen√≠ anal√Ωzy
    private string _analysisText = string.Empty;
    private bool _savingAnalysis = false;

    // Upload fotek z prohl√≠dky
    private IReadOnlyList<IBrowserFile> _driveInspectionFiles = [];
    private IReadOnlyList<IBrowserFile> _oneDriveInspectionFiles = [];
    private bool _uploadingDrivePhotos = false;
    private bool _scanningDriveInspection = false;
    private bool _uploadingOneDrivePhotos = false;

    // Export state z DB (trval√Ω, p≈ôe≈æ√≠v√° refresh str√°nky)
    private record ExportState(string? DriveFolderId, string? DriveFolderUrl, string? DriveInspectionFolderId,
        string? OneDriveFolderId, string? OneDriveInspectionFolderId);
    private ExportState? _exportState;

    // Computed helpers ‚Äì true i kdy≈æ _driveResult/oneDriveResult jsou null (stav naƒçten z DB)
    private string? DriveInspectionId => _driveResult?.InspectionFolderId ?? _exportState?.DriveInspectionFolderId;
    private string? OneDriveInspectionId => _oneDriveResult?.InspectionFolderId ?? _exportState?.OneDriveInspectionFolderId;
    private bool OneDriveExportedButNoSession => _oneDriveResult is null && _exportState?.OneDriveFolderId is not null;

    // Katastr nemovitosti (RUIAN)
    private CadastreDataDto? _cadastreData;
    private bool _cadastreLoading;
    private record CadastreDataDto(Guid Id, Guid ListingId, long? RuianKod, string? CadastreUrl, string FetchStatus, DateTime FetchedAt);

    // OCR screenshot z KN
    private CadastreDataDto? _ocrData;
    private bool _ocrLoading;
    private bool _ocrDragging;
    private string? _ocrPreviewSrc;
    private DotNetObjectReference<ListingDetail>? _ocrDotNetRef;

    // RAG Chat
    private string _ragQuestion = string.Empty;
    private string? _ragAnswer;
    private bool _ragHasEmbeddings;
    private List<RagChunkInfo> _ragSources = [];
    private bool _ragLoading;
    private bool _ragEmbedding;
    private bool _ragDescriptionEmbedded;
    private int _ragAnalysisCount;
    private record RagChunkInfo(Guid AnalysisId, string? Title, string ContentExcerpt, string Source, double Similarity, DateTime CreatedAt);
    private record RagAskResponse(string Answer, List<RagChunkInfo> Sources, bool HasEmbeddings);
    private record RagEmbedStatus(int TotalAnalyses, int WithEmbedding);


    private static readonly IReadOnlyDictionary<string, string> PropertyTypeLabels =
        new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase)
        {
            ["House"] = "D≈Øm",
            ["Apartment"] = "Byt",
            ["Land"] = "Pozemek",
            ["Cottage"] = "Chata",
            ["Commercial"] = "Komerƒçn√≠",
            ["Other"] = "Ostatn√≠"
        };

    private static readonly IReadOnlyDictionary<string, string> OfferTypeLabels =
        new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase)
        {
            ["Sale"]    = "Prodej",
            ["Rent"]    = "Pron√°jem",
            ["Auction"] = "Dra≈æba"
        };

    // ‚îÄ‚îÄ AI klasifikace fotek ‚Äì stav a helpery ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    private Dictionary<Guid, string?> _photoFeedbacks = new();
    private bool _classifyLoading;
    private bool _sortLoading;
    private bool _altTextLoading;

    // ‚îÄ‚îÄ AI text features (smart tags, price signal, normalize) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    private bool _aiTextLoading;

    // Computed ‚Äì nelze @{var=} uvnit≈ô @if v Razor, proto computed properties v @code
    private int PhotoClassifiedCount      => _listing?.Photos.Count(p => p.IsClassified) ?? 0;
    private int PhotoDamageCount          => _listing?.Photos.Count(p => p.DamageDetected) ?? 0;
    private int PhotoFeedbackWrongCount   => _photoFeedbacks.Values.Count(f => f == "wrong");

    private Task ToggleCorrectFeedbackAsync(Guid photoId) =>
        SetPhotoFeedbackAsync(photoId, _photoFeedbacks.GetValueOrDefault(photoId) == "correct" ? null : "correct");

    private Task ToggleWrongFeedbackAsync(Guid photoId) =>
        SetPhotoFeedbackAsync(photoId, _photoFeedbacks.GetValueOrDefault(photoId) == "wrong" ? null : "wrong");

    private static string GetCategoryLabel(string? cat) => cat switch
    {
        "exterior"    => "Exteri√©r",
        "interior"    => "Interi√©r",
        "kitchen"     => "Kuchy≈à",
        "bathroom"    => "Koupelna",
        "living_room" => "Ob√Ωv√°k",
        "bedroom"     => "Lo≈ænice",
        "attic"       => "P≈Øda",
        "basement"    => "Sklep",
        "garage"      => "Gar√°≈æ",
        "land"        => "Pozemek",
        "floor_plan"  => "P≈Ødorys",
        "damage"      => "Po≈°kozen√≠",
        _             => cat ?? "Ostatn√≠"
    };

    private static Color GetRagScoreColor(double score) => score switch
    {
        >= 0.8 => Color.Success,
        >= 0.6 => Color.Warning,
        >= 0.4 => Color.Info,
        _      => Color.Default
    };

    private static Color GetConfidenceColor(decimal? cf) => cf switch
    {
        >= 0.85m => Color.Success,
        >= 0.65m => Color.Warning,
        _        => Color.Error
    };

    private static List<string> GetPhotoLabels(string? json)
    {
        if (string.IsNullOrEmpty(json)) return new();
        try { return System.Text.Json.JsonSerializer.Deserialize<List<string>>(json) ?? new(); }
        catch { return new(); }
    }

    private static string TranslateLabel(string label) => label switch
    {
        "mold"                => "pl√≠se≈à",
        "water_damage"        => "vlhkost",
        "crack"               => "trhliny",
        "broken_windows"      => "okna",
        "damaged_roof"        => "st≈ôecha",
        "renovation_needed"   => "k rekonstrukci",
        "garden"              => "zahrada",
        "pool"                => "baz√©n",
        "fireplace"           => "krb",
        "wooden_beams"        => "tr√°my",
        "new_construction"    => "novostavba",
        "renovated"           => "renovov√°no",
        "brick_walls"         => "cihla",
        "wooden_construction" => "d≈ôevo",
        "panel_building"      => "panel",
        _                     => label
    };

    private void InitPhotoFeedbacks()
    {
        _photoFeedbacks = _listing?.Photos
            .ToDictionary(p => p.Id, p => p.ClassificationFeedback)
            ?? new();
    }

    private async Task SetPhotoFeedbackAsync(Guid photoId, string? feedback)
    {
        try
        {
            using var response = await Http.PatchAsJsonAsync(
                $"api/photos/{photoId}/classification-feedback",
                new { feedback },
                _cts.Token);

            if (response.IsSuccessStatusCode)
            {
                _photoFeedbacks[photoId] = feedback;
                StateHasChanged();
            }
            else
            {
                Snackbar.Add("Nepoda≈ôilo se ulo≈æit hodnocen√≠.", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Chyba p≈ôi ukl√°d√°n√≠ hodnocen√≠: {ex.Message}", Severity.Error);
        }
    }

    private async Task TriggerPhotoClassificationAsync()
    {
        _classifyLoading = true;
        StateHasChanged();
        try
        {
            var response = await Http.PostAsync(
                $"api/photos/bulk-classify?batchSize=20&listingId={Id}", null, _cts.Token);
            if (response.IsSuccessStatusCode)
            {
                await LoadListingAsync();
                Snackbar.Add("Klasifikace fotek dokonƒçena.", Severity.Success);
            }
            else
            {
                Snackbar.Add("Klasifikace selhala (Ollama bƒõ≈æ√≠?).", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Chyba klasifikace: {ex.Message}", Severity.Error);
        }
        finally
        {
            _classifyLoading = false;
            StateHasChanged();
        }
    }

    private async Task SortPhotosByCategoryAsync()
    {
        _sortLoading = true;
        StateHasChanged();
        try
        {
            var response = await Http.PostAsync(
                $"api/photos/sort-by-category?listingId={Id}", null, _cts.Token);
            if (response.IsSuccessStatusCode)
            {
                await LoadListingAsync();
                Snackbar.Add("Fotky p≈ôe≈ôazeny dle kategorie.", Severity.Success);
            }
            else
            {
                Snackbar.Add("≈òazen√≠ selhalo.", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Chyba ≈ôazen√≠: {ex.Message}", Severity.Error);
        }
        finally
        {
            _sortLoading = false;
            StateHasChanged();
        }
    }

    private async Task TriggerAltTextAsync()
    {
        _altTextLoading = true;
        StateHasChanged();
        try
        {
            var response = await Http.PostAsync(
                $"api/photos/bulk-alt-text?batchSize=20&listingId={Id}", null, _cts.Token);
            if (response.IsSuccessStatusCode)
            {
                await LoadListingAsync();
                Snackbar.Add("Alt text vygenerov√°n.", Severity.Success);
            }
            else
            {
                Snackbar.Add("Generov√°n√≠ alt textu selhalo (Ollama bƒõ≈æ√≠?).", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Chyba alt textu: {ex.Message}", Severity.Error);
        }
        finally
        {
            _altTextLoading = false;
            StateHasChanged();
        }
    }

    // ‚îÄ‚îÄ AI text helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    private async Task TriggerSmartTagsAsync() => await RunAiTextAsync(
        $"api/ollama/bulk-smart-tags?batchSize=1",
        "Tagy vygenerov√°ny.", "Generov√°n√≠ tag≈Ø selhalo.");

    private async Task TriggerPriceOpinionAsync()
    {
        // V≈ædy pou≈æij dedikovan√Ω endpoint pro konkr√©tn√≠ inzer√°t ‚Äì
        // zahrnuje pozn√°mky z prohl√≠dky a ulo≈æen√© anal√Ωzy do promptu.
        await RunAiTextAsync(
            $"api/ollama/listings/{Id}/recalculate-price-opinion",
            "Cenov√Ω sign√°l p≈ôepoƒç√≠t√°n.", "P≈ôepoƒçet cenov√©ho sign√°lu selhal.");
    }

    private async Task TriggerNormalizeAsync() => await RunAiTextAsync(
        $"api/ollama/bulk-normalize?batchSize=1",
        "Normalizace dokonƒçena.", "Normalizace selhala.");

    private async Task RunAiTextAsync(string url, string successMsg, string failMsg)
    {
        _aiTextLoading = true;
        StateHasChanged();
        try
        {
            // Batch=1 zpracuje prvn√≠ inzer√°t ‚Äì ale my chceme konkr√©tn√≠ listing.
            // Workaround: doƒçasnƒõ update p≈ôes dedicated endpoint if listing not yet processed,
            // jinak jednodu≈°e zavol√°me batch a refreshneme detail (listing bude prvn√≠ ve frontƒõ
            // pokud je je≈°tƒõ nezpracovan√Ω)
            var response = await Http.PostAsync(url, null, _cts.Token);
            if (response.IsSuccessStatusCode)
            {
                await LoadListingAsync();
                Snackbar.Add(successMsg, Severity.Success);
            }
            else
            {
                Snackbar.Add(failMsg, Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Chyba: {ex.Message}", Severity.Error);
        }
        finally
        {
            _aiTextLoading = false;
            StateHasChanged();
        }
    }

    private static List<string> TryParseStringArray(string? json)
    {
        if (string.IsNullOrEmpty(json)) return new();
        try { return System.Text.Json.JsonSerializer.Deserialize<List<string>>(json) ?? new(); }
        catch { return new(); }
    }

    private static List<(string Key, string Value)> TryParseNormalizedData(string? json)
    {
        if (string.IsNullOrEmpty(json)) return new();
        try
        {
            using var doc = System.Text.Json.JsonDocument.Parse(json);
            var result = new List<(string, string)>();
            foreach (var prop in doc.RootElement.EnumerateObject())
            {
                if (prop.Value.ValueKind == System.Text.Json.JsonValueKind.Null) continue;
                var key = prop.Name switch
                {
                    "year_built"    => "Rok stavby",
                    "floor"         => "Patro",
                    "total_floors"  => "Celkem podla≈æ√≠",
                    "has_elevator"  => "V√Ωtah",
                    "has_basement"  => "Sklep",
                    "has_garage"    => "Gar√°≈æ",
                    "has_garden"    => "Zahrada",
                    "has_balcony"   => "Balkon",
                    "has_terrace"   => "Terasa",
                    "has_pool"      => "Baz√©n",
                    "heating_type"       => "Vyt√°pƒõn√≠",
                    "energy_class"       => "Energ. t≈ô√≠da",
                    "ownership"          => "Vlastnictv√≠",
                    "is_single_floor"    => "P≈ô√≠zemn√≠ / bungalov",
                    "has_storage"        => "√ölo≈æ. prostory",
                    "extension_possible" => "Mo≈ænost p≈ô√≠stavby",
                    _ => prop.Name
                };
                var val = prop.Value.ValueKind switch
                {
                    System.Text.Json.JsonValueKind.True  => "Ano",
                    System.Text.Json.JsonValueKind.False => "Ne",
                    _ => prop.Value.ToString()
                };
                // P≈ôelo≈æ√≠me hodnoty
                val = val switch
                {
                    "gas"           => "Plyn",
                    "electric"      => "Elekt≈ôina",
                    "solid_fuel"    => "Tuh√° paliva",
                    "heat_pump"     => "Tepeln√© ƒçerpadlo",
                    "district"      => "D√°lkov√© teplo",
                    "personal"      => "Osobn√≠",
                    "cooperative"   => "Dru≈æstevn√≠",
                    "company"       => "Firemn√≠",
                    "state"         => "St√°tn√≠",
                    _ => val
                };
                result.Add((key, val));
            }
            return result;
        }
        catch { return new(); }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadListingAsync();
        await LoadExportStateAsync();
        await LoadDriveAnalysisFilesAsync();
        await LoadRagAnalysesAsync();
        await LoadCadastreDataAsync();
    }

    private bool _ocrJsInitialized;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_ocrJsInitialized)
        {
            try
            {
                _ocrDotNetRef = DotNetObjectReference.Create(this);
                await JS.InvokeVoidAsync("knOcr.init", _ocrDotNetRef, "kn-ocr-dropzone");
                _ocrJsInitialized = true;
            }
            catch (Exception ex)
            {
                // JS nen√≠ k dispozici (pre-rendering) ‚Äì ignoruj
                _ = ex;
            }
        }
    }

    /// <summary>Vol√°no z JS (kn-ocr.js) po vlo≈æen√≠ obr√°zku z clipboardu nebo drag&amp;drop.</summary>
    [JSInvokable]
    public async Task ReceivePastedImageAsync(string base64Data, string mimeType)
    {
        try
        {
            _ocrPreviewSrc = $"data:{mimeType};base64,{base64Data}";
            StateHasChanged();

            var imageBytes = Convert.FromBase64String(base64Data);
            await ProcessOcrImageAsync(imageBytes, mimeType);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"OCR se nezda≈ôilo: {ex.Message}", Severity.Error);
            _ocrLoading = false;
            StateHasChanged();
        }
    }

    private async Task HandleOcrFileUpload(IBrowserFile file)
    {
        if (file is null) return;
        if (!file.ContentType.StartsWith("image/", StringComparison.OrdinalIgnoreCase))
        {
            Snackbar.Add("Vyberte obr√°zek (PNG, JPG, WEBP...).", Severity.Warning);
            return;
        }

        try
        {
            using var ms = new System.IO.MemoryStream();
            await using var stream = file.OpenReadStream(maxAllowedSize: 20 * 1024 * 1024);
            await stream.CopyToAsync(ms);
            var imageBytes = ms.ToArray();

            // Preview
            _ocrPreviewSrc = $"data:{file.ContentType};base64,{Convert.ToBase64String(imageBytes)}";
            StateHasChanged();

            await ProcessOcrImageAsync(imageBytes, file.ContentType);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Nahr√°n√≠ souboru selhalo: {ex.Message}", Severity.Error);
            _ocrLoading = false;
            StateHasChanged();
        }
    }

    private async Task ProcessOcrImageAsync(byte[] imageBytes, string mimeType)
    {
        _ocrLoading = true;
        _ocrData = null;
        StateHasChanged();

        try
        {
            using var content = new MultipartFormDataContent();
            var fileContent = new ByteArrayContent(imageBytes);
            fileContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue(mimeType);
            content.Add(fileContent, "file", $"kn_screenshot.{mimeType.Split('/').LastOrDefault() ?? "png"}");

            var response = await Http.PostAsync(
                $"api/cadastre/listings/{Id}/ocr-screenshot", content, _cts.Token);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<OcrResultWrapper>(_cts.Token);
                if (result?.Cadastre is not null)
                {
                    _ocrData = new CadastreDataDto(
                        result.Cadastre.Id,
                        result.Cadastre.ListingId,
                        result.Cadastre.RuianKod,
                        result.Cadastre.CadastreUrl,
                        result.Cadastre.FetchStatus,
                        result.Cadastre.FetchedAt);

                    // Kop√≠ruji parsed data do lok√°ln√≠ho roz≈°√≠≈ôen√©ho DTO
                    _ocrParsed = result.Cadastre;
                    Snackbar.Add("‚úÖ Screenshot zpracov√°n, data extrahov√°na!", Severity.Success);

                    // Aktualizuj i _cadastreData pokud bylo empty
                    if (_cadastreData is null)
                        _cadastreData = _ocrData;
                }
                else
                {
                    Snackbar.Add("OCR nevr√°til v√Ωsledek.", Severity.Warning);
                }
            }
            else
            {
                var err = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"OCR selhal: {response.StatusCode} ‚Äì {err[..Math.Min(150, err.Length)]}", Severity.Error);
            }
        }
        finally
        {
            _ocrLoading = false;
            StateHasChanged();
        }
    }

    // Roz≈°√≠≈ôen√© OCR data (s d√©tailem pol√≠)
    private FullCadastreDto? _ocrParsed;

    // DTO mapuj√≠c√≠ pln√Ω response z API.
    private record OcrResultWrapper(
        FullCadastreDto Cadastre,
        string OcrExtractedJson);

    private record FullCadastreDto(
        Guid Id,
        Guid ListingId,
        long? RuianKod,
        string? ParcelNumber,
        string? LvNumber,
        int? LandAreaM2,
        string? LandType,
        string? OwnerType,
        string? EncumbrancesJson,
        string AddressSearched,
        string? CadastreUrl,
        string FetchStatus,
        string? FetchError,
        DateTime FetchedAt);

    private static IEnumerable<string> ParseEncumbrances(string? json)
    {
        if (string.IsNullOrWhiteSpace(json)) return [];
        var result = new List<string>();
        try
        {
            using var doc = JsonDocument.Parse(json);
            foreach (var item in doc.RootElement.EnumerateArray())
            {
                var type = item.TryGetProperty("type", out var t) ? t.GetString() : null;
                var who  = item.TryGetProperty("who", out var w) ? w.GetString() : null;
                var desc = item.TryGetProperty("description", out var d) ? d.GetString() : null;
                var line = type ?? "(nezn√°m√©)";
                if (!string.IsNullOrWhiteSpace(who))  line += $" ‚Äì {who}";
                if (!string.IsNullOrWhiteSpace(desc)) line += $" ({desc})";
                result.Add(line);
            }
        }
        catch
        {
            result.Add(json);
        }
        return result;
    }

    private async Task LoadCadastreDataAsync()
    {
        try
        {
            var full = await Http.GetFromJsonAsync<FullCadastreDto>(
                $"api/cadastre/listings/{Id}", _cts.Token);
            if (full is not null)
            {
                _cadastreData = new CadastreDataDto(
                    full.Id, full.ListingId, full.RuianKod, full.CadastreUrl, full.FetchStatus, full.FetchedAt);

                // Pokud jsou v DB ulo≈æen√° OCR data, zobraz je ihned (bez nutnosti znovu nahr√°t screenshot)
                if (full.FetchStatus == "ocr" && !string.IsNullOrWhiteSpace(full.ParcelNumber))
                    _ocrParsed = full;
            }
        }
        catch { /* katastralni data jsou optional */ }
    }

    private string GetCadastreUrl()
    {
        if (_cadastreData?.FetchStatus == "found" && !string.IsNullOrWhiteSpace(_cadastreData.CadastreUrl))
            return _cadastreData.CadastreUrl;
        return "https://nahlizenidokn.cuzk.cz/";
    }

    private async Task FetchRuianAsync()
    {
        _cadastreLoading = true;
        try
        {
            var response = await Http.PostAsync($"api/cadastre/listings/{Id}/fetch", null, _cts.Token);
            if (response.IsSuccessStatusCode)
            {
                _cadastreData = await response.Content.ReadFromJsonAsync<CadastreDataDto>();
                if (_cadastreData?.FetchStatus == "found")
                    Snackbar.Add("Primy odkaz na KN nalezen", Severity.Success);
                else
                    Snackbar.Add("Adresa v RUIAN nenalezena - otevri KN rucne", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"RUIAN chyba: {ex.Message}", Severity.Error);
        }
        finally
        {
            _cadastreLoading = false;
        }
    }

    private async Task LoadExportStateAsync()
    {
        try
        {
            _exportState = await Http.GetFromJsonAsync<ExportState>($"api/listings/{Id}/export-state", _cts.Token);
            // Pokud u≈æ byl Drive export, p≈ôed-pln√≠me _driveResult (URL je trval√° pro GD)
            if (_exportState?.DriveFolderUrl is not null && _driveResult is null)
            {
                _driveResult = new DriveExportResult(
                    _exportState.DriveFolderUrl,
                    "[ulo≈æen√Ω export]",
                    _exportState.DriveFolderId!,
                    _exportState.DriveInspectionFolderId);
            }
        }
        catch { /* export-state je optional, ignorujeme chybu */ }
    }

    private async Task LoadDriveAnalysisFilesAsync()
    {
        try
        {
            var list = await Http.GetFromJsonAsync<List<DriveFileItem>>(
                $"api/listings/{Id}/drive-analysis-files", _cts.Token);
            _driveFiles = list is { Count: > 0 } ? list : null;
        }
        catch { /* Drive nemus√≠ b√Ωt dostupn√Ω */ }
    }

    private async Task LoadListingAsync()
    {
        _loading = true;
        try
        {
            _listing = await Http.GetFromJsonAsync<ListingDetailDto>($"api/listings/{Id}");
            if (_listing != null)
            {
                _userState = _listing.UserState ?? new();
                InitPhotoFeedbacks();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Chyba p≈ôi naƒç√≠t√°n√≠: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task UpdateUserStatus(string status)
    {
        try
        {
            _userState.Status = status;
            _userState.LastUpdated = DateTime.Now;

            var request = new ListingUserStateUpdateDto
            {
                Status = _userState.Status,
                Notes = _userState.Notes
            };

            var response = await Http.PostAsJsonAsync($"api/listings/{Id}/state", request);
            if (response.IsSuccessStatusCode)
            {
                var updated = await response.Content.ReadFromJsonAsync<ListingUserStateDto>();
                if (updated is not null)
                {
                    _userState = updated;
                }
                Snackbar.Add("Stav ulo≈æen", Severity.Success);
            }
            else
            {
                Snackbar.Add("Chyba p≈ôi ukl√°d√°n√≠ stavu", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Chyba: {ex.Message}", Severity.Error);
        }
    }

    private async Task SaveNotesAsync()
    {
        try
        {
            _userState.LastUpdated = DateTime.Now;

            var request = new ListingUserStateUpdateDto
            {
                Status = _userState.Status,
                Notes = _userState.Notes
            };

            var response = await Http.PostAsJsonAsync($"api/listings/{Id}/state", request);
            if (response.IsSuccessStatusCode)
            {
                var updated = await response.Content.ReadFromJsonAsync<ListingUserStateDto>();
                if (updated is not null)
                {
                    _userState = updated;
                }
                Snackbar.Add("Pozn√°mky ulo≈æeny", Severity.Success);
            }
            else
            {
                Snackbar.Add("Chyba p≈ôi ukl√°d√°n√≠ pozn√°mek", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Chyba: {ex.Message}", Severity.Error);
        }
    }

    private async Task CreateAnalysisAsync()
    {
        try
        {
            var request = new AnalysisJobCreateDto
            {
                StorageProvider = "Local"
            };

            var response = await Http.PostAsJsonAsync($"api/analysis/listing/{Id}", request);
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Anal√Ωza byla vytvo≈ôena", Severity.Success);
            }
            else
            {
                Snackbar.Add("Chyba p≈ôi vytv√°≈ôen√≠ anal√Ωzy", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Chyba: {ex.Message}", Severity.Error);
        }
    }

    private async Task CopyAiBriefAsync()
    {
        _aiBriefLoading = true;
        StateHasChanged();
        try
        {
            var response = await Http.GetAsync($"api/listings/{Id}/ai-brief", _cts.Token);
            if (response.IsSuccessStatusCode)
            {
                var text = await response.Content.ReadAsStringAsync(_cts.Token);
                await JS.InvokeVoidAsync("navigator.clipboard.writeText", text);
                Snackbar.Add("‚úÖ Zkop√≠rov√°no! Vlo≈æ p≈ô√≠mo do Clauda nebo Perplexity.", Severity.Success);
            }
            else
            {
                Snackbar.Add($"Chyba p≈ôi naƒç√≠t√°n√≠ AI briefinku: {response.StatusCode}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Chyba: {ex.Message}", Severity.Error);
        }
        finally
        {
            _aiBriefLoading = false;
        }
    }

    private async Task ExportToDriveAsync()
    {
        _driveExporting = true;
        _driveResult = null;
        StateHasChanged();
        try
        {
            var response = await Http.PostAsync($"api/listings/{Id}/export-drive", null, _cts.Token);
            if (response.IsSuccessStatusCode)
            {
                _driveResult = await response.Content.ReadFromJsonAsync<DriveExportResult>(_cts.Token);
                Snackbar.Add("Export na Google Drive byl √∫spƒõ≈°n√Ω!", Severity.Success);
                await LoadDriveAnalysisFilesAsync();
            }
            else
            {
                var err = await response.Content.ReadAsStringAsync(_cts.Token);
                Snackbar.Add($"Chyba p≈ôi exportu: {response.StatusCode}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Chyba: {ex.Message}", Severity.Error);
        }
        finally
        {
            _driveExporting = false;
        }
    }

    private async Task CopyDriveUrlAsync()
    {
        if (_driveResult is null) return;
        try
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", _driveResult.FolderUrl);
            Snackbar.Add("URL zkop√≠rov√°no do schr√°nky", Severity.Info);
        }
        catch
        {
            Snackbar.Add(_driveResult.FolderUrl, Severity.Normal);
        }
    }

    private async Task ExportToOneDriveAsync()
    {
        _oneDriveExporting = true;
        _oneDriveResult = null;
        StateHasChanged();
        try
        {
            var response = await Http.PostAsync($"api/listings/{Id}/export-onedrive", null, _cts.Token);
            if (response.IsSuccessStatusCode)
            {
                _oneDriveResult = await response.Content.ReadFromJsonAsync<DriveExportResult>(_cts.Token);
                Snackbar.Add("Export na OneDrive byl √∫spƒõ≈°n√Ω!", Severity.Success);
            }
            else
            {
                Snackbar.Add($"Chyba p≈ôi exportu na OneDrive: {response.StatusCode}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Chyba: {ex.Message}", Severity.Error);
        }
        finally
        {
            _oneDriveExporting = false;
        }
    }

    private async Task CopyOneDriveUrlAsync()
    {
        if (_oneDriveResult is null) return;
        try
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", _oneDriveResult.FolderUrl);
            Snackbar.Add("URL zkop√≠rov√°no do schr√°nky", Severity.Info);
        }
        catch
        {
            Snackbar.Add(_oneDriveResult.FolderUrl, Severity.Normal);
        }
    }

    private async Task SaveAnalysisToOneDriveAsync()
    {
        if (_oneDriveResult is null || string.IsNullOrWhiteSpace(_analysisText)) return;
        _savingAnalysis = true;
        StateHasChanged();
        try
        {
            var content = new StringContent(_analysisText, System.Text.Encoding.UTF8, "text/plain");
            var response = await Http.PostAsync(
                $"api/listings/{Id}/save-analysis?folderId={Uri.EscapeDataString(_oneDriveResult.FolderId)}",
                content, _cts.Token);
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("‚úÖ Anal√Ωza ulo≈æena do OneDrive slo≈æky!", Severity.Success);
                _analysisText = string.Empty;
            }
            else
            {
                var err = await response.Content.ReadAsStringAsync(_cts.Token);
                Snackbar.Add($"Chyba p≈ôi ukl√°d√°n√≠: {response.StatusCode}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Chyba: {ex.Message}", Severity.Error);
        }
        finally
        {
            _savingAnalysis = false;
        }
    }

    private async Task UploadDriveInspectionPhotosAsync()
    {
        if (_driveInspectionFiles is not { Count: > 0 }) return;
        // Folder ID je v DB, nemus√≠me m√≠t _driveResult v session
        if (_exportState?.DriveInspectionFolderId is null && _driveResult?.InspectionFolderId is null)
        {
            Snackbar.Add("Nejprve exportujte inzer√°t na Google Drive.", Severity.Warning);
            return;
        }
        _uploadingDrivePhotos = true;
        StateHasChanged();
        try
        {
            // Naƒçti v≈°echny soubory do pamƒõti NEJDRIVE ne≈æ postavis MultipartFormDataContent
            // (IBrowserFile stream nelze ƒç√≠st v backgroundu, mus√≠ p≈ôe≈æ√≠t po dobu SendAsync)
            var readFiles = new List<(string Name, byte[] Data, string Ct)>();
            foreach (var file in _driveInspectionFiles)
            {
                try
                {
                    await using var stream = file.OpenReadStream(maxAllowedSize: 30 * 1024 * 1024, _cts.Token);
                    using var ms = new MemoryStream();
                    await stream.CopyToAsync(ms, _cts.Token);
                    var safeName = string.IsNullOrWhiteSpace(file.Name) ? $"foto_{readFiles.Count + 1}.jpg" : Path.GetFileName(file.Name);
                    var ct2 = string.IsNullOrWhiteSpace(file.ContentType) ? "image/jpeg" : file.ContentType;
                    readFiles.Add((safeName, ms.ToArray(), ct2));
                }
                catch (Exception ex)
                {
                    Snackbar.Add($"‚ö†Ô∏è Skipping {file.Name}: {ex.Message}", Severity.Warning);
                }
            }

            if (readFiles.Count == 0)
            {
                Snackbar.Add("Nepoda≈ôilo se naƒç√≠st ≈æ√°dn√Ω soubor.", Severity.Warning);
                return;
            }

            using var content = new MultipartFormDataContent();
            for (int i = 0; i < readFiles.Count; i++)
            {
                var (name, data, ct2) = readFiles[i];
                var fileContent = new ByteArrayContent(data);
                fileContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue(ct2);
                content.Add(fileContent, "files", $"prohlidka_{i + 1:D2}_{name}");
            }

            var url = $"api/listings/{Id}/upload-inspection-photos?provider=drive";
            var response = await Http.PostAsync(url, content, _cts.Token);
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add($"‚úÖ {readFiles.Count} fotek nahr√°no na Google Drive!", Severity.Success);
                _driveInspectionFiles = [];
            }
            else
            {
                var err = await response.Content.ReadAsStringAsync(_cts.Token);
                Snackbar.Add($"Chyba p≈ôi nahr√°v√°n√≠: {response.StatusCode}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Chyba: {ex.Message}", Severity.Error);
        }
        finally
        {
            _uploadingDrivePhotos = false;
        }
    }

    private async Task ScanDriveInspectionAsync()
    {
        _scanningDriveInspection = true;
        StateHasChanged();
        try
        {
            var response = await Http.PostAsync(
                $"api/listings/{Id}/scan-drive-inspection", null, _cts.Token);
            if (response.IsSuccessStatusCode) // 202 Accepted
            {
                Snackbar.Add("üîÑ Scan GD spu≈°tƒõn na pozad√≠. Fotky budou dostupn√© za 1‚Äì5 minut ‚Äî pak obnovte str√°nku.", Severity.Info, cfg => cfg.VisibleStateDuration = 8000);
            }
            else
            {
                var err = await response.Content.ReadAsStringAsync(_cts.Token);
                Snackbar.Add($"Chyba: {err}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Chyba: {ex.Message}", Severity.Error);
        }
        finally
        {
            _scanningDriveInspection = false;
        }
    }

    private record DriveScanResult(int Imported, int Skipped, int TotalInFolder, string Message);

    private async Task UploadOneDriveInspectionPhotosAsync()
    {
        if (_oneDriveInspectionFiles is not { Count: > 0 }) return;
        if (_exportState?.OneDriveInspectionFolderId is null && _oneDriveResult?.InspectionFolderId is null)
        {
            Snackbar.Add("Nejprve exportujte inzer√°t na OneDrive.", Severity.Warning);
            return;
        }
        _uploadingOneDrivePhotos = true;
        StateHasChanged();
        try
        {
            var readFiles = new List<(string Name, byte[] Data, string Ct)>();
            foreach (var file in _oneDriveInspectionFiles)
            {
                try
                {
                    await using var stream = file.OpenReadStream(maxAllowedSize: 30 * 1024 * 1024, _cts.Token);
                    using var ms = new MemoryStream();
                    await stream.CopyToAsync(ms, _cts.Token);
                    var safeName = string.IsNullOrWhiteSpace(file.Name) ? $"foto_{readFiles.Count + 1}.jpg" : Path.GetFileName(file.Name);
                    var ct2 = string.IsNullOrWhiteSpace(file.ContentType) ? "image/jpeg" : file.ContentType;
                    readFiles.Add((safeName, ms.ToArray(), ct2));
                }
                catch (Exception ex)
                {
                    Snackbar.Add($"‚ö†Ô∏è Skipping {file.Name}: {ex.Message}", Severity.Warning);
                }
            }

            if (readFiles.Count == 0)
            {
                Snackbar.Add("Nepoda≈ôilo se naƒç√≠st ≈æ√°dn√Ω soubor.", Severity.Warning);
                return;
            }

            using var content = new MultipartFormDataContent();
            for (int i = 0; i < readFiles.Count; i++)
            {
                var (name, data, ct2) = readFiles[i];
                var fileContent = new ByteArrayContent(data);
                fileContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue(ct2);
                content.Add(fileContent, "files", $"prohlidka_{i + 1:D2}_{name}");
            }

            var url = $"api/listings/{Id}/upload-inspection-photos?provider=onedrive";
            var response = await Http.PostAsync(url, content, _cts.Token);
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add($"‚úÖ {readFiles.Count} fotek nahr√°no na OneDrive!", Severity.Success);
                _oneDriveInspectionFiles = [];
            }
            else
            {
                Snackbar.Add($"Chyba p≈ôi nahr√°v√°n√≠: {response.StatusCode}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Chyba: {ex.Message}", Severity.Error);
        }
        finally
        {
            _uploadingOneDrivePhotos = false;
        }
    }


    private static string GetPropertyTypeLabel(string? value)
    {
        if (string.IsNullOrWhiteSpace(value))
        {
            return "-";
        }

        return PropertyTypeLabels.TryGetValue(value, out var label) ? label : value;
    }

    private static string GetOfferTypeLabel(string? value)
    {
        if (string.IsNullOrWhiteSpace(value))
        {
            return "-";
        }

        return OfferTypeLabels.TryGetValue(value, out var label) ? label : value;
    }

    public void Dispose()
    {
        _cts.Cancel();
        _cts.Dispose();
        _ocrDotNetRef?.Dispose();
        try { _ = JS.InvokeVoidAsync("knOcr.dispose"); } catch { /* ignore */ }
    }

    // ‚îÄ‚îÄ‚îÄ RAG Chat ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    private record RagAnalysisInfo(Guid Id, string Source, bool HasEmbedding, string? Title);

    private async Task LoadRagAnalysesAsync()
    {
        try
        {
            var analyses = await Http.GetFromJsonAsync<List<RagAnalysisInfo>>(
                $"api/listings/{Id}/analyses", _cts.Token);
            if (analyses is not null)
            {
                _ragAnalysisCount = analyses.Count;
                _ragDescriptionEmbedded = analyses.Any(a => a.Source == "auto");
            }
        }
        catch { /* RAG status je optional */ }
    }

    private async Task EmbedDescriptionAsync()
    {
        _ragEmbedding = true;
        try
        {
            var resp = await Http.PostAsync($"api/listings/{Id}/embed-description", null, _cts.Token);
            if (resp.IsSuccessStatusCode)
            {
                _ragDescriptionEmbedded = true;
                _ragAnalysisCount++;
                Snackbar.Add("Popis inzer√°tu embedov√°n ‚Äì nyn√≠ se lze pt√°t!", Severity.Success);
            }
            else
            {
                var err = await resp.Content.ReadAsStringAsync();
                Snackbar.Add($"Embed selhal: {err}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Chyba: {ex.Message}", Severity.Error);
        }
        finally
        {
            _ragEmbedding = false;
        }
    }

    private async Task AskRagAsync()
    {
        if (string.IsNullOrWhiteSpace(_ragQuestion)) return;
        _ragLoading = true;
        _ragAnswer = null;
        _ragSources = [];
        try
        {
            var payload = new { question = _ragQuestion, topK = 5 };
            var resp = await Http.PostAsJsonAsync($"api/listings/{Id}/ask", payload, _cts.Token);
            if (resp.IsSuccessStatusCode)
            {
                var result = await resp.Content.ReadFromJsonAsync<RagAskResponse>(_cts.Token);
                if (result is not null)
                {
                    _ragAnswer = result.Answer;
                    _ragHasEmbeddings = result.HasEmbeddings;
                    _ragSources = result.Sources ?? [];
                }
            }
            else
            {
                _ragAnswer = $"Chyba API: {resp.StatusCode}";
                _ragHasEmbeddings = false;
            }
        }
        catch (Exception ex)
        {
            _ragAnswer = $"Chyba: {ex.Message}";
        }
        finally
        {
            _ragLoading = false;
        }
    }

}

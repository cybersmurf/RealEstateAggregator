@page "/scrape"
@using System.Threading

@inject HttpClient Http
@inject ISnackbar Snackbar
@implements IDisposable

<PageTitle>Scrapování – RealEstate</PageTitle>

<MudStack Spacing="4" Class="pa-4">

    <MudText Typo="Typo.h5" Class="fw-bold">
        <MudIcon Icon="@Icons.Material.Filled.Sync" Class="mb-1 mr-1" />
        Správa scrapování
    </MudText>

    <!-- Stats panel -->
    @if (_stats != null)
    {
        <MudPaper Elevation="1" Class="pa-4">
            <MudText Typo="Typo.h6" Class="mb-3">Stav databáze</MudText>
            <MudGrid>
                <MudItem xs="6" sm="3">
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Celkem inzerátů</MudText>
                    <MudText Typo="Typo.h6">@_stats.TotalListings</MudText>
                </MudItem>
                <MudItem xs="6" sm="3">
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Normalizováno</MudText>
                    <MudText Typo="Typo.h6">@_stats.WithNormalizedData <MudText Inline="true" Typo="Typo.caption" Color="Color.Secondary">(@NormPct %)</MudText></MudText>
                    <MudProgressLinear Value="@NormPct" Color="@PctColor(NormPct)" Rounded="true" Size="Size.Small" />
                </MudItem>
                <MudItem xs="6" sm="3">
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Smart-tagy</MudText>
                    <MudText Typo="Typo.h6">@_stats.WithSmartTags <MudText Inline="true" Typo="Typo.caption" Color="Color.Secondary">(@TagsPct %)</MudText></MudText>
                    <MudProgressLinear Value="@TagsPct" Color="@PctColor(TagsPct)" Rounded="true" Size="Size.Small" />
                </MudItem>
                <MudItem xs="6" sm="3">
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Cenový signál</MudText>
                    <MudText Typo="Typo.h6">@_stats.WithPriceSignal <MudText Inline="true" Typo="Typo.caption" Color="Color.Secondary">(@PricePct %)</MudText></MudText>
                    <MudProgressLinear Value="@PricePct" Color="@PctColor(PricePct)" Rounded="true" Size="Size.Small" />
                </MudItem>
            </MudGrid>
        </MudPaper>
    }

    <!-- Karta pro spuštění -->
    <MudPaper Elevation="2" Class="pa-4">
        <MudText Typo="Typo.h6" Class="mb-3">1. Stáhnout nové inzeráty</MudText>

        <!-- Výběr zdrojů -->
        <MudText Typo="Typo.body2" Class="mb-1">Zdroje (prázdné = všechny aktivní)</MudText>
        @if (_availableSources.Count > 0)
        {
            <MudChipSet T="string" @bind-SelectedValues="_selectedSourceCodes"
                        SelectionMode="SelectionMode.MultiSelection"
                        CheckMark="true"
                        Class="mb-3">
                @foreach (var src in _availableSources.Where(s => s.IsActive))
                {
                    <MudChip T="string" Value="@src.Code" Size="Size.Small" Variant="Variant.Outlined">
                        @src.Code
                    </MudChip>
                }
            </MudChipSet>
        }
        else if (_loadingSources)
        {
            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mb-3" />
        }

        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="4" Class="mb-3">
            <MudSwitch @bind-Value="_fullRescan" Color="Color.Warning">
                Plný rescan (ignoruj cache, přepiš vše)
            </MudSwitch>
            <MudSwitch @bind-Value="_autoRunAi" Color="Color.Success">
                Po stažení automaticky spustit AI analýzu
            </MudSwitch>
        </MudStack>

        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   StartIcon="@Icons.Material.Filled.PlayArrow"
                   Size="Size.Large"
                   Disabled="@(_scraping || _aiRunning)"
                   OnClick="TriggerScrapeAsync">
            @if (_scraping)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                <span>Stahuji…</span>
            }
            else
            {
                <span>Spustit scrapování</span>
            }
        </MudButton>
    </MudPaper>

    <!-- AI zpracování -->
    <MudPaper Elevation="2" Class="pa-4">
        <MudText Typo="Typo.h6" Class="mb-1">2. Spustit AI analýzu</MudText>
        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-3">
            Zpracuje nové inzeráty bez AI dat: normalizace textu, smart-tagy a cenový signál.
        </MudText>

        @if (_aiRunning)
        {
            <MudStack Spacing="1" Class="mb-3">
                <MudText Typo="Typo.body2">@_aiStatus</MudText>
                <MudProgressLinear Indeterminate="true" Color="Color.Success" Rounded="true" />
            </MudStack>
        }

        <MudButton Variant="Variant.Filled"
                   Color="Color.Success"
                   StartIcon="@Icons.Material.Filled.AutoAwesome"
                   Disabled="@(_aiRunning || _scraping)"
                   OnClick="RunAiJobsAsync">
            @if (_aiRunning)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                <span>Zpracovávám…</span>
            }
            else
            {
                <span>Spustit AI analýzu</span>
            }
        </MudButton>
    </MudPaper>

    <!-- Výsledek posledního scrape jobu -->
    @if (_lastResult != null)
    {
        <MudAlert Severity="@(_lastResult.Status == "Failed" ? Severity.Error : Severity.Success)"
                  Variant="Variant.Outlined">
            <strong>Scrapování:</strong> @_lastResult.Status
            @if (!string.IsNullOrWhiteSpace(_lastResult.Message))
            {
                <span> — @_lastResult.Message</span>
            }
        </MudAlert>
    }

    <!-- Přehled zdrojů -->
    <MudPaper Elevation="1" Class="pa-4">
        <MudText Typo="Typo.h6" Class="mb-3">Přehled zdrojů</MudText>
        @if (_loadingSources)
        {
            <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
        }
        else
        {
            <MudTable Items="_availableSources" Dense="true" Hover="true" Elevation="0">
                <HeaderContent>
                    <MudTh>Kód</MudTh>
                    <MudTh>Název</MudTh>
                    <MudTh>URL</MudTh>
                    <MudTh>Aktivní</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd><strong>@context.Code</strong></MudTd>
                    <MudTd>@context.Name</MudTd>
                    <MudTd>
                        <MudLink Href="@context.BaseUrl" Target="_blank" Typo="Typo.caption">@context.BaseUrl</MudLink>
                    </MudTd>
                    <MudTd>
                        <MudChip T="string" Size="Size.Small"
                                 Color="@(context.IsActive ? Color.Success : Color.Default)"
                                 Variant="Variant.Filled">
                            @(context.IsActive ? "Aktivní" : "Neaktivní")
                        </MudChip>
                    </MudTd>
                </RowTemplate>
            </MudTable>
        }
    </MudPaper>

</MudStack>

@code {
    private bool _scraping;
    private bool _aiRunning;
    private bool _loadingSources = true;
    private bool _fullRescan;
    private bool _autoRunAi = true;
    private string _aiStatus = "";
    private List<SourceDto> _availableSources = new();
    private IReadOnlyCollection<string> _selectedSourceCodes = new List<string>();
    private ScrapeTriggerResultDto? _lastResult;
    private OllamaStatsDto? _stats;
    private CancellationTokenSource _cts = new();

    private int NormPct => _stats?.TotalListings > 0 ? (int)(100.0 * _stats.WithNormalizedData / _stats.TotalListings) : 0;
    private int TagsPct => _stats?.TotalListings > 0 ? (int)(100.0 * _stats.WithSmartTags / _stats.TotalListings) : 0;
    private int PricePct => _stats?.TotalListings > 0 ? (int)(100.0 * _stats.WithPriceSignal / _stats.TotalListings) : 0;
    private Color PctColor(int pct) => pct >= 90 ? Color.Success : pct >= 70 ? Color.Warning : Color.Error;

    protected override async Task OnInitializedAsync()
    {
        await Task.WhenAll(LoadSourcesAsync(), LoadStatsAsync());
    }

    private async Task LoadSourcesAsync()
    {
        try
        {
            var sources = await Http.GetFromJsonAsync<List<SourceDto>>("api/sources", _cts.Token);
            _availableSources = sources ?? new();
        }
        catch (Exception ex) when (ex is not OperationCanceledException)
        {
            Snackbar.Add($"Nepodařilo se načíst zdroje: {ex.Message}", Severity.Warning);
        }
        finally
        {
            _loadingSources = false;
        }
    }

    private async Task LoadStatsAsync()
    {
        try
        {
            _stats = await Http.GetFromJsonAsync<OllamaStatsDto>("api/ollama/stats", _cts.Token);
        }
        catch { /* stats jsou optional */ }
    }

    private async Task TriggerScrapeAsync()
    {
        _scraping = true;
        _lastResult = null;
        try
        {
            var request = new
            {
                sourceCodes = _selectedSourceCodes.Count > 0 ? _selectedSourceCodes.ToList() : null,
                fullRescan = _fullRescan,
            };
            var response = await Http.PostAsJsonAsync("api/scraping/trigger", request, _cts.Token);
            response.EnsureSuccessStatusCode();
            _lastResult = await response.Content.ReadFromJsonAsync<ScrapeTriggerResultDto>(cancellationToken: _cts.Token);
            if (_lastResult?.Status == "Failed")
                Snackbar.Add($"Scrapování selhalo: {_lastResult.Message}", Severity.Error);
            else
            {
                Snackbar.Add("Scrapování bylo spuštěno – inzeráty se stahují na pozadí.", Severity.Success);
                if (_autoRunAi)
                {
                    // Počkáme chvíli aby scraper stihl pár inzerátů zpracovat
                    await Task.Delay(3000, _cts.Token);
                    await RunAiJobsAsync();
                }
            }
        }
        catch (Exception ex) when (ex is not OperationCanceledException)
        {
            Snackbar.Add($"Chyba: {ex.Message}", Severity.Error);
        }
        finally
        {
            _scraping = false;
        }
    }

    private async Task RunAiJobsAsync()
    {
        _aiRunning = true;
        try
        {
            // Normalize
            _aiStatus = "Normalizuji texty…";
            StateHasChanged();
            for (int i = 0; i < 40; i++)
            {
                var r = await Http.PostAsync($"api/ollama/bulk-normalize?batchSize=50", null, _cts.Token);
                if (!r.IsSuccessStatusCode) break;
                var dto = await r.Content.ReadFromJsonAsync<BulkJobResultDto>(cancellationToken: _cts.Token);
                if (dto?.RemainingUnprocessed == 0) break;
            }

            // Smart-tags
            _aiStatus = "Generuji smart-tagy…";
            StateHasChanged();
            for (int i = 0; i < 40; i++)
            {
                var r = await Http.PostAsync($"api/ollama/bulk-smart-tags?batchSize=50", null, _cts.Token);
                if (!r.IsSuccessStatusCode) break;
                var dto = await r.Content.ReadFromJsonAsync<BulkJobResultDto>(cancellationToken: _cts.Token);
                if (dto?.RemainingUnprocessed == 0) break;
            }

            // Price opinion
            _aiStatus = "Vyhodnocuji ceny…";
            StateHasChanged();
            for (int i = 0; i < 60; i++)
            {
                var r = await Http.PostAsync($"api/ollama/bulk-price-opinion?batchSize=30", null, _cts.Token);
                if (!r.IsSuccessStatusCode) break;
                var dto = await r.Content.ReadFromJsonAsync<BulkJobResultDto>(cancellationToken: _cts.Token);
                if (dto?.RemainingUnprocessed == 0) break;
            }

            Snackbar.Add("AI analýza dokončena!", Severity.Success);
            await LoadStatsAsync();
            StateHasChanged();
        }
        catch (Exception ex) when (ex is not OperationCanceledException)
        {
            Snackbar.Add($"AI analýza selhala: {ex.Message}", Severity.Error);
        }
        finally
        {
            _aiRunning = false;
            _aiStatus = "";
        }
    }

    public void Dispose() => _cts.Cancel();

    private record SourceDto(Guid Id, string Code, string Name, string BaseUrl, bool IsActive);
    private record ScrapeTriggerResultDto(Guid JobId, string Status, string? Message);
    private record OllamaStatsDto(int TotalListings, int WithNormalizedData, int WithSmartTags, int WithPriceSignal);
    private record BulkJobResultDto(int Processed, int Succeeded, int Failed, int RemainingUnprocessed);
}
